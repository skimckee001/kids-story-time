<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Story Time - Magical Personalized Stories</title>
    <!-- Force deployment refresh -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                margin-bottom: 20px;
            }

            .logo {
                font-size: 1.8rem;
            }

            .tagline {
                font-size: 1rem;
            }

            .main-content {
                padding: 20px;
                border-radius: 15px;
            }

            h2 {
                font-size: 1.5rem !important;
            }

            .form-group {
                margin-bottom: 15px;
            }

            input[type="text"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 12px !important;
            }

            .theme-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .theme-option {
                padding: 12px !important;
                font-size: 0.9rem !important;
            }

            .length-options {
                flex-direction: column;
                gap: 10px;
            }

            .length-option {
                width: 100%;
            }

            .generate-btn {
                width: 100%;
                padding: 15px !important;
                font-size: 1.1rem !important;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .nav-buttons button {
                width: 100%;
            }

            /* Modal adjustments for mobile */
            .onboarding-modal {
                width: 95% !important;
                padding: 20px !important;
            }

            .feature-grid {
                grid-template-columns: 1fr !important;
            }

            /* Tier cards on mobile */
            .tier-container {
                flex-direction: column;
            }

            .tier-card {
                width: 100%;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 1.5rem;
            }

            .tagline {
                font-size: 0.9rem;
            }

            .main-content {
                padding: 15px;
            }

            .theme-grid {
                grid-template-columns: 1fr !important;
            }

            .beta-banner {
                font-size: 0.9rem !important;
                padding: 10px !important;
            }
        }

        /* Touch-friendly adjustments */
        @media (hover: none) and (pointer: coarse) {
            button, .theme-option, .length-option {
                min-height: 44px; /* Apple's recommended touch target size */
            }

            .theme-option:active {
                transform: scale(0.98);
            }
        }

        .account-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
        }

        .account-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            font-family: Arial, sans-serif;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        select.form-control {
            background: white;
            cursor: pointer;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .theme-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .theme-card:hover, .theme-card.selected {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .theme-card .emoji {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .theme-card .title {
            font-weight: 600;
            color: #333;
        }

        .generate-section {
            text-align: center;
        }

        .generate-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .story-output {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }

        .story-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .story-content {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .auth-form {
            margin-top: 20px;
        }

        .auth-form h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-links {
            text-align: center;
            margin-top: 15px;
        }

        .auth-links a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .auth-links a:hover {
            text-decoration: underline;
        }

        .user-info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .limits-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .upgrade-prompt {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .footer {
            text-align: center;
            color: white;
            opacity: 0.8;
            margin-top: 40px;
        }

        .footer a {
            color: white;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                padding: 25px;
            }
            
            .account-buttons {
                flex-direction: column;
            }
            
            .themes-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .theme-card {
                padding: 15px;
            }
            
            .theme-card .emoji {
                font-size: 1.5rem;
            }
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        /* Onboarding Styles */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .onboarding-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .onboarding-step {
            display: none;
            text-align: center;
        }

        .onboarding-step.active {
            display: block;
        }

        .onboarding-step h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .onboarding-step p {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #666;
            margin-bottom: 30px;
        }

        .onboarding-image {
            width: 100%;
            max-width: 400px;
            height: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
        }

        .onboarding-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .onboarding-btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .onboarding-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .onboarding-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }

        .onboarding-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .onboarding-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
        }

        .dot.active {
            background: #667eea;
            width: 30px;
            border-radius: 5px;
        }

        .skip-onboarding {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #999;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .skip-onboarding:hover {
            color: #666;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .feature-item {
            padding: 15px;
            border-radius: 10px;
            background: #f8f9ff;
            text-align: left;
        }

        .feature-item .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .feature-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .feature-item p {
            font-size: 0.9rem;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay">
        <div class="onboarding-modal">
            <span class="skip-onboarding" onclick="skipOnboarding()">×</span>
            
            <!-- Step 1: Welcome -->
            <div class="onboarding-step active" data-step="1">
                <div class="onboarding-image">✨</div>
                <h2>Welcome to Kids Story Time!</h2>
                <p>Create magical, personalized stories for your children in seconds. Each story is uniquely crafted just for them!</p>
                <div class="onboarding-nav">
                    <button class="onboarding-btn secondary" onclick="skipOnboarding()">Skip Tour</button>
                    <button class="onboarding-btn primary" onclick="nextOnboardingStep()">Get Started</button>
                </div>
            </div>

            <!-- Step 2: How It Works -->
            <div class="onboarding-step" data-step="2">
                <div class="onboarding-image">📚</div>
                <h2>How It Works</h2>
                <div class="feature-grid">
                    <div class="feature-item">
                        <div class="icon">👶</div>
                        <h4>Enter Child's Name</h4>
                        <p>Personalize every story</p>
                    </div>
                    <div class="feature-item">
                        <div class="icon">🎨</div>
                        <h4>Choose Themes</h4>
                        <p>Adventure, friendship, & more</p>
                    </div>
                    <div class="feature-item">
                        <div class="icon">📖</div>
                        <h4>Select Reading Level</h4>
                        <p>Age-appropriate content</p>
                    </div>
                    <div class="feature-item">
                        <div class="icon">✨</div>
                        <h4>Generate Story</h4>
                        <p>AI creates unique tales</p>
                    </div>
                </div>
                <div class="onboarding-nav">
                    <button class="onboarding-btn secondary" onclick="prevOnboardingStep()">Back</button>
                    <button class="onboarding-btn primary" onclick="nextOnboardingStep()">Next</button>
                </div>
            </div>

            <!-- Step 3: Beta Features -->
            <div class="onboarding-step" data-step="3">
                <div class="onboarding-image">🎁</div>
                <h2>Special Beta Access!</h2>
                <p><strong>You're in the beta!</strong> Enjoy these premium features for FREE during our beta period:</p>
                <div class="feature-grid">
                    <div class="feature-item">
                        <div class="icon">🤖</div>
                        <h4>AI-Powered Stories</h4>
                        <p>Real AI generation</p>
                    </div>
                    <div class="feature-item">
                        <div class="icon">♾️</div>
                        <h4>Unlimited Stories</h4>
                        <p>No daily limits</p>
                    </div>
                    <div class="feature-item">
                        <div class="icon">🎯</div>
                        <h4>All Themes</h4>
                        <p>Access everything</p>
                    </div>
                    <div class="feature-item">
                        <div class="icon">🚫</div>
                        <h4>Ad-Free</h4>
                        <p>No interruptions</p>
                    </div>
                </div>
                <div class="onboarding-nav">
                    <button class="onboarding-btn secondary" onclick="prevOnboardingStep()">Back</button>
                    <button class="onboarding-btn primary" onclick="nextOnboardingStep()">Next</button>
                </div>
            </div>

            <!-- Step 4: Tips -->
            <div class="onboarding-step" data-step="4">
                <div class="onboarding-image">💡</div>
                <h2>Pro Tips</h2>
                <p>Get the most out of Kids Story Time:</p>
                <div style="text-align: left; max-width: 400px; margin: 0 auto;">
                    <p style="margin-bottom: 15px;">• <strong>Custom Prompts:</strong> Add specific details about your child's interests</p>
                    <p style="margin-bottom: 15px;">• <strong>Story Length:</strong> Start with short stories for bedtime</p>
                    <p style="margin-bottom: 15px;">• <strong>Save Favorites:</strong> Your stories are saved automatically</p>
                    <p style="margin-bottom: 15px;">• <strong>Share Feedback:</strong> Help us improve with the feedback button</p>
                </div>
                <div class="onboarding-nav">
                    <button class="onboarding-btn secondary" onclick="prevOnboardingStep()">Back</button>
                    <button class="onboarding-btn primary" onclick="finishOnboarding()">Start Creating!</button>
                </div>
            </div>

            <!-- Progress Dots -->
            <div class="onboarding-dots">
                <div class="dot active" data-dot="1"></div>
                <div class="dot" data-dot="2"></div>
                <div class="dot" data-dot="3"></div>
                <div class="dot" data-dot="4"></div>
            </div>
        </div>
    </div>

  <div class="container">
      <header class="header" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 20px 0; border-radius: 15px; margin-bottom: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B9D, #4ECDC4); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                      <span style="color: white; font-size: 20px; font-weight: bold;">📚</span>
                  </div>
                  <span style="font-size: 28px; font-weight: bold; background: linear-gradient(135deg, #FF6B9D, #4ECDC4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                      KidsStoryTime<span style="font-size: 0.6em; font-weight: normal; color: #666;">.org</span>
                  </span>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                  <!-- Star display will be inserted here by star-points-service.js -->
                  <div id="headerStarContainer" class="hidden">
                      <!-- Star display gets inserted here -->
                  </div>
                  <a href="story-library.html" style="background: linear-gradient(135deg, #FF6B9D, #4ECDC4); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                      📖 My Library
                  </a>
                  <button id="upgradeBtn" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px 24px; border-radius: 25px; border: 2px solid #28a745; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative;" title="Start your free trial">
                      🎉 Start Free Trial
                      <div id="upgradeTooltip" style="position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; background: #333; color: white; font-size: 14px; border-radius: 8px; padding: 8px 12px; opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap; z-index: 100;">
                          Free for first month! All premium features unlocked
                      </div>
                  </button>
              </div>
          </div>
          <div class="tagline" style="text-align: center; margin-top: 15px; color: #666; font-size: 18px;">Magical Personalized Stories for Your Child</div>
          <!-- Free Beta Banner -->
          <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; text-align: center; padding: 12px 20px; margin: 15px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
              <div style="font-weight: bold; font-size: 16px;">🎉 FREE BETA - All Premium Features Unlocked!</div>
              <div style="font-size: 14px; margin-top: 4px; opacity: 0.9;">Create unlimited stories, export to PDF, and enjoy all features completely free during our launch period</div>
          </div>
      </header>

      <main class="main-content">
          <!-- User Authentication Section -->
          <div id="authSection" class="account-section">
              <h2>Create Your Free Account</h2>
              <p>Join thousands of parents creating magical stories for their children!</p>
              <div class="account-buttons">
                  <button id="createAccountBtn" class="btn btn-primary">Create Free Account</button>
                  <button id="loginBtn" class="btn btn-secondary">Login</button>
              </div>
          </div>

          <!-- Logged In User Info -->
          <div id="userInfo" class="user-info" style="display: none;">
              <h3 id="welcomeMessage" style="text-align: center; margin-bottom: 20px;">Welcome back!</h3>
              <div id="limitsDisplay" class="limits-info">
                  <p id="planStatusText"><strong>Free Plan:</strong> <span id="storiesRemaining">1</span> story remaining today</p>
              </div>
              <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                  <a href="story-library.html" id="storyLibraryBtn" class="btn btn-primary" style="display: none;">
                      📚 My Story Library
                  </a>
                  <button id="logoutBtn" class="btn btn-secondary">Logout</button>
              </div>
          </div>

          <!-- Story Creation Form -->
          <div class="form-section">
              <div class="form-group">
                  <label for="childNameInput">Child's Name</label>
                  <div style="display: flex; gap: 15px; align-items: center;">
                      <input type="text" id="childNameInput" class="form-control" placeholder="Enter your child's name" style="flex: 1;">
                      <div style="display: flex; background: #f0f0f0; border-radius: 25px; padding: 3px;">
                          <button type="button" id="genderBoy" class="gender-btn" style="padding: 8px 16px; border: none; border-radius: 20px; background: transparent; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                              🧑 Boy
                          </button>
                          <button type="button" id="genderGirl" class="gender-btn" style="padding: 8px 16px; border: none; border-radius: 20px; background: transparent; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                              👩 Girl
                          </button>
                      </div>
                  </div>
                  <div style="margin-top: 10px;">
                      <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer; font-weight: normal;">
                          <input type="checkbox" id="includeNameToggle" style="margin-right: 8px;" checked>
                          <span>Include child's name as main character in story</span>
                      </label>
                  </div>
              </div>

              <!-- Story Prompt Section (moved to top) -->
              <div class="form-group">
                  <label for="customPrompt">What would you like this story to be about?
                  <button type="button" id="infoBtn" style="background: none; border: none; color: #007acc; font-size: 16px; margin-left: 5px; cursor: pointer;" title="Click for examples">ℹ️</button></label>
                  <div style="position: relative;">
                      <textarea id="customPrompt" class="form-control" rows="3" placeholder="Example: A brave princess who loves football and goes on an adventure with her pet dragon to save the enchanted forest..." style="font-size: 1rem;"></textarea>
                      <button type="button" id="micBtn" style="position: absolute; right: 10px; top: 10px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center;" title="Record your voice">
                          <span style="position: relative;">
                              🎤
                              <span style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 8px; letter-spacing: -0.5px;">REC</span>
                          </span>
                      </button>
                  </div>
              </div>

              <!-- Theme Selection -->
              <div class="form-group">
                  <label>Would you like to add a theme for this story?</label>
                  <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Pick one or more themes to make it extra special - Optional</p>
                  <div id="dynamicThemeContainer" class="interests-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                      <!-- Themes will be dynamically loaded here based on age -->
                  </div>
              </div>

              <!-- Reading Level and Story Length (moved to bottom) -->
              <div class="form-group">
                  <label for="childAge">Approximate Reading Level <span style="color: red;">*</span></label>
                  <select id="childAge" class="form-control" required>
                      <option value="">Select reading level</option>
                      <option value="pre-reader">Pre-Reader (ages 3–6)</option>
                      <option value="early-phonics">Early Phonics Reader (ages 4–7)</option>
                      <option value="beginning-reader">Beginning Reader (ages 5–8)</option>
                      <option value="developing-reader" selected>Developing Reader (ages 6–10)</option>
                      <option value="fluent-reader">Fluent Reader (ages 8–13)</option>
                      <option value="insightful-reader">Insightful Reader (ages 10–16+)</option>
                  </select>
              </div>

              <div class="form-group">
                  <label for="storyLength">Story Length <span style="color: red;">*</span></label>
                  <select id="storyLength" class="form-control" required>
                      <option value="">Select length</option>
                      <option value="short">Short (2-3 minutes)</option>
                      <option value="medium">Medium (5-7 minutes)</option>
                      <option value="long">Long (10-15 minutes)</option>
                      <option value="extended" selected>Extended (20 minutes)</option>
                      <option value="long-extended">Long Extended (30 minutes)</option>
                      <option value="extra-long">Extra Long (45 minutes)</option>
                  </select>
              </div>
          </div>


          <!-- Generate Button -->
          <div class="generate-section">
              <button id="generateBtn" class="generate-btn">Generate My Story! ✨</button>
          </div>

          <!-- Loading Animation -->
          <div id="loading" class="loading">
              <div class="spinner"></div>
              <p>Creating your magical story...</p>
          </div>


          <!-- Story Output -->
          <div id="storyOutput" class="story-output">
              <div class="story-title" id="storyTitle"></div>
              <div class="story-content" id="storyContent"></div>
          </div>
      </main>

      <!-- Quick Feedback Section -->
      <div class="text-center" style="margin-top: 40px; padding: 20px; background: rgba(255, 255, 255, 0.9); border-radius: 15px;">
          <h3 style="color: #333; margin-bottom: 10px;">Help us improve!</h3>
          <p style="color: #666; margin-bottom: 15px;">Share your thoughts on the beta version</p>
          <button id="quickFeedbackBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600;">
              💬 Quick Feedback
          </button>
      </div>

      <footer class="footer">
          <p>&copy; 2025 Kids Story Time. All rights reserved.</p>
          <p>
              <a href="terms.html" target="_blank">Terms of Service</a> | 
              <a href="privacy.html" target="_blank">Privacy Policy</a> | 
              <a href="mailto:support@kidsstorytime.org">Contact Us</a>
          </p>
      </footer>
  </div>

  <!-- Account Creation Modal -->
  <div id="accountModal" class="modal">
      <div class="modal-content">
          <span class="close" id="closeModal">&times;</span>
          <div class="auth-form">
              <h3>Create Your Free Account</h3>
              <div id="authAlert"></div>
              <form id="signupForm">
                  <div class="form-group">
                      <label for="signupEmail">Email Address</label>
                      <input type="email" id="signupEmail" class="form-control" required>
                  </div>
                  <div class="form-group">
                      <label for="signupPassword">Password</label>
                      <input type="password" id="signupPassword" class="form-control" required minlength="6">
                  </div>
                  <div class="form-group">
                      <label for="signupChildName">Child's Name</label>
                      <input type="text" id="signupChildName" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
              </form>
              <div class="auth-links">
                  <p>By creating an account, you agree to our <a href="terms.html" target="_blank">Terms of Service</a> and <a href="privacy.html" target="_blank">Privacy Policy</a></p>
                  <p><a href="#" id="switchToLogin">Already have an account? Login here</a></p>
              </div>
          </div>
      </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
      <div class="modal-content">
          <span class="close" id="closeLoginModal">&times;</span>
          <div class="auth-form">
              <h3>Login to Your Account</h3>
              <div id="loginAlert"></div>
              <form id="loginForm">
                  <div class="form-group">
                      <label for="loginEmail">Email Address</label>
                      <input type="email" id="loginEmail" class="form-control" required>
                  </div>
                  <div class="form-group">
                      <label for="loginPassword">Password</label>
                      <input type="password" id="loginPassword" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
              </form>
              <div class="auth-links">
                  <p><a href="#" id="switchToSignup">Don't have an account? Sign up here</a></p>
                  <p><a href="#" id="forgotPassword">Forgot your password?</a></p>
              </div>
              
              <!-- Quick Test Login for Development -->
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                  <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 10px;">🧪 Quick Test Login (Development)</p>
                  <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                      <button type="button" onclick="quickTestLogin('free')" style="background: #6b7280; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-size: 12px; cursor: pointer;">Test Free User</button>
                      <button type="button" onclick="quickTestLogin('premium')" style="background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-size: 12px; cursor: pointer;">Test Premium</button>
                      <button type="button" onclick="quickTestLogin('family')" style="background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 8px; font-size: 12px; cursor: pointer;">Test Family</button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Tier Selection Modal -->
  <div id="tierSelectionModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
          <span class="close" id="closeTierModal">&times;</span>
          <div style="text-align: center; margin-bottom: 30px;">
              <h2 style="color: #333; margin-bottom: 10px;">🎉 Choose Your Plan</h2>
              <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px 20px; border-radius: 12px; margin: 15px 0; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                  <div style="font-weight: bold; font-size: 16px;">✨ ALL FEATURES FREE DURING BETA!</div>
                  <div style="font-size: 14px; margin-top: 4px; opacity: 0.9;">Select your plan preference - no payment required</div>
              </div>
          </div>
          
          <div style="display: grid; gap: 20px; margin-bottom: 30px;">
              <!-- Free Tier -->
              <div class="tier-card" data-tier="free" style="border: 2px solid #e2e8f0; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s ease; background: #f8fafc;">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                      <h3 style="color: #64748b; margin: 0; font-size: 18px;">Free Forever</h3>
                      <div style="background: #64748b; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">£0/month</div>
                  </div>
                  <ul style="margin: 15px 0; padding-left: 20px; color: #475569; line-height: 1.6;">
                      <li>5 stories per month</li>
                      <li>Basic themes and stories</li>
                      <li>Standard story lengths</li>
                      <li>Banner ads displayed</li>
                      <li>1 child profile</li>
                  </ul>
                  <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 12px; color: #64748b; text-align: center; margin-top: 15px;">
                      Perfect for trying out the app!
                  </div>
              </div>

              <!-- Premium Tier -->
              <div class="tier-card" data-tier="premium" style="border: 2px solid #3b82f6; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #dbeafe, #eff6ff); position: relative;">
                  <div style="position: absolute; top: -10px; right: 20px; background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">POPULAR</div>
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                      <h3 style="color: #3b82f6; margin: 0; font-size: 18px;">Premium</h3>
                      <div style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">£9.99/month</div>
                  </div>
                  <ul style="margin: 15px 0; padding-left: 20px; color: #1e40af; line-height: 1.6;">
                      <li><strong>Unlimited stories</strong></li>
                      <li>AI voice narration</li>
                      <li>Story history and library</li>
                      <li>Advanced themes and customization</li>
                      <li>Export stories (PDF, audio)</li>
                      <li>All story lengths</li>
                      <li><strong>Ad-free experience</strong></li>
                      <li>Priority support</li>
                  </ul>
                  <div style="background: #dbeafe; padding: 10px; border-radius: 8px; font-size: 12px; color: #1e40af; text-align: center; margin-top: 15px;">
                      <strong>Best for families who love stories!</strong>
                  </div>
              </div>

              <!-- Family Tier -->
              <div class="tier-card" data-tier="family" style="border: 2px solid #10b981; border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #d1fae5, #ecfdf5);">
                  <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                      <h3 style="color: #10b981; margin: 0; font-size: 18px;">Family</h3>
                      <div style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">£19.99/month</div>
                  </div>
                  <ul style="margin: 15px 0; padding-left: 20px; color: #047857; line-height: 1.6;">
                      <li><strong>Everything in Premium</strong></li>
                      <li>Up to 6 child profiles</li>
                      <li>AI-generated illustrations</li>
                      <li>Enhanced voice narration</li>
                      <li>Family sharing features</li>
                      <li>Parental controls</li>
                      <li>Educational progress tracking</li>
                  </ul>
                  <div style="background: #d1fae5; padding: 10px; border-radius: 8px; font-size: 12px; color: #047857; text-align: center; margin-top: 15px;">
                      <strong>Perfect for large families!</strong>
                  </div>
              </div>
          </div>

          <div style="text-align: center;">
              <button id="selectTierBtn" class="btn btn-primary" style="padding: 15px 40px; font-size: 16px; font-weight: 600;" disabled>
                  🎉 Start Free Trial
              </button>
              <p style="margin-top: 15px; font-size: 14px; color: #666;">
                  <strong>No payment required during beta!</strong><br>
                  All features unlocked for everyone during launch period
              </p>
          </div>
      </div>
  </div>

  <!-- Include Supabase configuration and managers -->
  <script src="js/supabase-config.js"></script>
  <script src="js/auth-manager.js"></script>
  <script src="js/database-manager.js"></script>
  <script src="js/ai-story-service.js"></script>
  <script src="js/subscription-manager.js"></script>
  <script src="js/analytics-service.js"></script>
  <script src="js/ad-service.js"></script>
  <script src="js/star-points-service.js"></script>
  <script src="js/social-sharing-service.js"></script>
  <script src="js/dynamic-themes-config.js"></script>
  
  <script>
      // Global variables
      let selectedTheme = '';
      let selectedThemes = [];
      let selectedGender = '';
      let currentUser = null;

      // Utility function to get currency based on location
      function getCurrency() {
          const locale = navigator.language || 'en-US';
          return locale.startsWith('en-GB') ? '£' : '$';
      }

      // Show usage statistics for current user
      async function showUsageStats() {
          if (!window.authManager || !window.authManager.isUserAuthenticated()) return;
          
          const subscriptionType = await window.authManager.getSubscriptionStatus();
          console.log('Current subscription type:', subscriptionType);
          
          try {
              const limits = window.authManager.getUsageLimits(subscriptionType);
              
              // For test users, show mock usage stats
              const user = window.authManager.getCurrentUser();
              let dailyUsed = 0;
              let monthlyUsed = 0;
              
              if (!user.id.startsWith('test-')) {
                  // Real users - get actual stats
                  const monthlyResult = await window.dbManager.getUserUsageStats(user.id);
                  const dailyResult = await window.dbManager.getUserDailyUsageStats(user.id);
                  
                  if (monthlyResult.success && dailyResult.success) {
                      dailyUsed = dailyResult.data.length;
                      monthlyUsed = monthlyResult.data.length;
                  }
              } else {
                  // Test users - show demo usage based on tier
                  if (subscriptionType === 'free') {
                      dailyUsed = 3; // Show 3 used out of 5 for free
                      monthlyUsed = 12; // Show 12 used out of 20 for free
                  } else {
                      dailyUsed = 8; // Premium users have used some stories
                      monthlyUsed = 47;
                  }
              }
              
              const dailyRemaining = Math.max(0, limits.storiesPerDay - dailyUsed);
              const monthlyRemaining = Math.max(0, limits.storiesPerMonth - monthlyUsed);
              
              // Get tier display name and color
              const tierInfo = {
                  free: { name: 'Free Plan', color: '#6b7280' },
                  premium: { name: 'Premium Plan', color: '#f59e0b' },
                  family: { name: 'Family Plan', color: '#10b981' }
              };
              const currentTier = tierInfo[subscriptionType] || tierInfo.free;
              
              // Add usage indicator to the page
              const usageIndicator = document.createElement('div');
              usageIndicator.className = 'usage-indicator';
              
              if (limits.storiesPerDay >= 999) {
                  // Unlimited plan
                  usageIndicator.innerHTML = `
                      <div style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 15px; margin: 20px 0; text-align: center; border: 2px solid ${currentTier.color};">
                          <div style="font-size: 14px; color: ${currentTier.color}; font-weight: 600;">
                              ✨ ${currentTier.name}
                          </div>
                          <div style="margin: 8px 0; font-size: 13px; color: #059669; font-weight: bold;">
                              🚀 Unlimited Stories!
                          </div>
                          <div style="color: #6b7280; font-size: 12px;">
                              Generate as many stories as you'd like
                          </div>
                      </div>
                  `;
              } else {
                  // Limited plan
                  usageIndicator.innerHTML = `
                      <div style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 15px; margin: 20px 0; text-align: center; border: 2px solid ${currentTier.color};">
                          <div style="font-size: 14px; color: ${currentTier.color}; font-weight: 600;">
                              📊 ${currentTier.name}
                          </div>
                          <div style="margin: 8px 0; font-size: 13px; color: #6b7280;">
                              Today: ${dailyUsed}/${limits.storiesPerDay} stories • Month: ${monthlyUsed}/${limits.storiesPerMonth} stories
                          </div>
                          ${(dailyRemaining === 0 || monthlyRemaining === 0) ? 
                              '<div style="color: #dc2626; font-size: 12px; font-weight: 600;">Limit reached - Upgrade for unlimited stories!</div>' :
                              `<div style="color: #059669; font-size: 12px;">${dailyRemaining} stories remaining today</div>`
                          }
                      </div>
                  `;
              }
                      
              const mainContent = document.querySelector('.main-content');
              if (mainContent) {
                  mainContent.insertBefore(usageIndicator, mainContent.firstChild);
              }
          } catch (error) {
              console.error('Error loading usage stats:', error);
          }
      }

      // Simple Analytics System
      class AnalyticsTracker {
          static trackEvent(eventName, data = {}) {
              try {
                  const event = {
                      event: eventName,
                      timestamp: new Date().toISOString(),
                      url: window.location.href,
                      userAgent: navigator.userAgent,
                      ...data
                  };

                  console.log('Analytics Event:', event);

                  // Store in localStorage for demo purposes
                  const existingEvents = JSON.parse(localStorage.getItem('analytics_events') || '[]');
                  existingEvents.push(event);
                  
                  // Keep only last 100 events
                  if (existingEvents.length > 100) {
                      existingEvents.splice(0, existingEvents.length - 100);
                  }
                  
                  localStorage.setItem('analytics_events', JSON.stringify(existingEvents));
              } catch (error) {
                  console.error('Error tracking event:', error);
              }
          }

          static trackPageView() {
              this.trackEvent('page_view', {
                  page: 'story_creation',
                  referrer: document.referrer
              });
          }

          static trackStoryGeneration(params) {
              this.trackEvent('story_generation_started', {
                  themes: params.themes,
                  age_group: params.childAge,
                  story_length: params.storyLength,
                  has_custom_prompt: !!params.customPrompt,
                  includes_name: params.includeNameInStory
              });
          }

          static trackUserInteraction(action, details = {}) {
              this.trackEvent('user_interaction', {
                  action: action,
                  ...details
              });
          }
      }

      // Initialize the application
      document.addEventListener('DOMContentLoaded', async function() {
          console.log('Kids Story Time app initializing...');
          
          // Track page view
          AnalyticsTracker.trackPageView();
          
          // Wait for auth manager to be ready
          if (typeof window.authManager !== 'undefined') {
              // Check if user is already logged in
              currentUser = window.authManager.getCurrentUser();
              updateUI();
              
              // Show usage stats for authenticated users
              if (currentUser) {
                  await showUsageStats();
              }
          }

          // Theme selection is now handled dynamically in updateThemesBasedOnAge()
          // Old static theme handlers removed - see updateThemesBasedOnAge function

          // Gender selection
          document.getElementById('genderBoy').addEventListener('click', function() {
              document.getElementById('genderGirl').style.backgroundColor = 'transparent';
              document.getElementById('genderGirl').style.color = '#666';
              this.style.backgroundColor = '#667eea';
              this.style.color = 'white';
              selectedGender = 'boy';
              saveUserPreferences();
          });

          document.getElementById('genderGirl').addEventListener('click', function() {
              document.getElementById('genderBoy').style.backgroundColor = 'transparent';
              document.getElementById('genderBoy').style.color = '#666';
              this.style.backgroundColor = '#FF6B9D';
              this.style.color = 'white';
              selectedGender = 'girl';
              saveUserPreferences();
          });

          // Save preferences when reading level or story length changes
          document.getElementById('childAge').addEventListener('change', function() {
              saveUserPreferences();
              updateThemesBasedOnAge(); // Update themes when age changes
          });
          document.getElementById('storyLength').addEventListener('change', saveUserPreferences);
          document.getElementById('includeNameToggle').addEventListener('change', saveUserPreferences);

          // Generate button click
          document.getElementById('generateBtn').addEventListener('click', () => {
              AnalyticsTracker.trackUserInteraction('generate_button_clicked');
              generateStory();
          });

          // Microphone button functionality
          const micBtn = document.getElementById('micBtn');
          if (micBtn) {
              micBtn.addEventListener('click', function() {
                  console.log('Microphone button clicked');
                  AnalyticsTracker.trackUserInteraction('microphone_used');
                  
                  // Check for speech recognition support
                  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                      const recognition = new SpeechRecognition();
                      
                      recognition.continuous = false;
                      recognition.interimResults = false;
                      recognition.lang = 'en-US';
                      
                      // Store button reference for use in callbacks
                      const button = this;
                      
                      // Change button appearance during recording
                      button.innerHTML = '⏹️';
                      button.style.backgroundColor = '#ef4444';
                      button.title = 'Recording... Click to stop';
                      button.style.fontSize = '20px';
                      
                      recognition.onstart = function() {
                          console.log('Speech recognition started');
                      };
                      
                      recognition.onresult = function(event) {
                          console.log('Speech recognition result:', event);
                          const transcript = event.results[0][0].transcript;
                          const textarea = document.getElementById('customPrompt');
                          
                          // Check if we should append or replace
                          if (textarea.value) {
                              textarea.value += ' ' + transcript;
                          } else {
                              textarea.value = transcript;
                          }
                          console.log('Transcript added:', transcript);
                      };
                      
                      recognition.onerror = function(event) {
                          console.error('Speech recognition error:', event.error);
                          // Provide more specific error messages
                          let errorMessage = 'Speech recognition failed. ';
                          switch(event.error) {
                              case 'not-allowed':
                                  errorMessage += 'Please allow microphone access and try again.';
                                  break;
                              case 'no-speech':
                                  errorMessage += 'No speech was detected. Please try again.';
                                  break;
                              case 'network':
                                  errorMessage += 'Network error. Please check your connection.';
                                  break;
                              default:
                                  errorMessage += 'Please try typing instead.';
                          }
                          alert(errorMessage);
                          
                          // Reset button
                          button.innerHTML = `
                              <span style="position: relative;">
                                  🎤
                                  <span style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 8px; letter-spacing: -0.5px;">REC</span>
                              </span>
                          `;
                          button.style.backgroundColor = '#dc2626';
                          button.title = 'Record your voice';
                          button.style.fontSize = '11px';
                      };
                      
                      recognition.onend = function() {
                          console.log('Speech recognition ended');
                          // Reset button appearance
                          button.innerHTML = '🔴';
                          button.style.backgroundColor = '#dc2626';
                          button.title = 'Record your voice';
                      };
                      
                      try {
                          recognition.start();
                          console.log('Speech recognition started successfully');
                      } catch (error) {
                          console.error('Failed to start speech recognition:', error);
                          alert('Failed to start speech recognition. Please check your microphone permissions.');
                          // Reset button
                          button.innerHTML = `
                              <span style="position: relative;">
                                  🎤
                                  <span style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 8px; letter-spacing: -0.5px;">REC</span>
                              </span>
                          `;
                          button.style.backgroundColor = '#dc2626';
                          button.title = 'Record your voice';
                          button.style.fontSize = '11px';
                      }
                  } else {
                      alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
                  }
              });
          } else {
              console.error('Microphone button not found');
          }

          // Info button functionality
          document.getElementById('infoBtn').addEventListener('click', function() {
              const modal = document.createElement('div');
              modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';
              modal.innerHTML = `
                  <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                      <h3 style="margin-bottom: 20px; color: #333;">💡 Story Ideas & Examples</h3>
                      <div style="text-align: left;">
                          <h4 style="color: #667eea; margin-top: 20px;">Popular Story Ideas:</h4>
                          <ul style="margin-left: 20px; line-height: 1.8;">
                              <li>A brave princess who loves football and saves her kingdom</li>
                              <li>A dinosaur detective solving mysteries in the jungle</li>
                              <li>Twin astronauts discovering a planet made of candy</li>
                              <li>A superhero cat who can fly and loves ice cream</li>
                              <li>Friends building a magical treehouse that can travel anywhere</li>
                          </ul>
                          
                          <h4 style="color: #667eea; margin-top: 20px;">Make it Personal:</h4>
                          <ul style="margin-left: 20px; line-height: 1.8;">
                              <li>Include your child's name as the main character</li>
                              <li>Add their favorite toy, pet, or stuffed animal</li>
                              <li>Use places they know (their school, park, grandma's house)</li>
                              <li>Include their friends or siblings as characters</li>
                              <li>Add their current interests or hobbies</li>
                          </ul>
                          
                          <h4 style="color: #667eea; margin-top: 20px;">Learning Opportunities:</h4>
                          <ul style="margin-left: 20px; line-height: 1.8;">
                              <li>Stories about sharing, kindness, or being brave</li>
                              <li>Adventures that teach colors, numbers, or letters</li>
                              <li>Tales about different cultures or countries</li>
                              <li>Stories that help with bedtime fears or new experiences</li>
                          </ul>
                          
                          <p style="margin-top: 20px; text-align: center;"><strong>Press the microphone to let your child tell us what they would like the story to be about.</strong></p>
                      </div>
                      <button onclick="this.parentElement.parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-top: 20px; cursor: pointer;">Got it!</button>
                  </div>
              `;
              document.body.appendChild(modal);
              
              // Close on backdrop click
              modal.addEventListener('click', function(e) {
                  if (e.target === modal) {
                      document.body.removeChild(modal);
                  }
              });
          });

          // Modal controls
          document.getElementById('createAccountBtn').addEventListener('click', () => {
              document.getElementById('accountModal').style.display = 'block';
          });

          document.getElementById('loginBtn').addEventListener('click', () => {
              document.getElementById('loginModal').style.display = 'block';
          });

          document.getElementById('closeModal').addEventListener('click', () => {
              document.getElementById('accountModal').style.display = 'none';
          });

          document.getElementById('closeLoginModal').addEventListener('click', () => {
              document.getElementById('loginModal').style.display = 'none';
          });

          document.getElementById('switchToLogin').addEventListener('click', (e) => {
              e.preventDefault();
              document.getElementById('accountModal').style.display = 'none';
              document.getElementById('loginModal').style.display = 'block';
          });

          document.getElementById('switchToSignup').addEventListener('click', (e) => {
              e.preventDefault();
              document.getElementById('loginModal').style.display = 'none';
              document.getElementById('accountModal').style.display = 'block';
          });

          // Upgrade button functionality
          const upgradeBtn = document.getElementById('upgradeBtn');
          const upgradeTooltip = document.getElementById('upgradeTooltip');
          
          if (upgradeBtn && upgradeTooltip) {
              upgradeBtn.addEventListener('mouseenter', () => {
                  upgradeTooltip.style.opacity = '1';
              });
              
              upgradeBtn.addEventListener('mouseleave', () => {
                  upgradeTooltip.style.opacity = '0';
              });
              
              upgradeBtn.addEventListener('click', () => {
                  showTierSelectionModal();
              });
          }

          // Tier selection modal functionality
          setupTierSelectionModal();

          // Form submissions
          document.getElementById('signupForm').addEventListener('submit', handleSignup);
          document.getElementById('loginForm').addEventListener('submit', handleLogin);

          // Logout button
          document.getElementById('logoutBtn').addEventListener('click', handleLogout);

          // Quick feedback button
          document.getElementById('quickFeedbackBtn').addEventListener('click', () => {
              AnalyticsTracker.trackUserInteraction('quick_feedback_clicked');
              showQuickFeedbackModal();
          });

          // Close modals when clicking outside
          window.addEventListener('click', function(event) {
              const accountModal = document.getElementById('accountModal');
              const loginModal = document.getElementById('loginModal');
              if (event.target === accountModal) {
                  accountModal.style.display = 'none';
              }
              if (event.target === loginModal) {
                  loginModal.style.display = 'none';
              }
          });
      });

      // Authentication functions
      async function handleSignup(e) {
          e.preventDefault();
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          
          try {
              submitBtn.textContent = 'Creating Account...';
              submitBtn.disabled = true;

              const email = document.getElementById('signupEmail').value;
              const password = document.getElementById('signupPassword').value;
              const childName = document.getElementById('signupChildName').value;

              const result = await window.authManager.signUp(email, password, {
                  child_name: childName
              });

              if (result.error) {
                  showAlert('authAlert', result.error, 'error');
              } else {
                  const message = result.message || 'Account created successfully!';
                  showAlert('authAlert', message, 'success');
                  document.getElementById('signupForm').reset();
                  
                  // If user is immediately signed in, refresh the UI
                  if (result.data && result.data.session) {
                      setTimeout(() => {
                          updateUserInterface();
                          location.reload(); // Refresh to show authenticated state
                      }, 1500);
                  }
              }
          } catch (error) {
              showAlert('authAlert', 'An error occurred. Please try again.', 'error');
          } finally {
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
          }
      }

      async function handleLogin(e) {
          e.preventDefault();
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          
          try {
              submitBtn.textContent = 'Logging in...';
              submitBtn.disabled = true;

              const email = document.getElementById('loginEmail').value;
              const password = document.getElementById('loginPassword').value;

              const result = await window.authManager.signIn(email, password);

              if (result.error) {
                  showAlert('loginAlert', result.error, 'error');
              } else {
                  currentUser = result.data.user;
                  document.getElementById('loginModal').style.display = 'none';
                  updateUI();
                  showAlert('main', 'Welcome back! You\'re now logged in.', 'success');
              }
          } catch (error) {
              showAlert('loginAlert', 'An error occurred. Please try again.', 'error');
          } finally {
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
          }
      }

      async function handleLogout() {
          try {
              await window.authManager.signOut();
              currentUser = null;
              updateUI();
              showAlert('main', 'You\'ve been logged out successfully.', 'info');
          } catch (error) {
              console.error('Logout error:', error);
          }
      }

      // UI update functions
      function updateUI() {
          const authSection = document.getElementById('authSection');
          const userInfo = document.getElementById('userInfo');
          
          if (currentUser) {
              authSection.style.display = 'none';
              userInfo.style.display = 'block';
              
              // Update welcome message (will be personalized when profile loads)
              document.getElementById('welcomeMessage').textContent = 'Welcome back!';
              
              // Auto-populate child's name from user metadata or profile
              populateChildName();
              
              // Show story library button for premium users (for now, all logged-in users)
              document.getElementById('storyLibraryBtn').style.display = 'inline-block';
              
              // Load user profile and update UI
              loadUserProfile();
          } else {
              authSection.style.display = 'block';
              userInfo.style.display = 'none';
          }
      }

      async function loadUserProfile() {
          if (!window.dbManager || !currentUser) return;
          
          try {
              const profile = await window.dbManager.getUserProfile(currentUser.id);
              
              // Update welcome message with child's name if available
              const welcomeMsg = document.getElementById('welcomeMessage');
              
              // Check profile first, then user metadata (for test users)
              let childName = null;
              if (profile && profile.child_name) {
                  childName = profile.child_name;
              } else if (currentUser.user_metadata && currentUser.user_metadata.child_name) {
                  childName = currentUser.user_metadata.child_name;
              }
              
              if (childName) {
                  welcomeMsg.textContent = `Welcome back, ${childName}!`;
              } else {
                  welcomeMsg.textContent = 'Welcome back!';
              }
              
              // Load user preferences
              await loadUserPreferences(profile);
              
              // Check daily limits
              const canGenerate = await window.dbManager.canGenerateStory(currentUser.id);
              updateLimitsDisplay(canGenerate);
          } catch (error) {
              console.error('Error loading profile:', error);
          }
      }

      async function populateChildName() {
          if (!currentUser) return;
          
          try {
              // Check if child name should be populated from profile/metadata
              let childName = null;
              
              // For test users, get from metadata
              if (currentUser.id && currentUser.id.startsWith('test-') && currentUser.user_metadata && currentUser.user_metadata.child_name) {
                  childName = currentUser.user_metadata.child_name;
              } else if (window.dbManager) {
                  // For real users, get from profile
                  const profile = await window.dbManager.getUserProfile(currentUser.id);
                  if (profile && profile.child_name) {
                      childName = profile.child_name;
                  }
              }
              
              // Populate the child name field if we found a name
              if (childName) {
                  document.getElementById('childNameInput').value = childName;
              }
          } catch (error) {
              console.error('Error populating child name:', error);
          }
      }

      async function loadUserPreferences(profile = null) {
          try {
              // Load from localStorage first (most recent)
              const savedPrefs = localStorage.getItem('storyPreferences');
              if (savedPrefs) {
                  const prefs = JSON.parse(savedPrefs);
                  
                  // Set reading level if saved
                  if (prefs.readingLevel) {
                      document.getElementById('childAge').value = prefs.readingLevel;
                  }
                  
                  // Set story length if saved
                  if (prefs.storyLength) {
                      document.getElementById('storyLength').value = prefs.storyLength;
                  }
                  
                  // Set gender if saved
                  if (prefs.gender) {
                      setGenderSelection(prefs.gender);
                  }
                  
                  // Set include name toggle if saved
                  if (prefs.hasOwnProperty('includeNameInStory')) {
                      document.getElementById('includeNameToggle').checked = prefs.includeNameInStory;
                  }
                  
                  return; // Use localStorage preferences
              }
              
              // Fallback to profile preferences for real users
              if (profile && profile.preferences) {
                  if (profile.preferences.reading_level) {
                      document.getElementById('childAge').value = profile.preferences.reading_level;
                  }
                  if (profile.preferences.story_length) {
                      document.getElementById('storyLength').value = profile.preferences.story_length;
                  }
                  if (profile.preferences.gender) {
                      setGenderSelection(profile.preferences.gender);
                  }
                  if (profile.preferences.hasOwnProperty('includeNameInStory')) {
                      document.getElementById('includeNameToggle').checked = profile.preferences.includeNameInStory;
                  }
              }
          } catch (error) {
              console.error('Error loading user preferences:', error);
          }
      }

      function setGenderSelection(gender) {
          const boyBtn = document.getElementById('genderBoy');
          const girlBtn = document.getElementById('genderGirl');
          
          // Reset both buttons
          boyBtn.style.backgroundColor = 'transparent';
          boyBtn.style.color = '#666';
          girlBtn.style.backgroundColor = 'transparent';
          girlBtn.style.color = '#666';
          
          // Set the selected gender
          if (gender === 'boy') {
              boyBtn.style.backgroundColor = '#667eea';
              boyBtn.style.color = 'white';
              selectedGender = 'boy';
          } else if (gender === 'girl') {
              girlBtn.style.backgroundColor = '#FF6B9D';
              girlBtn.style.color = 'white';
              selectedGender = 'girl';
          }
      }

      function saveUserPreferences() {
          try {
              const prefs = {
                  readingLevel: document.getElementById('childAge').value,
                  storyLength: document.getElementById('storyLength').value,
                  gender: selectedGender,
                  includeNameInStory: document.getElementById('includeNameToggle').checked,
                  timestamp: Date.now()
              };
              localStorage.setItem('storyPreferences', JSON.stringify(prefs));
          } catch (error) {
              console.error('Error saving preferences:', error);
          }
      }

      async function updateLimitsDisplay(canGenerate) {
          const limitsDisplay = document.getElementById('limitsDisplay');
          const generateBtn = document.getElementById('generateBtn');
          
          if (window.authManager && window.authManager.isUserAuthenticated()) {
              const subscriptionType = await window.authManager.getSubscriptionStatus();
              const tierInfo = {
                  free: { name: 'Free Plan', color: '#6b7280' },
                  premium: { name: 'Premium Plan', color: '#f59e0b' },
                  family: { name: 'Family Plan', color: '#10b981' }
              };
              const currentTier = tierInfo[subscriptionType] || tierInfo.free;
              
              if (subscriptionType === 'premium' || subscriptionType === 'family') {
                  limitsDisplay.innerHTML = `<p><strong style="color: ${currentTier.color};">${currentTier.name}:</strong> ✨ Unlimited stories!</p>`;
                  generateBtn.disabled = false;
              } else if (canGenerate) {
                  limitsDisplay.innerHTML = `<p><strong style="color: ${currentTier.color};">${currentTier.name}:</strong> Stories remaining today</p>`;
                  generateBtn.disabled = false;
              } else {
                  limitsDisplay.innerHTML = `<p><strong style="color: ${currentTier.color};">${currentTier.name}:</strong> Daily limit reached. <a href="#upgrade">Upgrade to Premium</a> for unlimited stories!</p>`;
                  generateBtn.disabled = true;
              }
          } else {
              if (canGenerate) {
                  limitsDisplay.innerHTML = '<p><strong>Free Plan:</strong> 1 story remaining today</p>';
                  generateBtn.disabled = false;
              } else {
                  limitsDisplay.innerHTML = '<p><strong>Free Plan:</strong> Daily limit reached. <a href="#upgrade">Upgrade to Premium</a> for unlimited stories!</p>';
                  generateBtn.disabled = true;
              }
          }
      }

      // Story generation function
      async function generateStory() {
          const childName = document.getElementById('childNameInput').value || 'the hero';
          const childAge = document.getElementById('childAge').value;
          const storyLength = document.getElementById('storyLength').value;
          const customPrompt = document.getElementById('customPrompt').value;

          if (!childAge || !storyLength) {
              alert('Please select reading level and story length!');
              return;
          }

          // Save preferences when generating story
          saveUserPreferences();

          // Validate child name if provided (only letters and spaces)
          if (childName !== 'the hero' && !/^[a-zA-Z\s]+$/.test(childName)) {
              alert('Please enter a valid name (letters and spaces only).');
              return;
          }

          // Check subscription limits before generating story
          if (window.subscriptionManager) {
              try {
                  const limitCheck = await window.subscriptionManager.checkStoryGenerationLimits();
                  if (!limitCheck.canGenerate) {
                      return; // Modal already shown by subscription manager
                  }
              } catch (error) {
                  console.error('Error checking subscription limits:', error);
                  // Continue with generation on error for better user experience
              }
          }

          // Prepare story parameters
          const storyParams = {
              childName: childName.trim(),
              childAge: childAge,
              storyLength: storyLength,
              themes: selectedThemes, // Now supports multiple themes
              gender: selectedGender,
              customPrompt: document.getElementById('customPrompt')?.value || '',
              includeNameInStory: document.getElementById('includeNameToggle').checked
          };

          // Track story generation analytics
          AnalyticsTracker.trackStoryGeneration(storyParams);

          // Save to localStorage for the story page
          localStorage.setItem('pendingStory', JSON.stringify(storyParams));

          // Show loading state and redirect to story page
          document.getElementById('generateBtn').disabled = true;
          document.getElementById('generateBtn').innerHTML = '✨ Creating Magic...';
          
          // Small delay for UX, then redirect
          setTimeout(() => {
              window.location.href = 'story.html';
          }, 800);
      }


      // Mock story generation (replace with OpenAI API)
      async function generateStoryContent(childName, childAge, storyLength, theme) {
          // Simulate API delay
          await new Promise(resolve => setTimeout(resolve, 3000));
          
          const stories = {
              adventure: {
                  title: `${childName}'s Great Adventure`,
                  content: `Once upon a time, ${childName} discovered a magical map in their backyard. The map showed a path to a hidden treasure deep in the Enchanted Forest. With courage and determination, ${childName} set off on an amazing adventure. Along the way, they met friendly woodland creatures who helped them solve riddles and overcome challenges. After a day full of excitement and discovery, ${childName} found the treasure - a chest full of golden stars that granted one special wish. ${childName} wished for all children to have magical adventures of their own, and the stars scattered across the sky, making dreams come true everywhere. The end.`
              },
              animals: {
                  title: `${childName} and the Talking Animals`,
                  content: `In a magical forest, ${childName} discovered they could understand what animals were saying! First, they met Ruby the Red Squirrel, who was worried about finding enough acorns for winter. Then ${childName} helped Oliver the Owl solve a mystery about missing berries. Together with their new animal friends, ${childName} learned about friendship, kindness, and how every creature in the forest has an important role to play. By the end of the day, ${childName} had saved the forest and made friends that would last forever.`
              },
              space: {
                  title: `${childName}'s Space Adventure`,
                  content: `Captain ${childName} was the youngest astronaut ever to command a space mission! When alien friends from Planet Zoomba sent a distress signal, brave ${childName} jumped into their rocket ship and zoomed through the stars. On Planet Zoomba, ${childName} met colorful alien friends who needed help fixing their rainbow generator that made their planet beautiful. Using creativity and teamwork, ${childName} helped repair the machine, and the grateful aliens gave them a special star crystal that would always remind them that friendship knows no boundaries - not even in space!`
              },
              fantasy: {
                  title: `${childName} and the Magic Kingdom`,
                  content: `When ${childName} found a glowing key in their garden, it opened a door to a magical kingdom where dragons were friendly and unicorns needed help! The kind Dragon Queen asked ${childName} to help find her lost baby dragon who was hiding because he was afraid to breathe fire. With the help of wise unicorns and brave fairy friends, ${childName} found the little dragon and taught him that being different made him special. The grateful kingdom made ${childName} an honorary prince/princess, with a crown that sparkled with the magic of kindness.`
              },
              ocean: {
                  title: `${childName}'s Underwater Adventure`,
                  content: `When ${childName} put on magical swimming goggles at the beach, they could suddenly breathe underwater and talk to sea creatures! Dolphin friends invited ${childName} to visit the underwater city of Coral Castle, where the Seahorse King needed help finding his lost crown. Swimming through colorful coral reefs and playing with friendly fish, ${childName} discovered the crown had been borrowed by baby sea turtles who were using it as a playground. The kind Seahorse King was so happy that he let the turtles keep the crown and gave ${childName} a special seashell that would always bring them back to visit their ocean friends.`
              },
              friendship: {
                  title: `${childName} and the New Friend`,
                  content: `At the playground, ${childName} noticed a lonely child sitting by themselves. Even though they felt a little shy, brave ${childName} walked over and said hello. The new friend, Sam, had just moved to town and didn't know anyone. ${childName} showed Sam all the best parts of the playground and taught them their favorite games. Soon they were laughing and having the best time together! When it was time to go home, they promised to be best friends forever. ${childName} learned that sometimes the best adventures happen when you're kind to someone new.`
              },
              nature: {
                  title: `${childName} and the Secret Garden`,
                  content: `Behind ${childName}'s house was a forgotten garden where flowers could sing and trees could dance! When ${childName} discovered this magical place, they found that the garden was sad because no one had visited in years. With gentle care, ${childName} watered the singing flowers, helped the dancing trees stretch their branches, and planted new seeds with the help of chattering chipmunks. As the garden bloomed back to life, it rewarded ${childName} with the most beautiful butterfly garden anyone had ever seen, where every butterfly carried a wish that would come true.`
              },
              superhero: {
                  title: `Super ${childName} Saves the Day`,
                  content: `One morning, ${childName} woke up with amazing superpowers! They could fly, had super strength, and could make things better just by caring about them. When the town's ice cream truck broke down on the hottest day of summer, Super ${childName} flew into action! Using their powers of kindness and creativity, they helped fix the truck and even made the ice cream extra delicious. All the children in town cheered for Super ${childName}, who learned that the greatest superpower of all is helping others and making people happy.`
              }
          };

          const selectedStory = stories[theme] || stories.adventure;
          
          // Adjust story length based on selection
          let content = selectedStory.content;
          if (storyLength === 'short') {
              content = content.substring(0, content.length * 0.6) + ' The end.';
          } else if (storyLength === 'long') {
              content = content + ' ' + content.substring(content.length * 0.5);
          }

          return {
              title: selectedStory.title,
              content: content
          };
      }

      // Utility function to show alerts
      function showAlert(containerId, message, type) {
          const container = containerId === 'main' ? 
              document.querySelector('.main-content') : 
              document.getElementById(containerId);
          
          // Remove existing alerts
          const existingAlert = container.querySelector('.alert');
          if (existingAlert) {
              existingAlert.remove();
          }

          // Create new alert
          const alert = document.createElement('div');
          alert.className = `alert alert-${type}`;
          alert.textContent = message;
          
          if (containerId === 'main') {
              container.insertBefore(alert, container.firstChild);
          } else {
              container.insertBefore(alert, container.firstChild);
          }

          // Auto remove after 5 seconds
          setTimeout(() => {
              if (alert.parentNode) {
                  alert.remove();
              }
          }, 5000);
      }
      // Show upgrade modal with pricing tiers
      function showUpgradeModal() {
          console.log('showUpgradeModal called');
          console.log('window.subscriptionManager:', window.subscriptionManager);
          
          if (window.subscriptionManager && typeof window.subscriptionManager.showUpgradeModal === 'function') {
              console.log('Calling subscription manager modal');
              window.subscriptionManager.showUpgradeModal('Premium Features');
          } else {
              console.log('Subscription manager not ready, showing fallback modal');
              showFallbackUpgradeModal();
          }
      }

      // Fallback upgrade modal if subscription manager isn't loaded
      function showFallbackUpgradeModal() {
          const modal = document.createElement('div');
          modal.style.cssText = `
              position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
              background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
              align-items: center; justify-content: center; padding: 20px;
          `;
          
          modal.innerHTML = `
              <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; text-align: center;">
                  <h2 style="color: #333; margin-bottom: 20px;">🌟 Choose Your Plan</h2>
                  
                  <div style="margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 10px;">
                      <h3 style="color: #333;">Free (Forever) — £0</h3>
                      <p>• 3 text-only stories per day (max 10 per month)<br>• 1 child profile<br>• Perfect for trying it out!</p>
                  </div>
                  
                  <div style="margin: 20px 0; padding: 15px; border: 2px solid #9f7aea; border-radius: 10px; background: #f7fafc;">
                      <h3 style="color: #9f7aea;">Premium (Individual) — £4.99/mo</h3>
                      <p>• Story history (read favorites again)<br>• Unlimited text stories (up to 3000 words)<br>• 3 AI read-aloud stories<br>• Images with stories</p>
                  </div>
                  
                  <div style="margin: 20px 0; padding: 15px; border: 2px solid #3182ce; border-radius: 10px; background: #f7fafc;">
                      <h3 style="color: #3182ce;">Family — £9.99/mo</h3>
                      <p>• Everything in Premium<br>• AI generated images for each story<br>• 30 AI read-aloud stories<br>• Up to 6 child profiles</p>
                  </div>
                  
                  <button onclick="this.parentElement.parentElement.remove()" 
                          style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; margin-top: 20px;">
                      Close (Demo Mode)
                  </button>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // Close on backdrop click
          modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                  modal.remove();
              }
          });
      }

      // Quick feedback modal function
      function showQuickFeedbackModal() {
          const modal = document.createElement('div');
          modal.style.cssText = `
              position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
              background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
              align-items: center; justify-content: center; padding: 20px;
          `;
          
          modal.innerHTML = `
              <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center;">
                  <h2 style="color: #333; margin-bottom: 20px;">📝 Quick Feedback</h2>
                  <p style="margin-bottom: 20px; color: #666;">Help us improve KidsStoryTime.org during our beta!</p>
                  
                  <div style="margin: 20px 0;">
                      <p style="margin-bottom: 10px; font-weight: 600;">How is your experience so far?</p>
                      <div style="display: flex; gap: 10px; justify-content: center;">
                          <button onclick="submitQuickFeedback('poor')" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer;">😞 Poor</button>
                          <button onclick="submitQuickFeedback('good')" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer;">😊 Good</button>
                          <button onclick="submitQuickFeedback('excellent')" style="padding: 8px 16px; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer;">🤩 Excellent</button>
                      </div>
                  </div>
                  
                  <div style="margin: 20px 0;">
                      <textarea id="quickFeedbackText" placeholder="Any suggestions or comments? (optional)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; height: 80px; resize: none;"></textarea>
                  </div>
                  
                  <div style="display: flex; gap: 10px;">
                      <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                              style="flex: 1; padding: 10px; background: #f5f5f5; border: none; border-radius: 8px; cursor: pointer;">
                          Cancel
                      </button>
                      <button onclick="submitQuickFeedback('custom')" 
                              style="flex: 1; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer;">
                          Submit
                      </button>
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // Close on backdrop click
          modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                  modal.remove();
              }
          });
      }

      function submitQuickFeedback(rating) {
          const feedbackText = document.getElementById('quickFeedbackText')?.value || '';
          
          const feedbackData = {
              rating: rating,
              feedback_text: feedbackText,
              page: 'index',
              timestamp: new Date().toISOString()
          };
          
          // Track the feedback
          AnalyticsTracker.trackEvent('quick_feedback_submitted', feedbackData);
          
          // Show success message
          const modal = document.querySelector('div[style*="position: fixed"]');
          if (modal) {
              modal.innerHTML = `
                  <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; text-align: center;">
                      <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                      <h2 style="color: #333; margin-bottom: 15px;">Thank you!</h2>
                      <p style="color: #666; margin-bottom: 20px;">Your feedback helps us make KidsStoryTime.org better for everyone!</p>
                      <button onclick="this.parentElement.parentElement.remove()" 
                              style="padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer;">
                          Close
                      </button>
                  </div>
              `;
              
              // Auto-close after 3 seconds
              setTimeout(() => {
                  if (modal.parentNode) {
                      modal.remove();
                  }
              }, 3000);
          }
      }

      // Quick test login function for development
      function quickTestLogin(tier) {
          console.log(`Quick test login for ${tier} user`);
          
          // Create a mock user object based on tier
          const mockUser = {
              id: `test-${tier}-${Date.now()}`,
              email: `test-${tier}@example.com`,
              user_metadata: {
                  child_name: tier === 'family' ? 'Emma & Jake' : 'Emma',
                  subscription_type: tier,
                  display_name: `Test ${tier.charAt(0).toUpperCase() + tier.slice(1)} User`
              }
          };
          
          // Set the mock user in auth manager
          if (window.authManager) {
              window.authManager.user = mockUser;
              window.authManager.isAuthenticated = true;
              window.authManager.notifyAuthStateChange();
          }
          
          // Set currentUser for the main page
          currentUser = mockUser;
          
          // Close login modal and update UI
          document.getElementById('loginModal').style.display = 'none';
          showAlert('main', `Logged in as Test ${tier.charAt(0).toUpperCase() + tier.slice(1)} User! 🧪`, 'success');
          
          // Update the interface
          setTimeout(() => {
              updateUI();
          }, 500);
      }

      // Tier selection modal functions
      function showTierSelectionModal() {
          document.getElementById('tierSelectionModal').style.display = 'block';
      }

      function setupTierSelectionModal() {
          let selectedTier = null;

          // Close modal button
          document.getElementById('closeTierModal').addEventListener('click', () => {
              document.getElementById('tierSelectionModal').style.display = 'none';
          });

          // Tier card selection
          document.querySelectorAll('.tier-card').forEach(card => {
              card.addEventListener('click', function() {
                  // Remove selection from all cards
                  document.querySelectorAll('.tier-card').forEach(c => {
                      c.style.transform = 'scale(1)';
                      c.style.boxShadow = '';
                  });

                  // Add selection to clicked card
                  this.style.transform = 'scale(1.02)';
                  this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';

                  selectedTier = this.dataset.tier;
                  document.getElementById('selectTierBtn').disabled = false;
              });
          });

          // Select tier button
          document.getElementById('selectTierBtn').addEventListener('click', () => {
              if (selectedTier) {
                  // Save user's tier preference
                  localStorage.setItem('preferredTier', selectedTier);
                  
                  // Close modal
                  document.getElementById('tierSelectionModal').style.display = 'none';
                  
                  // Show success message
                  const tierNames = {
                      free: 'Free',
                      premium: 'Premium', 
                      family: 'Family'
                  };
                  
                  showAlert('main', `🎉 ${tierNames[selectedTier]} tier selected! All features are now unlocked during our free beta period. Enjoy creating unlimited magical stories!`, 'success');
                  
                  // Update UI if needed
                  if (currentUser) {
                      updateUI();
                  }
              }
          });

          // Close modal when clicking outside
          document.getElementById('tierSelectionModal').addEventListener('click', function(event) {
              if (event.target === this) {
                  this.style.display = 'none';
              }
          });
      }

      // Onboarding Functions
      let currentOnboardingStep = 1;
      const totalSteps = 4;

      function showOnboarding() {
          const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
          if (!hasSeenOnboarding) {
              document.getElementById('onboardingOverlay').style.display = 'flex';
          }
      }

      function skipOnboarding() {
          document.getElementById('onboardingOverlay').style.display = 'none';
          localStorage.setItem('hasSeenOnboarding', 'true');
      }

      function finishOnboarding() {
          skipOnboarding();
          // Focus on the name input to encourage starting
          const nameInput = document.getElementById('childName');
          if (nameInput) {
              nameInput.focus();
          }
      }

      function nextOnboardingStep() {
          if (currentOnboardingStep < totalSteps) {
              // Hide current step
              document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`).classList.remove('active');
              document.querySelector(`.dot[data-dot="${currentOnboardingStep}"]`).classList.remove('active');
              
              // Show next step
              currentOnboardingStep++;
              document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`).classList.add('active');
              document.querySelector(`.dot[data-dot="${currentOnboardingStep}"]`).classList.add('active');
          }
      }

      function prevOnboardingStep() {
          if (currentOnboardingStep > 1) {
              // Hide current step
              document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`).classList.remove('active');
              document.querySelector(`.dot[data-dot="${currentOnboardingStep}"]`).classList.remove('active');
              
              // Show previous step
              currentOnboardingStep--;
              document.querySelector(`.onboarding-step[data-step="${currentOnboardingStep}"]`).classList.add('active');
              document.querySelector(`.dot[data-dot="${currentOnboardingStep}"]`).classList.add('active');
          }
      }

      // Function to update themes based on selected age
      function updateThemesBasedOnAge() {
          const ageSelect = document.getElementById('childAge');
          const selectedLevel = ageSelect.value;
          const container = document.getElementById('dynamicThemeContainer');
          
          if (!window.DynamicThemes) {
              console.log('Dynamic themes not loaded yet');
              setTimeout(updateThemesBasedOnAge, 100); // Retry after a short delay
              return;
          }
          
          // Map reading levels to ages
          let ageGroup;
          switch(selectedLevel) {
              case 'pre-reader':
                  ageGroup = 4; // 3-6 years
                  break;
              case 'early-phonics':
                  ageGroup = 5; // 4-7 years
                  break;
              case 'beginning-reader':
                  ageGroup = 7; // 5-8 years
                  break;
              case 'developing-reader':
                  ageGroup = 8; // 6-10 years
                  break;
              case 'fluent-reader':
                  ageGroup = 11; // 8-13 years
                  break;
              default:
                  ageGroup = 7; // Default to middle range
          }
          
          // Get appropriate themes for this age
          const themeConfig = window.DynamicThemes.getThemesForAge(ageGroup);
          
          // Clear existing themes and reset selectedThemes array
          container.innerHTML = '';
          selectedThemes = []; // Reset the selected themes when age changes
          
          // Add dynamic themes
          if (themeConfig && themeConfig.themes) {
              themeConfig.themes.forEach(theme => {
                  const themeElement = document.createElement('label');
                  themeElement.className = 'interest-item theme-option';
                  themeElement.style.cssText = 'display: flex; align-items: center; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; transition: all 0.2s;';
                  
                  themeElement.innerHTML = `
                      <input type="checkbox" class="story-theme" value="${theme.id}" style="display: none;">
                      <span class="checkmark" style="margin-right: 8px; font-size: 18px;">${theme.label.split(' ')[0]}</span>
                      <span style="font-size: 14px;">${theme.label.substring(theme.label.indexOf(' ') + 1)}</span>
                  `;
                  
                  // Add hover effect for description
                  themeElement.title = theme.description;
                  
                  // Add click handler
                  themeElement.addEventListener('click', function(e) {
                      e.preventDefault();
                      const checkbox = this.querySelector('input[type="checkbox"]');
                      checkbox.checked = !checkbox.checked;
                      
                      if (checkbox.checked) {
                          // Add to selected themes
                          if (!selectedThemes.includes(checkbox.value)) {
                              selectedThemes.push(checkbox.value);
                          }
                          this.style.borderColor = '#667eea';
                          this.style.backgroundColor = '#f0f4ff';
                          this.style.transform = 'scale(1.05)';
                      } else {
                          // Remove from selected themes
                          selectedThemes = selectedThemes.filter(theme => theme !== checkbox.value);
                          this.style.borderColor = '#e0e0e0';
                          this.style.backgroundColor = 'transparent';
                          this.style.transform = 'scale(1)';
                      }
                  });
                  
                  // Hover effects
                  themeElement.addEventListener('mouseenter', function() {
                      if (!this.querySelector('input[type="checkbox"]').checked) {
                          this.style.borderColor = '#9ca3af';
                      }
                  });
                  
                  themeElement.addEventListener('mouseleave', function() {
                      if (!this.querySelector('input[type="checkbox"]').checked) {
                          this.style.borderColor = '#e0e0e0';
                      }
                  });
                  
                  container.appendChild(themeElement);
              });
          }
          
          // Add a note about age-appropriate themes
          const noteElement = document.createElement('p');
          noteElement.style.cssText = 'grid-column: 1 / -1; font-size: 12px; color: #888; text-align: center; margin-top: 10px;';
          noteElement.textContent = `✨ Themes selected for ${selectedLevel.replace(/-/g, ' ')} level`;
          container.appendChild(noteElement);
      }

      // Show onboarding on page load for new users
      window.addEventListener('DOMContentLoaded', () => {
          setTimeout(showOnboarding, 500); // Small delay for better UX
          updateThemesBasedOnAge(); // Load initial themes based on default selection
      });

  </script>
</body>
</html>