<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Magic Story - Kids Story Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B9D',
                        secondary: '#4ECDC4',
                        accent: '#FFE66D'
                    }
                }
            }
        }
    </script>
    <style>
        .story-text {
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.8;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 2s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .sparkle {
            position: relative;
            overflow: hidden;
        }
        
        .sparkle::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 157, 0.3), transparent);
            border-radius: inherit;
            animation: sparkle 3s linear infinite;
            z-index: -1;
        }
        
        @keyframes sparkle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 32px;
            color: transparent;
            text-shadow: 0 0 0 #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .star.active {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .star:hover,
        .star.hover {
            color: #FFD700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-200">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üìö</span>
                    </div>
                    <span class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        Kids Story Time
                    </span>
                </div>
                <a href="index.html" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                    ‚Üê Create New Story
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="sparkle w-24 h-24 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mb-8 flex items-center justify-center">
                <span class="text-white text-4xl animate-bounce">‚ú®</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Creating Your Magic Story</h2>
            <p class="text-xl text-gray-600 mb-6">
                <span class="loading-dots">Our storytelling wizard is crafting something special just for you</span>
            </p>
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 max-w-md mx-auto">
                <div class="flex items-center space-x-4">
                    <div class="w-4 h-4 bg-primary rounded-full animate-pulse"></div>
                    <div class="w-4 h-4 bg-secondary rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-4 h-4 bg-accent rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- Story Display -->
        <div id="storyDisplay" class="hidden">
            <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl overflow-hidden fade-in">
                <!-- Story Header -->
                <div class="bg-gradient-to-r from-primary via-secondary to-accent p-8 text-white relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
                    <div class="relative z-10">
                        <h1 id="storyTitle" class="text-4xl md:text-5xl font-bold mb-4 text-center">
                            <!-- Story title will be inserted here -->
                        </h1>
                        <div id="storyMeta" class="text-center space-y-2 opacity-90">
                            <!-- Story metadata will be inserted here -->
                        </div>
                    </div>
                    <div class="absolute top-4 right-4">
                        <span class="text-6xl opacity-30">üåü</span>
                    </div>
                    <div class="absolute bottom-4 left-4">
                        <span class="text-4xl opacity-30">üìñ</span>
                    </div>
                </div>

                <!-- Voice Narration Controls -->
                <div id="voiceControls" class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b border-purple-100">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <button id="playNarration" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:shadow-lg transition-all flex items-center gap-2">
                                <svg id="playIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <svg id="pauseIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span id="playText">Read Aloud</span>
                            </button>
                            <button id="stopNarration" class="bg-gray-500 text-white px-4 py-2 rounded-full hover:bg-gray-600 transition-all hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6v4H9z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <!-- Voice Selection -->
                            <select id="voiceSelect" class="px-3 py-1 border border-purple-300 rounded-lg text-sm focus:outline-none focus:border-purple-500">
                                <option>Loading voices...</option>
                            </select>
                            
                            <!-- Speed Control -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">Speed:</label>
                                <div class="flex gap-1">
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100" data-speed="0.7">0.7x</button>
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100 bg-purple-100 border-purple-400" data-speed="0.9">0.9x</button>
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100" data-speed="1.0">1.0x</button>
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100" data-speed="1.2">1.2x</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="narrationProgress" class="mt-3 hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Story Content -->
                <div class="p-8 md:p-12">
                    <div id="storyContent" class="story-text text-lg md:text-xl text-gray-700 space-y-6 leading-relaxed">
                        <!-- Story content will be inserted here -->
                    </div>

                    <!-- Story Rating Section (Premium) -->
                    <div id="storyRatingSection" class="hidden mt-8 pt-6 border-t border-gray-200">
                        <div class="text-center bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">How did you enjoy this story?</h3>
                            <div class="star-rating justify-center mb-4" id="storyStarRating">
                                <span class="star" data-rating="1">‚≠ê</span>
                                <span class="star" data-rating="2">‚≠ê</span>
                                <span class="star" data-rating="3">‚≠ê</span>
                                <span class="star" data-rating="4">‚≠ê</span>
                                <span class="star" data-rating="5">‚≠ê</span>
                            </div>
                            <p id="storyRatingText" class="text-sm text-gray-600 mb-4">Click a star to rate this story</p>
                            <button id="submitStoryRating" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium disabled:opacity-50" disabled>
                                Rate Story ‚≠ê
                            </button>
                        </div>
                    </div>

                    <!-- Story Actions -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button id="saveStoryBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üíñ</span>
                                <span>Save to Favorites</span>
                            </button>
                            <button id="shareStoryBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üì§</span>
                                <span>Share Story</span>
                            </button>
                            <button id="readAloudBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üîä</span>
                                <span>Read Aloud</span>
                            </button>
                            <button id="printStoryBtn" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üñ®Ô∏è</span>
                                <span>Print Story</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedbackSection" class="mt-8 pt-6 border-t border-gray-200">
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Help us improve KidsStoryTime.org!</h3>
                    <p class="text-gray-600 mb-4">Your feedback helps us create better stories for children everywhere</p>
                    <button id="showFeedbackBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2 mx-auto">
                        <span>üí¨</span>
                        <span>Share Feedback</span>
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-8 text-center">
                <a href="index.html" class="inline-flex items-center space-x-2 text-primary hover:text-primary/80 font-medium text-lg transition-colors">
                    <span>‚Üê</span>
                    <span>Create Another Story</span>
                </a>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-20">
            <div class="w-24 h-24 bg-red-100 rounded-full mx-auto mb-8 flex items-center justify-center">
                <span class="text-red-600 text-4xl">üòî</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Oops! Something went wrong</h2>
            <p class="text-xl text-gray-600 mb-8">
                Our storytelling wizard encountered a problem. Don't worry, we can try again!
            </p>
            <button id="retryBtn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium text-lg">
                Try Again ‚ú®
            </button>
        </div>
    </main>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 max-w-md w-full max-h-90vh overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üìù Share Your Feedback</h2>
                <button id="closeFeedbackModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <form id="feedbackForm" class="space-y-4">
                <!-- Overall Experience -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How was your overall experience?</label>
                    <div class="flex space-x-2 justify-center">
                        <button type="button" class="experience-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="poor">üòû Poor</button>
                        <button type="button" class="experience-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="good">üòä Good</button>
                        <button type="button" class="experience-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="excellent">ü§© Excellent</button>
                    </div>
                </div>

                <!-- Story Quality -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How would you rate the story quality?</label>
                    <div class="flex justify-center space-x-1" id="storyQualityRating">
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="1">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="2">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="3">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="4">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="5">‚≠ê</span>
                    </div>
                </div>

                <!-- App Usability -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Was the app easy to use?</label>
                    <div class="flex space-x-2 justify-center">
                        <button type="button" class="usability-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="difficult">‚ùå Difficult</button>
                        <button type="button" class="usability-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="easy">‚úÖ Easy</button>
                        <button type="button" class="usability-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="very-easy">üéØ Very Easy</button>
                    </div>
                </div>

                <!-- Feature Feedback -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Which features did you like most? (Select all that apply)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="story-quality">
                            <span class="text-sm">Story Quality</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="theme-selection">
                            <span class="text-sm">Theme Selection</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="voice-recording">
                            <span class="text-sm">Voice Recording</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="read-aloud">
                            <span class="text-sm">Read Aloud</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="personalization">
                            <span class="text-sm">Personalization</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="user-interface">
                            <span class="text-sm">User Interface</span>
                        </label>
                    </div>
                </div>

                <!-- Written Feedback -->
                <div>
                    <label for="writtenFeedback" class="block text-sm font-medium text-gray-700 mb-2">Additional comments (optional)</label>
                    <textarea id="writtenFeedback" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="What could we improve? What did you love? Any suggestions?"></textarea>
                </div>

                <!-- Contact Permission -->
                <div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="contactPermission">
                        <span class="text-sm text-gray-600">I'm open to being contacted about my feedback or beta testing new features</span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="flex space-x-3 pt-4">
                    <button type="button" id="cancelFeedback" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" id="submitFeedback" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">Submit Feedback</button>
                </div>
            </form>

            <!-- Thank You Message -->
            <div id="feedbackThanks" class="hidden text-center py-8">
                <div class="text-4xl mb-4">üéâ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Thank you!</h3>
                <p class="text-gray-600 mb-4">Your feedback helps us make KidsStoryTime.org even better for families everywhere.</p>
                <button id="closeFeedbackThanks" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-full">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/database-manager.js"></script>
    <script src="js/ai-story-service.js"></script>
    <script src="js/ai-voice-service.js"></script>
    <script src="js/subscription-manager.js"></script>

    <script>
        class StoryPageManager {
            constructor() {
                this.currentStory = null;
                this.storyParams = null;
                this.currentStoryId = null;
                this.selectedStoryRating = 0;
                this.init();
            }

            init() {
                // Get story parameters from URL or localStorage
                this.storyParams = this.getStoryParams();
                
                if (!this.storyParams) {
                    // No story parameters, redirect to home
                    window.location.href = 'index.html';
                    return;
                }

                // Generate the story
                this.generateStory();
                
                // Set up event listeners
                this.setupEventListeners();
            }

            getStoryParams() {
                // Check if we're reading an existing story from the library
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('existing') === 'true') {
                    const existingStory = localStorage.getItem('readExistingStory');
                    if (existingStory) {
                        localStorage.removeItem('readExistingStory');
                        const story = JSON.parse(existingStory);
                        this.loadExistingStory(story);
                        return null; // Skip normal story generation
                    }
                }

                // Try to get from URL parameters first
                if (urlParams.has('childName')) {
                    return {
                        childName: urlParams.get('childName'),
                        childAge: urlParams.get('childAge'),
                        storyLength: urlParams.get('storyLength'),
                        theme: urlParams.get('theme'),
                        interests: urlParams.get('interests') ? urlParams.get('interests').split(',') : [],
                        customPrompt: urlParams.get('customPrompt') || '',
                        includeNameInStory: urlParams.get('includeNameInStory') === 'true'
                    };
                }

                // Fallback to localStorage
                const stored = localStorage.getItem('pendingStory');
                if (stored) {
                    localStorage.removeItem('pendingStory');
                    return JSON.parse(stored);
                }

                return null;
            }

            loadExistingStory(story) {
                // Set up the existing story
                this.currentStory = {
                    title: story.title,
                    content: story.content,
                    metadata: {
                        childName: story.characters[0] || 'the hero',
                        childAge: story.reading_level,
                        storyLength: story.story_length,
                        theme: story.genre
                    }
                };
                this.currentStoryId = story.id;
                this.storyParams = {
                    childName: story.characters[0] || 'the hero',
                    childAge: story.reading_level,
                    storyLength: story.story_length,
                    theme: story.genre,
                    gender: story.gender,
                    customPrompt: story.custom_prompt,
                    includeNameInStory: story.include_name_in_story !== false // Default to true if not specified
                };

                // Display the story
                this.displayStory();
                
                // Check if story is already rated - if so, don't show rating section
                if (story.rating) {
                    this.selectedStoryRating = story.rating;
                    // Don't show rating section for already-rated stories
                } else if (window.authManager && window.authManager.isUserAuthenticated()) {
                    // Show rating section for authenticated users (async call handled by showRatingSectionIfEligible)
                    this.showRatingSectionIfEligible();
                }

                this.setupEventListeners();
            }

            async generateStory() {
                try {
                    this.showLoadingState();
                    
                    // Generate story using AI service
                    const result = await window.aiStoryService.generateStory(this.storyParams);
                    
                    if (result.success) {
                        this.currentStory = result.story;
                        this.displayStory();
                        
                        // Save to database if user is logged in
                        if (window.authManager && window.authManager.isUserAuthenticated()) {
                            this.saveStoryToDatabase();
                        }
                    } else {
                        console.error('Story generation failed:', result.error);
                        if (result.fallback) {
                            this.currentStory = result.fallback.story;
                            this.displayStory();
                        } else {
                            this.showErrorState();
                        }
                    }
                } catch (error) {
                    console.error('Story generation error:', error);
                    this.showErrorState();
                }
            }

            displayStory() {
                const { title, content, metadata } = this.currentStory;
                
                // Update title
                document.getElementById('storyTitle').textContent = title;
                
                // Update metadata
                const metaElement = document.getElementById('storyMeta');
                metaElement.innerHTML = `
                    <div class="flex flex-wrap justify-center items-center gap-4 text-sm">
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            üìö ${this.getReadingLevelDisplay(metadata.childAge)}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            ‚è±Ô∏è ${this.getReadingTimeText(metadata.storyLength)}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            üé≠ ${this.capitalizeFirst(metadata.theme)}
                        </span>
                    </div>
                `;
                
                // Update content with proper paragraph formatting
                const contentElement = document.getElementById('storyContent');
                const paragraphs = content.split('\n').filter(p => p.trim());
                contentElement.innerHTML = paragraphs
                    .map(paragraph => `<p>${this.escapeHtml(paragraph.trim())}</p>`)
                    .join('');
                
                // Show story display
                this.showStoryState();
                
                // Show rating section if user is logged in and has premium access
                this.showRatingSectionIfEligible();
            }

            getReadingTimeText(length) {
                const times = {
                    short: '2-3 minutes',
                    medium: '5-7 minutes',
                    long: '10-15 minutes',
                    extended: '20 minutes',
                    'long-extended': '30 minutes',
                    'extra-long': '45 minutes'
                };
                return times[length] || times.medium;
            }

            getReadingLevelDisplay(readingLevel) {
                const displays = {
                    'pre-reader': 'Pre-Reader (ages 3-6)',
                    'early-phonics': 'Early Phonics (ages 4-7)',
                    'beginning-reader': 'Beginning Reader (ages 5-8)',
                    'developing-reader': 'Developing Reader (ages 6-10)',
                    'fluent-reader': 'Fluent Reader (ages 8-13)',
                    'insightful-reader': 'Insightful Reader (ages 10-16+)'
                };
                return displays[readingLevel] || 'Beginning Reader';
            }

            capitalizeFirst(str) {
                if (!str || typeof str !== 'string') return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async saveStoryToDatabase() {
                if (!window.dbManager || !this.currentStory) return;
                
                try {
                    const user = window.authManager.getCurrentUser();
                    const storyData = {
                        user_id: user.id,
                        title: this.currentStory.title,
                        content: this.currentStory.content,
                        age_group: this.getReadingLevelDisplay(this.storyParams.childAge),
                        genre: this.storyParams.theme,
                        characters: [this.storyParams.childName || 'the hero'],
                        reading_level: this.storyParams.childAge,
                        story_length: this.storyParams.storyLength,
                        gender: this.storyParams.gender || null,
                        custom_prompt: this.storyParams.customPrompt || null,
                        include_name_in_story: this.storyParams.includeNameInStory !== false, // Default to true
                        settings: {
                            storyLength: this.storyParams.storyLength,
                            customPrompt: this.storyParams.customPrompt,
                            gender: this.storyParams.gender,
                            includeNameInStory: this.storyParams.includeNameInStory
                        }
                    };
                    
                    const result = await window.dbManager.createStory(storyData);
                    if (result.success) {
                        // Store the story ID for rating later
                        this.currentStoryId = result.data.id;
                        console.log('Story saved to history:', result.data.id);
                    }
                } catch (error) {
                    console.error('Error saving story to database:', error);
                }
            }

            setupEventListeners() {
                // Save story
                document.getElementById('saveStoryBtn').addEventListener('click', () => {
                    this.saveToFavorites();
                });

                // Share story
                document.getElementById('shareStoryBtn').addEventListener('click', () => {
                    this.shareStory();
                });

                // Read aloud
                document.getElementById('readAloudBtn').addEventListener('click', () => {
                    this.readAloud();
                });

                // Update read aloud button text based on subscription
                this.updateReadAloudButton();

                // Print story
                document.getElementById('printStoryBtn').addEventListener('click', () => {
                    this.printStory();
                });

                // Retry button
                document.getElementById('retryBtn').addEventListener('click', () => {
                    this.generateStory();
                });

                // Story rating listeners
                document.getElementById('submitStoryRating').addEventListener('click', () => {
                    this.submitStoryRating();
                });

                // Star rating listeners
                document.querySelectorAll('#storyStarRating .star').forEach(star => {
                    star.addEventListener('click', (e) => this.selectStoryRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseenter', (e) => this.hoverStoryRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseleave', () => this.unhoverStoryRating());
                });
            }

            saveToFavorites() {
                // Add visual feedback
                const btn = document.getElementById('saveStoryBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>üíñ</span><span>Saved!</span>';
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
                
                // Save to localStorage for now (can be enhanced with database)
                const favorites = JSON.parse(localStorage.getItem('favoriteStories') || '[]');
                favorites.push({
                    ...this.currentStory,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem('favoriteStories', JSON.stringify(favorites));
            }

            shareStory() {
                if (navigator.share && this.currentStory) {
                    navigator.share({
                        title: this.currentStory.title,
                        text: `Check out this magical story: ${this.currentStory.title}`,
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    const shareText = `${this.currentStory.title}\n\n${this.currentStory.content}`;
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('Story copied to clipboard! You can now share it anywhere.');
                    });
                }
            }

            async readAloud() {
                if (!this.currentStory) return;
                
                const btn = document.getElementById('readAloudBtn');
                
                // Check if user has premium AI read-aloud access
                const hasAIReadAloud = await this.checkAIReadAloudAccess();
                
                if (hasAIReadAloud) {
                    await this.useAIReadAloud(btn);
                } else {
                    this.useBasicReadAloud(btn);
                }
            }

            async checkAIReadAloudAccess() {
                try {
                    if (window.authManager && window.authManager.isUserAuthenticated()) {
                        const subscriptionType = await window.authManager.getSubscriptionStatus();
                        const limits = window.authManager.getUsageLimits(subscriptionType);
                        return limits.aiReadAloud > 0;
                    }
                } catch (error) {
                    console.error('Error checking AI read-aloud access:', error);
                }
                return false;
            }

            async updateReadAloudButton() {
                const btn = document.getElementById('readAloudBtn');
                const hasAIAccess = await this.checkAIReadAloudAccess();
                
                if (hasAIAccess) {
                    btn.innerHTML = '<span>üéß</span><span>AI Read Aloud</span>';
                    btn.title = 'Premium AI voice narration with natural-sounding speech';
                } else {
                    btn.innerHTML = '<span>üîä</span><span>Basic Read Aloud</span>';
                    btn.title = 'Basic text-to-speech using browser voice';
                }
            }

            async useAIReadAloud(btn) {
                try {
                    btn.innerHTML = '<span>üéß</span><span>Generating AI Voice...</span>';
                    btn.disabled = true;

                    const storyText = `${this.currentStory.title}. ${this.currentStory.content}`;
                    
                    // Use premium AI voice service
                    const audioUrl = await this.generateAIVoice(storyText);
                    
                    if (audioUrl) {
                        // Play the AI-generated audio
                        this.playAIAudio(audioUrl, btn);
                    } else {
                        // Fallback to basic TTS if AI generation fails
                        console.log('AI voice generation failed, falling back to basic TTS');
                        this.useBasicReadAloud(btn);
                    }
                } catch (error) {
                    console.error('AI read-aloud error:', error);
                    // Fallback to basic TTS
                    this.useBasicReadAloud(btn);
                }
            }

            async generateAIVoice(text) {
                try {
                    if (!window.aiVoiceService || !window.aiVoiceService.isAvailable()) {
                        console.log('AI Voice Service not available, falling back to basic TTS');
                        return null;
                    }
                    
                    // Use child-friendly female voice by default
                    const voiceId = 'child-friendly-female';
                    
                    console.log('Generating AI voice with premium service...');
                    const audioUrl = await window.aiVoiceService.generateVoiceAudio(text, voiceId, {
                        speed: 0.9, // Slightly slower for children
                        emotion: 'friendly',
                        style: 'storytelling'
                    });
                    
                    return audioUrl;
                } catch (error) {
                    console.error('AI voice generation error:', error);
                    return null;
                }
            }

            playAIAudio(audioUrl, btn) {
                const audio = new Audio(audioUrl);
                
                btn.innerHTML = '<span>‚è∏Ô∏è</span><span>Stop AI Reading</span>';
                btn.disabled = false;
                
                audio.play();
                
                audio.onended = () => {
                    btn.innerHTML = '<span>üéß</span><span>AI Read Aloud</span>';
                };
                
                audio.onerror = () => {
                    console.error('Audio playback error');
                    this.useBasicReadAloud(btn);
                };
            }

            useBasicReadAloud(btn) {
                if ('speechSynthesis' in window && this.currentStory) {
                    const utterance = new SpeechSynthesisUtterance();
                    utterance.text = `${this.currentStory.title}. ${this.currentStory.content}`;
                    utterance.rate = 0.8; // Slower for children
                    utterance.pitch = 1.1; // Slightly higher pitch
                    
                    // Stop any current speech
                    speechSynthesis.cancel();
                    
                    // Start speaking
                    speechSynthesis.speak(utterance);
                    
                    // Update button state
                    btn.innerHTML = '<span>üîä</span><span>Stop Basic Reading</span>';
                    btn.disabled = false;
                    
                    utterance.onend = () => {
                        btn.innerHTML = '<span>üîä</span><span>Basic Read Aloud</span>';
                    };
                } else {
                    alert('Sorry, text-to-speech is not supported in your browser.');
                }
            }

            printStory() {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>${this.currentStory.title}</title>
                            <style>
                                body { font-family: Georgia, serif; line-height: 1.6; margin: 40px; }
                                h1 { color: #FF6B9D; text-align: center; margin-bottom: 30px; }
                                .meta { text-align: center; color: #666; margin-bottom: 30px; }
                                p { margin-bottom: 15px; }
                            </style>
                        </head>
                        <body>
                            <h1>${this.currentStory.title}</h1>
                            <div class="meta">
                                A magical story for ${this.storyParams.childName} (${this.getReadingLevelDisplay(this.storyParams.childAge)})
                            </div>
                            <div>
                                ${this.currentStory.content.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('')}
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            showLoadingState() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('storyDisplay').classList.add('hidden');
                document.getElementById('errorState').classList.add('hidden');
            }

            showStoryState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyDisplay').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
            }

            showErrorState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyDisplay').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }

            // Rating functionality
            async showRatingSectionIfEligible() {
                // For testing purposes, always show the rating section
                console.log('Demo mode: Showing story rating section for testing');
                document.getElementById('storyRatingSection').classList.remove('hidden');
                
                // Original logic for production use
                if (window.authManager && window.authManager.isUserAuthenticated() && this.currentStoryId) {
                    const user = window.authManager.getCurrentUser();
                    const hasPremium = await this.hasPremiumAccess(user);
                    if (hasPremium) {
                        document.getElementById('storyRatingSection').classList.remove('hidden');
                    } else {
                        // For free users, only allow rating (not history/library access)
                        const limits = window.authManager.getUsageLimits('free');
                        if (limits.storyRating) {
                            document.getElementById('storyRatingSection').classList.remove('hidden');
                        }
                    }
                } else {
                    // Demo mode - allow rating even without authentication for testing
                    document.getElementById('storyRatingSection').classList.remove('hidden');
                }
            }

            async hasPremiumAccess(user) {
                if (window.authManager) {
                    return await window.authManager.hasPremiumAccess();
                }
                return false;
            }

            selectStoryRating(rating) {
                this.selectedStoryRating = rating;
                this.updateStoryRatingDisplay();
                document.getElementById('submitStoryRating').disabled = false;
            }

            hoverStoryRating(rating) {
                const stars = document.querySelectorAll('#storyStarRating .star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }

            unhoverStoryRating() {
                document.querySelectorAll('#storyStarRating .star').forEach(star => {
                    star.classList.remove('hover');
                });
            }

            updateStoryRatingDisplay() {
                const stars = document.querySelectorAll('#storyStarRating .star');
                const ratingText = document.getElementById('storyRatingText');
                
                stars.forEach((star, index) => {
                    if (index < this.selectedStoryRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });

                const ratingTexts = {
                    1: 'Poor - Didn\'t enjoy it',
                    2: 'Fair - It was okay',
                    3: 'Good - We liked it',
                    4: 'Great - We loved it!',
                    5: 'Excellent - Amazing story!'
                };

                ratingText.textContent = this.selectedStoryRating > 0 ? ratingTexts[this.selectedStoryRating] : 'Click a star to rate this story';
            }

            async submitStoryRating() {
                if (this.selectedStoryRating === 0) return;

                try {
                    // Demo mode handling
                    if (!this.currentStoryId || !window.authManager || !window.authManager.isUserAuthenticated()) {
                        // Demo rating
                        this.showRatingSuccessMessage(true);
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.rateStory(this.currentStoryId, this.selectedStoryRating, user.id);
                    
                    if (result.success) {
                        this.showRatingSuccessMessage(false);
                        console.log('Story rated successfully:', this.selectedStoryRating);
                    }
                } catch (error) {
                    console.error('Error rating story:', error);
                    alert('Error rating story. Please try again.');
                }
            }

            showRatingSuccessMessage(isDemo = false) {
                // Hide rating section and show success message
                document.getElementById('storyRatingSection').classList.add('hidden');
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.className = 'mt-8 pt-6 border-t border-gray-200 text-center';
                const demoText = isDemo ? ' (Demo rating - in the full version, this would be saved to your account!)' : '';
                successMessage.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
                        <div class="text-green-600 text-4xl mb-2">‚ú®</div>
                        <h3 class="text-lg font-bold text-green-800 mb-2">Thank you for rating!</h3>
                        <p class="text-green-600">Your ${this.selectedStoryRating}-star rating helps us create better stories for you!${demoText}</p>
                    </div>
                `;
                
                // Insert success message where rating section was
                const storyContent = document.getElementById('storyContent');
                storyContent.parentNode.insertBefore(successMessage, document.getElementById('storyRatingSection'));
            }
        }

        // Feedback System Manager
        class FeedbackManager {
            constructor() {
                this.selectedExperience = '';
                this.selectedUsability = '';
                this.storyQualityRating = 0;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Show feedback modal
                document.getElementById('showFeedbackBtn').addEventListener('click', () => {
                    this.showFeedbackModal();
                });

                // Close feedback modal
                document.getElementById('closeFeedbackModal').addEventListener('click', () => {
                    this.closeFeedbackModal();
                });

                document.getElementById('cancelFeedback').addEventListener('click', () => {
                    this.closeFeedbackModal();
                });

                // Experience rating buttons
                document.querySelectorAll('.experience-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectExperience(e.target.dataset.value, e.target);
                    });
                });

                // Usability rating buttons
                document.querySelectorAll('.usability-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectUsability(e.target.dataset.value, e.target);
                    });
                });

                // Story quality star rating
                document.querySelectorAll('.feedback-star').forEach(star => {
                    star.addEventListener('click', (e) => {
                        this.selectStoryQuality(parseInt(e.target.dataset.rating));
                    });
                    star.addEventListener('mouseenter', (e) => {
                        this.hoverStoryQuality(parseInt(e.target.dataset.rating));
                    });
                    star.addEventListener('mouseleave', () => {
                        this.unhoverStoryQuality();
                    });
                });

                // Form submission
                document.getElementById('feedbackForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitFeedback();
                });

                // Close thank you message
                document.getElementById('closeFeedbackThanks').addEventListener('click', () => {
                    this.closeFeedbackModal();
                });

                // Close modal when clicking outside
                document.getElementById('feedbackModal').addEventListener('click', (e) => {
                    if (e.target.id === 'feedbackModal') {
                        this.closeFeedbackModal();
                    }
                });
            }

            showFeedbackModal() {
                document.getElementById('feedbackModal').classList.remove('hidden');
                this.trackEvent('feedback_modal_opened');
            }

            closeFeedbackModal() {
                document.getElementById('feedbackModal').classList.add('hidden');
                // Reset form
                this.resetFeedbackForm();
                // Hide thank you message and show form
                document.getElementById('feedbackThanks').classList.add('hidden');
                document.getElementById('feedbackForm').classList.remove('hidden');
            }

            selectExperience(value, button) {
                // Remove selection from all experience buttons
                document.querySelectorAll('.experience-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-300');
                });
                
                // Add selection to clicked button
                button.classList.add('bg-primary', 'text-white', 'border-primary');
                button.classList.remove('border-gray-300');
                
                this.selectedExperience = value;
            }

            selectUsability(value, button) {
                // Remove selection from all usability buttons
                document.querySelectorAll('.usability-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-300');
                });
                
                // Add selection to clicked button
                button.classList.add('bg-primary', 'text-white', 'border-primary');
                button.classList.remove('border-gray-300');
                
                this.selectedUsability = value;
            }

            selectStoryQuality(rating) {
                this.storyQualityRating = rating;
                this.updateStoryQualityDisplay();
            }

            hoverStoryQuality(rating) {
                const stars = document.querySelectorAll('.feedback-star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.style.color = '#FFD700';
                        star.style.textShadow = '0 0 5px rgba(255, 215, 0, 0.3)';
                        star.style.transform = 'scale(1.1)';
                    } else {
                        star.style.color = 'transparent';
                        star.style.textShadow = '0 0 0 #ddd';
                        star.style.transform = 'scale(1)';
                    }
                });
            }

            unhoverStoryQuality() {
                this.updateStoryQualityDisplay();
            }

            updateStoryQualityDisplay() {
                const stars = document.querySelectorAll('.feedback-star');
                stars.forEach((star, index) => {
                    if (index < this.storyQualityRating) {
                        star.style.color = '#FFD700';
                        star.style.textShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
                        star.style.transform = 'scale(1)';
                    } else {
                        star.style.color = 'transparent';
                        star.style.textShadow = '0 0 0 #ddd';
                        star.style.transform = 'scale(1)';
                    }
                });
            }

            async submitFeedback() {
                // Collect form data
                const features = Array.from(document.querySelectorAll('.feature-checkbox:checked')).map(cb => cb.value);
                const writtenFeedback = document.getElementById('writtenFeedback').value;
                const contactPermission = document.getElementById('contactPermission').checked;

                const feedbackData = {
                    timestamp: new Date().toISOString(),
                    overall_experience: this.selectedExperience,
                    story_quality_rating: this.storyQualityRating,
                    app_usability: this.selectedUsability,
                    liked_features: features,
                    written_feedback: writtenFeedback,
                    contact_permission: contactPermission,
                    user_agent: navigator.userAgent,
                    page_url: window.location.href
                };

                try {
                    // Track analytics event
                    this.trackEvent('feedback_submitted', feedbackData);

                    // For demo mode, just show success
                    if (!window.authManager || !window.authManager.isUserAuthenticated()) {
                        console.log('Demo feedback submission:', feedbackData);
                        this.showThankYou(true);
                        return;
                    }

                    // For authenticated users, save to database
                    const user = window.authManager.getCurrentUser();
                    if (window.dbManager && window.dbManager.saveFeedback) {
                        const result = await window.dbManager.saveFeedback({
                            ...feedbackData,
                            user_id: user.id
                        });
                        
                        if (result.success) {
                            this.showThankYou(false);
                        } else {
                            console.error('Error saving feedback:', result.error);
                            this.showThankYou(true); // Show success anyway for UX
                        }
                    } else {
                        // Fallback - just log and show success
                        console.log('Feedback saved locally:', feedbackData);
                        this.showThankYou(true);
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    this.showThankYou(true); // Show success anyway for UX
                }
            }

            showThankYou(isDemo = false) {
                document.getElementById('feedbackForm').classList.add('hidden');
                document.getElementById('feedbackThanks').classList.remove('hidden');
                
                if (isDemo) {
                    // Update thank you message for demo mode
                    const thanksText = document.querySelector('#feedbackThanks p');
                    thanksText.textContent = 'Your feedback helps us make KidsStoryTime.org even better! (Demo mode - in the full version, this would be saved to our feedback system)';
                }
            }

            resetFeedbackForm() {
                // Reset all selections
                this.selectedExperience = '';
                this.selectedUsability = '';
                this.storyQualityRating = 0;

                // Reset UI
                document.querySelectorAll('.experience-btn, .usability-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-300');
                });

                document.querySelectorAll('.feature-checkbox').forEach(cb => {
                    cb.checked = false;
                });

                document.getElementById('writtenFeedback').value = '';
                document.getElementById('contactPermission').checked = false;

                this.updateStoryQualityDisplay();
            }

            // Analytics tracking
            trackEvent(eventName, data = {}) {
                try {
                    // Simple analytics tracking - could be enhanced with Google Analytics, etc.
                    const event = {
                        event: eventName,
                        timestamp: new Date().toISOString(),
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        ...data
                    };

                    // Log to console for now (could send to analytics service)
                    console.log('Analytics Event:', event);

                    // Store in localStorage for demo purposes
                    const existingEvents = JSON.parse(localStorage.getItem('analytics_events') || '[]');
                    existingEvents.push(event);
                    
                    // Keep only last 100 events
                    if (existingEvents.length > 100) {
                        existingEvents.splice(0, existingEvents.length - 100);
                    }
                    
                    localStorage.setItem('analytics_events', JSON.stringify(existingEvents));
                } catch (error) {
                    console.error('Error tracking event:', error);
                }
            }
        }

        // Voice Narration Controller
        class VoiceNarrationController {
            constructor(storyPageManager) {
                this.storyPageManager = storyPageManager;
                this.isNarrating = false;
                this.isPaused = false;
                this.currentWordIndex = 0;
                this.setupVoiceControls();
            }

            setupVoiceControls() {
                // Play/Pause button
                const playBtn = document.getElementById('playNarration');
                const stopBtn = document.getElementById('stopNarration');
                const voiceSelect = document.getElementById('voiceSelect');
                
                // Store current speed
                this.currentSpeed = 0.9;

                // Load available voices
                this.loadAvailableVoices();
                
                // Listen for voice changes (Chrome loads voices async)
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('Voices changed event fired');
                        this.loadAvailableVoices();
                    });
                }

                // Play/Pause narration
                playBtn.addEventListener('click', () => {
                    if (this.isNarrating && !this.isPaused) {
                        this.pauseNarration();
                    } else if (this.isPaused) {
                        this.resumeNarration();
                    } else {
                        this.startNarration();
                    }
                });

                // Stop narration
                stopBtn.addEventListener('click', () => {
                    this.stopNarration();
                });

                // Voice selection
                voiceSelect.addEventListener('change', (e) => {
                    if (window.aiVoiceService) {
                        window.aiVoiceService.setVoice(e.target.value);
                    }
                });

                // Speed preset buttons
                const speedButtons = document.querySelectorAll('.speed-preset');
                speedButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const speed = parseFloat(e.target.dataset.speed);
                        this.setSpeed(speed);
                    });
                });

                // Also handle the Read Aloud button in story actions
                const readAloudBtn = document.getElementById('readAloudBtn');
                if (readAloudBtn) {
                    readAloudBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!this.isNarrating) {
                            this.startNarration();
                        } else {
                            this.stopNarration();
                        }
                    });
                }
            }

            async loadAvailableVoices() {
                const voiceSelect = document.getElementById('voiceSelect');
                
                // Try loading voices multiple times as they may load async
                const tryLoadVoices = () => {
                    console.log('Trying to load voices...');
                    
                    if (window.aiVoiceService) {
                        console.log('AIVoiceService exists, checking availability...');
                        console.log('Is available:', window.aiVoiceService.isAvailable());
                        
                        // Force a voice check
                        if ('speechSynthesis' in window) {
                            // Force Chrome to load voices with a silent utterance
                            if (window.speechSynthesis.getVoices().length === 0) {
                                const silentUtterance = new SpeechSynthesisUtterance('');
                                silentUtterance.volume = 0;
                                window.speechSynthesis.speak(silentUtterance);
                                window.speechSynthesis.cancel();
                            }
                            
                            const browserVoices = window.speechSynthesis.getVoices();
                            console.log('Browser voices found:', browserVoices.length);
                            
                            // If browser has voices but our service doesn't, reload them
                            if (browserVoices.length > 0) {
                                window.aiVoiceService.loadVoices();
                            }
                        }
                        
                        const voices = window.aiVoiceService.getAvailableVoices();
                        console.log('Available voices:', voices.length);
                        
                        if (voices.length > 0) {
                            voiceSelect.innerHTML = '';
                            voices.forEach((voice, index) => {
                                const option = document.createElement('option');
                                option.value = voice.id;
                                option.textContent = voice.name;
                                if (index === 0) option.selected = true;
                                voiceSelect.appendChild(option);
                            });
                            return true; // Success
                        } else {
                            voiceSelect.innerHTML = '<option>Default Voice</option>';
                            // Still return true as we can use default
                            return true;
                        }
                    } else {
                        console.log('AIVoiceService not found');
                        voiceSelect.innerHTML = '<option>Voice service loading...</option>';
                        return false;
                    }
                };
                
                // Try immediately
                if (!tryLoadVoices()) {
                    // Try again after delays
                    setTimeout(tryLoadVoices, 500);
                    setTimeout(tryLoadVoices, 1500);
                    setTimeout(tryLoadVoices, 3000);
                }
            }

            setSpeed(speed) {
                this.currentSpeed = speed;
                
                // Update UI
                const speedButtons = document.querySelectorAll('.speed-preset');
                speedButtons.forEach(btn => {
                    if (parseFloat(btn.dataset.speed) === speed) {
                        btn.classList.add('bg-purple-100', 'border-purple-400');
                    } else {
                        btn.classList.remove('bg-purple-100', 'border-purple-400');
                    }
                });
                
                // Update voice service
                if (window.aiVoiceService) {
                    window.aiVoiceService.setRate(speed);
                }
                
                // If currently narrating, restart with new speed
                if (this.isNarrating && !this.isPaused) {
                    console.log('Restarting with new speed:', speed);
                    this.stopNarration();
                    setTimeout(() => this.startNarration(), 200);
                }
            }

            async startNarration() {
                if (!this.storyPageManager.currentStory) {
                    console.error('No story available to narrate');
                    return;
                }

                // More lenient check - just need speechSynthesis
                if (!('speechSynthesis' in window)) {
                    alert('Voice narration is not supported in your browser. Please try Chrome, Safari, or Edge.');
                    return;
                }
                
                // If service isn't ready, try to initialize it
                if (!window.aiVoiceService) {
                    console.log('Initializing voice service...');
                    window.aiVoiceService = new AIVoiceService();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const playBtn = document.getElementById('playNarration');
                const stopBtn = document.getElementById('stopNarration');
                const playIcon = document.getElementById('playIcon');
                const pauseIcon = document.getElementById('pauseIcon');
                const playText = document.getElementById('playText');
                const progressDiv = document.getElementById('narrationProgress');

                try {
                    // Prepare the text
                    const storyText = `${this.storyPageManager.currentStory.title}. ${this.storyPageManager.currentStory.content}`;
                    
                    // Update UI
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playText.textContent = 'Pause';
                    stopBtn.classList.remove('hidden');
                    progressDiv.classList.remove('hidden');
                    
                    this.isNarrating = true;
                    this.isPaused = false;

                    // Get selected voice and use current speed
                    const voiceSelect = document.getElementById('voiceSelect');
                    const selectedVoice = voiceSelect.value;
                    const speed = this.currentSpeed;

                    // Start narration with word highlighting
                    await window.aiVoiceService.speakText(storyText, {
                        voiceId: selectedVoice,
                        rate: speed,
                        onStart: () => {
                            console.log('Narration started');
                            this.updateProgress(0);
                        },
                        onEnd: () => {
                            console.log('Narration completed');
                            this.stopNarration();
                        },
                        onError: (error) => {
                            // Only show alert for real errors, not interruptions
                            if (error.error !== 'interrupted') {
                                console.error('Narration error:', error);
                                alert('An error occurred during narration. Please try again.');
                                this.stopNarration();
                            }
                        },
                        onWord: (charIndex, charLength) => {
                            // Update progress based on character position
                            const progress = (charIndex / storyText.length) * 100;
                            this.updateProgress(progress);
                            
                            // Optional: Highlight current word in the story content
                            this.highlightCurrentWord(charIndex, charLength);
                        },
                        onPause: () => {
                            console.log('Narration paused');
                        },
                        onResume: () => {
                            console.log('Narration resumed');
                        }
                    });

                } catch (error) {
                    console.error('Error starting narration:', error);
                    alert('Failed to start narration. Please try again.');
                    this.stopNarration();
                }
            }

            pauseNarration() {
                if (window.aiVoiceService) {
                    window.aiVoiceService.pause();
                    this.isPaused = true;
                    
                    // Update UI
                    const playIcon = document.getElementById('playIcon');
                    const pauseIcon = document.getElementById('pauseIcon');
                    const playText = document.getElementById('playText');
                    
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    playText.textContent = 'Resume';
                }
            }

            resumeNarration() {
                if (window.aiVoiceService) {
                    window.aiVoiceService.resume();
                    this.isPaused = false;
                    
                    // Update UI
                    const playIcon = document.getElementById('playIcon');
                    const pauseIcon = document.getElementById('pauseIcon');
                    const playText = document.getElementById('playText');
                    
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playText.textContent = 'Pause';
                }
            }

            stopNarration() {
                if (window.aiVoiceService) {
                    window.aiVoiceService.stop();
                }
                
                this.isNarrating = false;
                this.isPaused = false;
                
                // Reset UI
                const playBtn = document.getElementById('playNarration');
                const stopBtn = document.getElementById('stopNarration');
                const playIcon = document.getElementById('playIcon');
                const pauseIcon = document.getElementById('pauseIcon');
                const playText = document.getElementById('playText');
                const progressDiv = document.getElementById('narrationProgress');
                const progressBar = document.getElementById('progressBar');
                
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playText.textContent = 'Read Aloud';
                stopBtn.classList.add('hidden');
                progressDiv.classList.add('hidden');
                progressBar.style.width = '0%';
                
                // Clear any word highlighting
                this.clearWordHighlighting();
            }

            updateProgress(percentage) {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
            }

            highlightCurrentWord(charIndex, charLength) {
                // Optional: Add visual highlighting to the current word being spoken
                // This is a simplified version - in production, you'd want more sophisticated text tracking
                const storyContent = document.getElementById('storyContent');
                if (!storyContent) return;
                
                // Remove previous highlighting
                this.clearWordHighlighting();
                
                // This is a placeholder - actual implementation would require more complex text parsing
                // to accurately highlight words in the formatted HTML content
            }

            clearWordHighlighting() {
                // Clear any existing word highlighting
                const highlighted = document.querySelectorAll('.word-highlight');
                highlighted.forEach(el => {
                    el.classList.remove('word-highlight');
                });
            }
        }

        // Initialize story page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const storyPageManager = new StoryPageManager();
            const feedbackManager = new FeedbackManager();
            const voiceController = new VoiceNarrationController(storyPageManager);
        });
    </script>
</body>
</html>