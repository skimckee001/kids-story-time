<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Magic Story - Kids Story Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B9D',
                        secondary: '#4ECDC4',
                        accent: '#FFE66D'
                    }
                }
            }
        }
    </script>
    <style>
        .story-text {
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.8;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 2s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .sparkle {
            position: relative;
            overflow: hidden;
        }
        
        .sparkle::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 157, 0.3), transparent);
            border-radius: inherit;
            animation: sparkle 3s linear infinite;
            z-index: -1;
        }
        
        @keyframes sparkle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-200">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üìö</span>
                    </div>
                    <span class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        Kids Story Time
                    </span>
                </div>
                <a href="index.html" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                    ‚Üê Create New Story
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="sparkle w-24 h-24 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mb-8 flex items-center justify-center">
                <span class="text-white text-4xl animate-bounce">‚ú®</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Creating Your Magic Story</h2>
            <p class="text-xl text-gray-600 mb-6">
                <span class="loading-dots">Our storytelling wizard is crafting something special just for you</span>
            </p>
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 max-w-md mx-auto">
                <div class="flex items-center space-x-4">
                    <div class="w-4 h-4 bg-primary rounded-full animate-pulse"></div>
                    <div class="w-4 h-4 bg-secondary rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-4 h-4 bg-accent rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- Story Display -->
        <div id="storyDisplay" class="hidden">
            <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl overflow-hidden fade-in">
                <!-- Story Header -->
                <div class="bg-gradient-to-r from-primary via-secondary to-accent p-8 text-white relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
                    <div class="relative z-10">
                        <h1 id="storyTitle" class="text-4xl md:text-5xl font-bold mb-4 text-center">
                            <!-- Story title will be inserted here -->
                        </h1>
                        <div id="storyMeta" class="text-center space-y-2 opacity-90">
                            <!-- Story metadata will be inserted here -->
                        </div>
                    </div>
                    <div class="absolute top-4 right-4">
                        <span class="text-6xl opacity-30">üåü</span>
                    </div>
                    <div class="absolute bottom-4 left-4">
                        <span class="text-4xl opacity-30">üìñ</span>
                    </div>
                </div>

                <!-- Story Content -->
                <div class="p-8 md:p-12">
                    <div id="storyContent" class="story-text text-lg md:text-xl text-gray-700 space-y-6 leading-relaxed">
                        <!-- Story content will be inserted here -->
                    </div>

                    <!-- Story Rating Section (Premium) -->
                    <div id="storyRatingSection" class="hidden mt-8 pt-6 border-t border-gray-200">
                        <div class="text-center bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-2xl">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">How did you enjoy this story?</h3>
                            <div class="star-rating justify-center mb-4" id="storyStarRating">
                                <span class="star" data-rating="1">‚≠ê</span>
                                <span class="star" data-rating="2">‚≠ê</span>
                                <span class="star" data-rating="3">‚≠ê</span>
                                <span class="star" data-rating="4">‚≠ê</span>
                                <span class="star" data-rating="5">‚≠ê</span>
                            </div>
                            <p id="storyRatingText" class="text-sm text-gray-600 mb-4">Click a star to rate this story</p>
                            <button id="submitStoryRating" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium disabled:opacity-50" disabled>
                                Rate Story ‚≠ê
                            </button>
                        </div>
                    </div>

                    <!-- Story Actions -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button id="saveStoryBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üíñ</span>
                                <span>Save to Favorites</span>
                            </button>
                            <button id="shareStoryBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üì§</span>
                                <span>Share Story</span>
                            </button>
                            <button id="readAloudBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üîä</span>
                                <span>Read Aloud</span>
                            </button>
                            <button id="printStoryBtn" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üñ®Ô∏è</span>
                                <span>Print Story</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-8 text-center">
                <a href="index.html" class="inline-flex items-center space-x-2 text-primary hover:text-primary/80 font-medium text-lg transition-colors">
                    <span>‚Üê</span>
                    <span>Create Another Story</span>
                </a>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-20">
            <div class="w-24 h-24 bg-red-100 rounded-full mx-auto mb-8 flex items-center justify-center">
                <span class="text-red-600 text-4xl">üòî</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Oops! Something went wrong</h2>
            <p class="text-xl text-gray-600 mb-8">
                Our storytelling wizard encountered a problem. Don't worry, we can try again!
            </p>
            <button id="retryBtn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium text-lg">
                Try Again ‚ú®
            </button>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/database-manager.js"></script>
    <script src="js/ai-story-service.js"></script>
    <script src="js/subscription-manager.js"></script>

    <script>
        class StoryPageManager {
            constructor() {
                this.currentStory = null;
                this.storyParams = null;
                this.currentStoryId = null;
                this.selectedStoryRating = 0;
                this.init();
            }

            init() {
                // Get story parameters from URL or localStorage
                this.storyParams = this.getStoryParams();
                
                if (!this.storyParams) {
                    // No story parameters, redirect to home
                    window.location.href = 'index.html';
                    return;
                }

                // Generate the story
                this.generateStory();
                
                // Set up event listeners
                this.setupEventListeners();
            }

            getStoryParams() {
                // Check if we're reading an existing story from the library
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('existing') === 'true') {
                    const existingStory = localStorage.getItem('readExistingStory');
                    if (existingStory) {
                        localStorage.removeItem('readExistingStory');
                        const story = JSON.parse(existingStory);
                        this.loadExistingStory(story);
                        return null; // Skip normal story generation
                    }
                }

                // Try to get from URL parameters first
                if (urlParams.has('childName')) {
                    return {
                        childName: urlParams.get('childName'),
                        childAge: urlParams.get('childAge'),
                        storyLength: urlParams.get('storyLength'),
                        theme: urlParams.get('theme'),
                        interests: urlParams.get('interests') ? urlParams.get('interests').split(',') : [],
                        customPrompt: urlParams.get('customPrompt') || ''
                    };
                }

                // Fallback to localStorage
                const stored = localStorage.getItem('pendingStory');
                if (stored) {
                    localStorage.removeItem('pendingStory');
                    return JSON.parse(stored);
                }

                return null;
            }

            loadExistingStory(story) {
                // Set up the existing story
                this.currentStory = {
                    title: story.title,
                    content: story.content,
                    metadata: {
                        childName: story.characters[0] || 'the hero',
                        childAge: story.reading_level,
                        storyLength: story.story_length,
                        theme: story.genre
                    }
                };
                this.currentStoryId = story.id;
                this.storyParams = {
                    childName: story.characters[0] || 'the hero',
                    childAge: story.reading_level,
                    storyLength: story.story_length,
                    theme: story.genre,
                    gender: story.gender,
                    customPrompt: story.custom_prompt
                };

                // Display the story
                this.displayStory();
                
                // Check if story is already rated - if so, don't show rating section
                if (story.rating) {
                    this.selectedStoryRating = story.rating;
                    // Don't show rating section for already-rated stories
                } else if (window.authManager && window.authManager.isUserAuthenticated()) {
                    // Show rating section for authenticated users (async call handled by showRatingSectionIfEligible)
                    this.showRatingSectionIfEligible();
                }

                this.setupEventListeners();
            }

            async generateStory() {
                try {
                    this.showLoadingState();
                    
                    // Generate story using AI service
                    const result = await window.aiStoryService.generateStory(this.storyParams);
                    
                    if (result.success) {
                        this.currentStory = result.story;
                        this.displayStory();
                        
                        // Save to database if user is logged in
                        if (window.authManager && window.authManager.isUserAuthenticated()) {
                            this.saveStoryToDatabase();
                        }
                    } else {
                        console.error('Story generation failed:', result.error);
                        if (result.fallback) {
                            this.currentStory = result.fallback.story;
                            this.displayStory();
                        } else {
                            this.showErrorState();
                        }
                    }
                } catch (error) {
                    console.error('Story generation error:', error);
                    this.showErrorState();
                }
            }

            displayStory() {
                const { title, content, metadata } = this.currentStory;
                
                // Update title
                document.getElementById('storyTitle').textContent = title;
                
                // Update metadata
                const metaElement = document.getElementById('storyMeta');
                metaElement.innerHTML = `
                    <div class="flex flex-wrap justify-center items-center gap-4 text-sm">
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            üìö ${this.getReadingLevelDisplay(metadata.childAge)}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            ‚è±Ô∏è ${this.getReadingTimeText(metadata.storyLength)}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            üé≠ ${this.capitalizeFirst(metadata.theme)}
                        </span>
                    </div>
                `;
                
                // Update content with proper paragraph formatting
                const contentElement = document.getElementById('storyContent');
                const paragraphs = content.split('\n').filter(p => p.trim());
                contentElement.innerHTML = paragraphs
                    .map(paragraph => `<p>${this.escapeHtml(paragraph.trim())}</p>`)
                    .join('');
                
                // Show story display
                this.showStoryState();
                
                // Show rating section if user is logged in and has premium access
                this.showRatingSectionIfEligible();
            }

            getReadingTimeText(length) {
                const times = {
                    short: '2-3 minutes',
                    medium: '5-7 minutes',
                    long: '10-15 minutes'
                };
                return times[length] || times.medium;
            }

            getReadingLevelDisplay(readingLevel) {
                const displays = {
                    'pre-reader': 'Pre-Reader (ages 3-6)',
                    'early-phonics': 'Early Phonics (ages 4-7)',
                    'beginning-reader': 'Beginning Reader (ages 5-8)',
                    'developing-reader': 'Developing Reader (ages 6-10)',
                    'fluent-reader': 'Fluent Reader (ages 8-13)',
                    'insightful-reader': 'Insightful Reader (ages 10-16+)'
                };
                return displays[readingLevel] || 'Beginning Reader';
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async saveStoryToDatabase() {
                if (!window.dbManager || !this.currentStory) return;
                
                try {
                    const user = window.authManager.getCurrentUser();
                    const storyData = {
                        user_id: user.id,
                        title: this.currentStory.title,
                        content: this.currentStory.content,
                        age_group: this.getReadingLevelDisplay(this.storyParams.childAge),
                        genre: this.storyParams.theme,
                        characters: [this.storyParams.childName || 'the hero'],
                        reading_level: this.storyParams.childAge,
                        story_length: this.storyParams.storyLength,
                        gender: this.storyParams.gender || null,
                        custom_prompt: this.storyParams.customPrompt || null,
                        settings: {
                            storyLength: this.storyParams.storyLength,
                            customPrompt: this.storyParams.customPrompt,
                            gender: this.storyParams.gender
                        }
                    };
                    
                    const result = await window.dbManager.createStory(storyData);
                    if (result.success) {
                        // Store the story ID for rating later
                        this.currentStoryId = result.data.id;
                        console.log('Story saved to history:', result.data.id);
                    }
                } catch (error) {
                    console.error('Error saving story to database:', error);
                }
            }

            setupEventListeners() {
                // Save story
                document.getElementById('saveStoryBtn').addEventListener('click', () => {
                    this.saveToFavorites();
                });

                // Share story
                document.getElementById('shareStoryBtn').addEventListener('click', () => {
                    this.shareStory();
                });

                // Read aloud
                document.getElementById('readAloudBtn').addEventListener('click', () => {
                    this.readAloud();
                });

                // Print story
                document.getElementById('printStoryBtn').addEventListener('click', () => {
                    this.printStory();
                });

                // Retry button
                document.getElementById('retryBtn').addEventListener('click', () => {
                    this.generateStory();
                });

                // Story rating listeners
                document.getElementById('submitStoryRating').addEventListener('click', () => {
                    this.submitStoryRating();
                });

                // Star rating listeners
                document.querySelectorAll('#storyStarRating .star').forEach(star => {
                    star.addEventListener('click', (e) => this.selectStoryRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseenter', (e) => this.hoverStoryRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseleave', () => this.unhoverStoryRating());
                });
            }

            saveToFavorites() {
                // Add visual feedback
                const btn = document.getElementById('saveStoryBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>üíñ</span><span>Saved!</span>';
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
                
                // Save to localStorage for now (can be enhanced with database)
                const favorites = JSON.parse(localStorage.getItem('favoriteStories') || '[]');
                favorites.push({
                    ...this.currentStory,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem('favoriteStories', JSON.stringify(favorites));
            }

            shareStory() {
                if (navigator.share && this.currentStory) {
                    navigator.share({
                        title: this.currentStory.title,
                        text: `Check out this magical story: ${this.currentStory.title}`,
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy to clipboard
                    const shareText = `${this.currentStory.title}\n\n${this.currentStory.content}`;
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('Story copied to clipboard! You can now share it anywhere.');
                    });
                }
            }

            readAloud() {
                if ('speechSynthesis' in window && this.currentStory) {
                    const utterance = new SpeechSynthesisUtterance();
                    utterance.text = `${this.currentStory.title}. ${this.currentStory.content}`;
                    utterance.rate = 0.8; // Slower for children
                    utterance.pitch = 1.1; // Slightly higher pitch
                    
                    // Stop any current speech
                    speechSynthesis.cancel();
                    
                    // Start speaking
                    speechSynthesis.speak(utterance);
                    
                    // Update button state
                    const btn = document.getElementById('readAloudBtn');
                    btn.innerHTML = '<span>‚è∏Ô∏è</span><span>Stop Reading</span>';
                    
                    utterance.onend = () => {
                        btn.innerHTML = '<span>üîä</span><span>Read Aloud</span>';
                    };
                } else {
                    alert('Sorry, text-to-speech is not supported in your browser.');
                }
            }

            printStory() {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>${this.currentStory.title}</title>
                            <style>
                                body { font-family: Georgia, serif; line-height: 1.6; margin: 40px; }
                                h1 { color: #FF6B9D; text-align: center; margin-bottom: 30px; }
                                .meta { text-align: center; color: #666; margin-bottom: 30px; }
                                p { margin-bottom: 15px; }
                            </style>
                        </head>
                        <body>
                            <h1>${this.currentStory.title}</h1>
                            <div class="meta">
                                A magical story for ${this.storyParams.childName} (${this.getReadingLevelDisplay(this.storyParams.childAge)})
                            </div>
                            <div>
                                ${this.currentStory.content.split('\n').map(p => p.trim() ? `<p>${p}</p>` : '').join('')}
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            showLoadingState() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('storyDisplay').classList.add('hidden');
                document.getElementById('errorState').classList.add('hidden');
            }

            showStoryState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyDisplay').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
            }

            showErrorState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyDisplay').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }

            // Rating functionality
            async showRatingSectionIfEligible() {
                if (window.authManager && window.authManager.isUserAuthenticated() && this.currentStoryId) {
                    const user = window.authManager.getCurrentUser();
                    const hasPremium = await this.hasPremiumAccess(user);
                    if (hasPremium) {
                        document.getElementById('storyRatingSection').classList.remove('hidden');
                    } else {
                        // For free users, only allow rating (not history/library access)
                        const limits = window.authManager.getUsageLimits('free');
                        if (limits.storyRating) {
                            document.getElementById('storyRatingSection').classList.remove('hidden');
                        }
                    }
                }
            }

            async hasPremiumAccess(user) {
                if (window.authManager) {
                    return await window.authManager.hasPremiumAccess();
                }
                return false;
            }

            selectStoryRating(rating) {
                this.selectedStoryRating = rating;
                this.updateStoryRatingDisplay();
                document.getElementById('submitStoryRating').disabled = false;
            }

            hoverStoryRating(rating) {
                const stars = document.querySelectorAll('#storyStarRating .star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }

            unhoverStoryRating() {
                document.querySelectorAll('#storyStarRating .star').forEach(star => {
                    star.classList.remove('hover');
                });
            }

            updateStoryRatingDisplay() {
                const stars = document.querySelectorAll('#storyStarRating .star');
                const ratingText = document.getElementById('storyRatingText');
                
                stars.forEach((star, index) => {
                    if (index < this.selectedStoryRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });

                const ratingTexts = {
                    1: 'Poor - Didn\'t enjoy it',
                    2: 'Fair - It was okay',
                    3: 'Good - We liked it',
                    4: 'Great - We loved it!',
                    5: 'Excellent - Amazing story!'
                };

                ratingText.textContent = this.selectedStoryRating > 0 ? ratingTexts[this.selectedStoryRating] : 'Click a star to rate this story';
            }

            async submitStoryRating() {
                if (!this.currentStoryId || this.selectedStoryRating === 0) return;

                try {
                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.rateStory(this.currentStoryId, this.selectedStoryRating, user.id);
                    
                    if (result.success) {
                        // Hide rating section and show success message
                        document.getElementById('storyRatingSection').classList.add('hidden');
                        
                        // Show success message
                        const successMessage = document.createElement('div');
                        successMessage.className = 'mt-8 pt-6 border-t border-gray-200 text-center';
                        successMessage.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
                                <div class="text-green-600 text-4xl mb-2">‚ú®</div>
                                <h3 class="text-lg font-bold text-green-800 mb-2">Thank you for rating!</h3>
                                <p class="text-green-600">Your ${this.selectedStoryRating}-star rating helps us create better stories for you!</p>
                            </div>
                        `;
                        
                        // Insert success message where rating section was
                        const storyContent = document.getElementById('storyContent');
                        storyContent.parentNode.insertBefore(successMessage, document.getElementById('storyRatingSection'));
                        
                        console.log('Story rated successfully:', this.selectedStoryRating);
                    }
                } catch (error) {
                    console.error('Error rating story:', error);
                    alert('Error rating story. Please try again.');
                }
            }
        }

        // Initialize story page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new StoryPageManager();
        });
    </script>
</body>
</html>