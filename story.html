<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Magic Story - Kids Story Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B9D',
                        secondary: '#4ECDC4',
                        accent: '#FFE66D'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        
        .story-text {
            font-family: Arial, sans-serif;
            line-height: 1.8;
        }
        
        .loading-dots::after {
            content: '...';
            animation: dots 2s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .sparkle {
            position: relative;
            overflow: hidden;
        }
        
        .sparkle::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255, 107, 157, 0.3), transparent);
            border-radius: inherit;
            animation: sparkle 3s linear infinite;
            z-index: -1;
        }
        
        @keyframes sparkle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 32px;
            color: transparent;
            text-shadow: 0 0 0 #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .star.active {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .star:hover,
        .star.hover {
            color: #FFD700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
        }
        
        /* Responsive image styling */
        @media (min-width: 1024px) {
            #storyImageContainer + p,
            #storyImageContainer + p + p,
            #storyImageContainer + p + p + p {
                overflow: hidden; /* Ensure text wraps around floated image */
            }
            
            #storyMainImage {
                max-height: 400px;
                object-fit: cover;
            }
        }
        
        /* Clear float after story content */
        #storyContent::after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-200">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üìö</span>
                    </div>
                    <span style="font-size: 28px; font-weight: bold; background: linear-gradient(135deg, #FF6B9D, #4ECDC4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        KidsStoryTime<span style="font-size: 0.6em; font-weight: normal; color: #666;">.org</span>
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Star display will be inserted here by star-points-service.js -->
                    <div id="headerStarContainer" class="hidden">
                        <!-- Star display gets inserted here -->
                    </div>
                    <div class="relative group">
                        <button onclick="window.location.href='library.html'" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium text-sm">
                            üìö My Library
                        </button>
                        <div class="absolute top-full mt-2 right-0 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                            Register free to access your stories
                        </div>
                    </div>
                    <a href="index.html" class="bg-gradient-to-r from-primary to-secondary text-white px-4 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium text-sm">
                        ‚Üê New Story
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="sparkle w-24 h-24 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mb-8 flex items-center justify-center">
                <span class="text-white text-4xl animate-bounce">‚ú®</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Creating Your Magic Story</h2>
            <p class="text-xl text-gray-600 mb-6">
                <span class="loading-dots">Our storytelling wizard is crafting something special just for you</span>
            </p>
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 max-w-md mx-auto">
                <div class="flex items-center space-x-4">
                    <div class="w-4 h-4 bg-primary rounded-full animate-pulse"></div>
                    <div class="w-4 h-4 bg-secondary rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-4 h-4 bg-accent rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- Story Display -->
        <div id="storyDisplay" class="hidden">
            <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl overflow-hidden fade-in">
                <!-- Story Header -->
                <div class="bg-gradient-to-r from-primary via-secondary to-accent p-8 text-white relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
                    <div class="relative z-10">
                        <h1 id="storyTitle" class="text-4xl md:text-5xl font-bold mb-4 text-center">
                            <!-- Story title will be inserted here -->
                        </h1>
                        <div id="storyMeta" class="text-center space-y-2 opacity-90">
                            <!-- Story metadata will be inserted here -->
                        </div>
                    </div>
                    <div class="absolute top-4 right-4">
                        <span class="text-6xl opacity-30">üåü</span>
                    </div>
                    <div class="absolute bottom-4 left-4">
                        <span class="text-4xl opacity-30">üìñ</span>
                    </div>
                </div>

                <!-- Voice Narration Controls -->
                <div id="voiceControls" class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b border-purple-100">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <button id="playNarration" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full hover:shadow-lg transition-all flex items-center gap-2">
                                <svg id="playIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <svg id="pauseIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span id="playText">Read Aloud</span>
                            </button>
                            <button id="stopNarration" class="bg-gray-500 text-white px-4 py-2 rounded-full hover:bg-gray-600 transition-all hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6v4H9z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <!-- Voice Selection -->
                            <select id="voiceSelect" class="px-3 py-1 border border-purple-300 rounded-lg text-sm focus:outline-none focus:border-purple-500">
                                <option>Loading voices...</option>
                            </select>
                            
                            <!-- Speed Control -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">Speed:</label>
                                <div class="flex gap-1">
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100" data-speed="0.7">0.7x</button>
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100 bg-purple-100 border-purple-400" data-speed="0.9">0.9x</button>
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100" data-speed="1.0">1.0x</button>
                                    <button class="speed-preset px-2 py-1 text-xs border rounded hover:bg-purple-100" data-speed="1.2">1.2x</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="narrationProgress" class="mt-3 hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Story Content with Images -->
                <div class="p-8 md:p-12">
                    <!-- Story Text with inline image -->
                    <div id="storyContent" class="story-text text-lg md:text-xl text-gray-700 space-y-6 leading-relaxed">
                        <!-- Story content will be inserted here -->
                    </div>

                    <!-- Story Rating Section (Premium) -->
                    <div id="storyRatingSection" class="hidden mt-6 pt-4 border-t border-gray-200">
                        <div class="text-center bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Rate this story:</p>
                            <div class="star-rating justify-center" id="storyStarRating">
                                <span class="star" data-rating="1">‚≠ê</span>
                                <span class="star" data-rating="2">‚≠ê</span>
                                <span class="star" data-rating="3">‚≠ê</span>
                                <span class="star" data-rating="4">‚≠ê</span>
                                <span class="star" data-rating="5">‚≠ê</span>
                            </div>
                            <p id="storyRatingText" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                    </div>

                    <!-- Story Actions -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button id="saveStoryBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üíñ</span>
                                <span>Save as Favourite</span>
                            </button>
                            <button id="shareStoryBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üì§</span>
                                <span>Share Story</span>
                            </button>
                            <button id="printStoryBtn" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2">
                                <span>üñ®Ô∏è</span>
                                <span>Print Story</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedbackSection" class="mt-8 pt-6 border-t border-gray-200">
                <div class="text-center">
                    <button id="showFeedbackBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium flex items-center space-x-2 mx-auto">
                        <span>üí¨</span>
                        <span>Share Feedback</span>
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-8 text-center">
                <a href="index.html" class="inline-flex items-center space-x-2 text-primary hover:text-primary/80 font-medium text-lg transition-colors">
                    <span>‚Üê</span>
                    <span>Create Another Story</span>
                </a>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-20">
            <div class="w-24 h-24 bg-red-100 rounded-full mx-auto mb-8 flex items-center justify-center">
                <span class="text-red-600 text-4xl">üòî</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Oops! Something went wrong</h2>
            <p class="text-xl text-gray-600 mb-8">
                Our storytelling wizard encountered a problem. Don't worry, we can try again!
            </p>
            <button id="retryBtn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium text-lg">
                Try Again ‚ú®
            </button>
        </div>
    </main>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 max-w-md w-full max-h-90vh overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üìù Share Your Feedback</h2>
                <button id="closeFeedbackModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <form id="feedbackForm" class="space-y-4">
                <!-- Overall Experience -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How was your overall experience?</label>
                    <div class="flex space-x-2 justify-center">
                        <button type="button" class="experience-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="poor">üòû Poor</button>
                        <button type="button" class="experience-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="good">üòä Good</button>
                        <button type="button" class="experience-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="excellent">ü§© Excellent</button>
                    </div>
                </div>

                <!-- Story Quality -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How would you rate the story quality?</label>
                    <div class="flex justify-center space-x-1" id="storyQualityRating">
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="1">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="2">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="3">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="4">‚≠ê</span>
                        <span class="feedback-star text-2xl cursor-pointer" data-rating="5">‚≠ê</span>
                    </div>
                </div>

                <!-- App Usability -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Was the app easy to use?</label>
                    <div class="flex space-x-2 justify-center">
                        <button type="button" class="usability-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="difficult">‚ùå Difficult</button>
                        <button type="button" class="usability-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="easy">‚úÖ Easy</button>
                        <button type="button" class="usability-btn px-4 py-2 rounded-full border-2 border-gray-300 transition-colors" data-value="very-easy">üéØ Very Easy</button>
                    </div>
                </div>

                <!-- Feature Feedback -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Which features did you like most? (Select all that apply)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="story-quality">
                            <span class="text-sm">Story Quality</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="theme-selection">
                            <span class="text-sm">Theme Selection</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="voice-recording">
                            <span class="text-sm">Voice Recording</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="read-aloud">
                            <span class="text-sm">Read Aloud</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="personalization">
                            <span class="text-sm">Personalization</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="feature-checkbox" value="user-interface">
                            <span class="text-sm">User Interface</span>
                        </label>
                    </div>
                </div>

                <!-- Written Feedback -->
                <div>
                    <label for="writtenFeedback" class="block text-sm font-medium text-gray-700 mb-2">Additional comments (optional)</label>
                    <textarea id="writtenFeedback" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="What could we improve? What did you love? Any suggestions?"></textarea>
                </div>

                <!-- Contact Permission -->
                <div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="contactPermission">
                        <span class="text-sm text-gray-600">I'm open to being contacted about my feedback or beta testing new features</span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="flex space-x-3 pt-4">
                    <button type="button" id="cancelFeedback" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" id="submitFeedback" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">Submit Feedback</button>
                </div>
            </form>

            <!-- Thank You Message -->
            <div id="feedbackThanks" class="hidden text-center py-8">
                <div class="text-4xl mb-4">üéâ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Thank you!</h3>
                <p class="text-gray-600 mb-4">Your feedback helps us make KidsStoryTime.org even better for families everywhere.</p>
                <button id="closeFeedbackThanks" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-full">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/database-manager.js"></script>
    <script src="js/ai-story-service.js"></script>
    <script src="js/ai-voice-service.js"></script>
    <script src="js/image-generation-service.js"></script>
    <script src="js/story-export-service.js"></script>
    <script src="js/subscription-manager.js"></script>
    <script src="js/star-points-service.js"></script>
    <script src="js/social-sharing-service.js"></script>

    <script>
        class StoryPageManager {
            constructor() {
                this.currentStory = null;
                this.storyParams = null;
                this.currentStoryId = null;
                this.selectedStoryRating = 0;
                this.init();
            }

            async init() {
                // Get story parameters from URL or localStorage
                this.storyParams = await this.getStoryParams();
                
                if (!this.storyParams) {
                    // No story parameters, redirect to home
                    window.location.href = 'index.html';
                    return;
                }

                // Generate the story
                this.generateStory();
                
                // Set up event listeners
                this.setupEventListeners();
            }

            async getStoryParams() {
                // Check if we're reading an existing story from the library
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('existing') === 'true') {
                    const existingStory = localStorage.getItem('readExistingStory');
                    if (existingStory) {
                        localStorage.removeItem('readExistingStory');
                        const story = JSON.parse(existingStory);
                        await this.loadExistingStory(story);
                        return null; // Skip normal story generation
                    }
                }

                // Try to get from URL parameters first
                if (urlParams.has('childName')) {
                    return {
                        childName: urlParams.get('childName'),
                        childAge: urlParams.get('childAge'),
                        storyLength: urlParams.get('storyLength'),
                        theme: urlParams.get('theme'),
                        interests: urlParams.get('interests') ? urlParams.get('interests').split(',') : [],
                        customPrompt: urlParams.get('customPrompt') || '',
                        includeNameInStory: urlParams.get('includeNameInStory') === 'true'
                    };
                }

                // Fallback to localStorage
                const stored = localStorage.getItem('pendingStory');
                if (stored) {
                    localStorage.removeItem('pendingStory');
                    return JSON.parse(stored);
                }

                return null;
            }

            async loadExistingStory(story) {
                // Set up the existing story
                this.currentStory = {
                    title: story.title,
                    content: story.content,
                    metadata: {
                        childName: story.characters[0] || 'the hero',
                        childAge: story.reading_level,
                        storyLength: story.story_length,
                        theme: story.genre
                    }
                };
                this.currentStoryId = story.id;
                this.storyParams = {
                    childName: story.characters[0] || 'the hero',
                    childAge: story.reading_level,
                    storyLength: story.story_length,
                    theme: story.genre,
                    gender: story.gender,
                    customPrompt: story.custom_prompt,
                    includeNameInStory: story.include_name_in_story !== false // Default to true if not specified
                };

                // Display the story
                await this.displayStory();
                
                // Check if story is already rated - if so, don't show rating section
                if (story.rating) {
                    this.selectedStoryRating = story.rating;
                    // Don't show rating section for already-rated stories
                } else if (window.authManager && window.authManager.isUserAuthenticated()) {
                    // Show rating section for authenticated users (async call handled by showRatingSectionIfEligible)
                    this.showRatingSectionIfEligible();
                }

                this.setupEventListeners();
            }

            async generateStory() {
                try {
                    this.showLoadingState();
                    
                    // Generate story using AI service
                    const result = await window.aiStoryService.generateStory(this.storyParams);
                    
                    if (result.success) {
                        this.currentStory = result.story;
                        await this.displayStory();
                        
                        // Save to database if user is logged in
                        if (window.authManager && window.authManager.isUserAuthenticated()) {
                            this.saveStoryToDatabase();
                        }
                    } else {
                        console.error('Story generation failed:', result.error);
                        if (result.fallback) {
                            this.currentStory = result.fallback.story;
                            await this.displayStory();
                        } else {
                            this.showErrorState();
                        }
                    }
                } catch (error) {
                    console.error('Story generation error:', error);
                    this.showErrorState();
                }
            }

            async displayStory() {
                const { title, content, metadata } = this.currentStory;
                
                // Update title
                document.getElementById('storyTitle').textContent = title;
                
                // Update metadata
                const metaElement = document.getElementById('storyMeta');
                metaElement.innerHTML = `
                    <div class="flex flex-wrap justify-center items-center gap-4 text-sm">
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            üìö ${this.getReadingLevelDisplay(metadata.childAge)}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            ‚è±Ô∏è ${this.getReadingTimeText(metadata.storyLength)}
                        </span>
                        <span class="bg-white/20 px-3 py-1 rounded-full">
                            üé≠ ${this.capitalizeFirst(metadata.theme)}
                        </span>
                    </div>
                `;
                
                // Update content with proper paragraph formatting
                const contentElement = document.getElementById('storyContent');
                const paragraphs = content.split('\n').filter(p => p.trim());
                
                // Insert image after first paragraph and ad in the middle
                let storyHTML = '';
                const midpoint = Math.floor(paragraphs.length / 2);
                
                for (let i = 0; i < paragraphs.length; i++) {
                    storyHTML += `<p>${this.escapeHtml(paragraphs[i].trim())}</p>`;
                    
                    // Insert image after first paragraph
                    if (i === 0) {
                        storyHTML += `
                            <div id="storyImageContainer" class="my-6">
                                <!-- Mobile: full width, Desktop: float right with text wrap -->
                                <div class="lg:float-right lg:ml-6 lg:mb-4 lg:w-1/2">
                                    <div class="relative">
                                        <img id="storyMainImage" src="https://via.placeholder.com/400x400/E8D5FF/667eea?text=Story+Image" 
                                             alt="Story illustration" 
                                             class="rounded-lg shadow-lg w-full lg:max-w-sm mx-auto lg:mx-0">
                                        <button onclick="window.storyPageManager.showImageUpgradePrompt()" 
                                                class="absolute top-2 right-2 bg-white/90 hover:bg-white text-xs px-3 py-1.5 rounded-lg shadow-md transition flex items-center gap-1">
                                            ‚ú® Generate AI Image
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Insert ad at midpoint (only for non-premium users)
                    if (i === midpoint - 1) {
                        storyHTML += `
                            <div id="story-middle-ad" class="ad-container my-6 p-4 bg-gray-50 rounded-lg text-center">
                                <div class="text-xs text-gray-500 mb-2">Advertisement</div>
                                <div id="ad-story-middle">
                                    <!-- Ad will be inserted here by ad service -->
                                </div>
                            </div>
                        `;
                    }
                }
                
                contentElement.innerHTML = storyHTML;
                
                // Initialize ad if ad service is available and user is not premium
                if (window.adService && !window.adService.isPremiumUser) {
                    setTimeout(() => {
                        window.adService.createStoryMiddleAd();
                    }, 100);
                }
                
                // Show story display
                this.showStoryState();
                
                // Award stars for creating a story (1 star)
                if (window.starPointsService) {
                    await window.starPointsService.awardStoryCreationStars();
                }
                
                // Generate images for the story (async)
                this.generateStoryImages();
                
                // Show rating section if user is logged in and has premium access
                this.showRatingSectionIfEligible();
            }

            async generateStoryImages() {
                // Check if user has access to image generation (premium feature)
                const hasImageAccess = await this.checkImageGenerationAccess();
                
                if (!hasImageAccess) {
                    console.log('Image generation not available for free tier');
                    return;
                }

                if (!window.imageGenerationService) {
                    console.log('Image generation service not available');
                    return;
                }

                try {
                    const mainImage = document.getElementById('storyMainImage');
                    if (!mainImage) {
                        console.log('Story image element not found');
                        return;
                    }
                    
                    // Show loading state on the image
                    mainImage.style.opacity = '0.5';
                    
                    // Generate a single image based on story content
                    const images = await window.imageGenerationService.generateStoryImages(
                        this.currentStory,
                        1 // Generate 1 image
                    );
                    
                    // Update the main image
                    if (images && images.length > 0) {
                        mainImage.src = images[0].url;
                        mainImage.alt = images[0].alt;
                        mainImage.style.opacity = '1';
                        
                        // Cache the image
                        window.imageGenerationService.cacheImage(images[0]);
                    }
                } catch (error) {
                    console.error('Error generating story image:', error);
                    const mainImage = document.getElementById('storyMainImage');
                    if (mainImage) {
                        mainImage.style.opacity = '1';
                    }
                }
            }

            async checkImageGenerationAccess() {
                try {
                    // For demo/testing, allow image generation
                    return true;
                    
                    // Production logic:
                    // if (window.authManager && window.authManager.isUserAuthenticated()) {
                    //     const subscriptionType = await window.authManager.getSubscriptionStatus();
                    //     return subscriptionType === 'premium' || subscriptionType === 'trial';
                    // }
                    // return false;
                } catch (error) {
                    console.error('Error checking image access:', error);
                    return false;
                }
            }

            showImageUpgradePrompt() {
                // Create modal for upgrade prompt
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-3xl p-6 max-w-md w-full">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">‚ú® AI-Generated Images</h2>
                        <div class="mb-4">
                            <img src="https://source.unsplash.com/400x300/?fantasy,illustration,colorful" class="w-full rounded-lg mb-3" alt="AI Generated Example">
                            <p class="text-gray-600 mb-4">Upgrade to Pro tier for custom AI-generated images that perfectly match your story!</p>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="text-green-500">‚úì</span>
                                    <span>Premium: Stock images from our library</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-purple-500">‚ú®</span>
                                    <span><strong>Pro: AI-generated custom images</strong></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Maybe Later
                            </button>
                            <button onclick="window.location.href='index.html#pricing'" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg">
                                Upgrade to Pro
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            getReadingTimeText(length) {
                const times = {
                    short: '2-3 minutes',
                    medium: '5-7 minutes',
                    long: '10-15 minutes',
                    extended: '20 minutes',
                    'long-extended': '30 minutes',
                    'extra-long': '45 minutes'
                };
                return times[length] || times.medium;
            }

            getReadingLevelDisplay(readingLevel) {
                const displays = {
                    'pre-reader': 'Pre-Reader (ages 3-6)',
                    'early-phonics': 'Early Phonics (ages 4-7)',
                    'beginning-reader': 'Beginning Reader (ages 5-8)',
                    'developing-reader': 'Developing Reader (ages 6-10)',
                    'fluent-reader': 'Fluent Reader (ages 8-13)',
                    'insightful-reader': 'Insightful Reader (ages 10-16+)'
                };
                return displays[readingLevel] || 'Beginning Reader';
            }

            capitalizeFirst(str) {
                if (!str || typeof str !== 'string') return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async saveStoryToDatabase() {
                if (!window.dbManager || !this.currentStory) return;
                
                try {
                    const user = window.authManager.getCurrentUser();
                    const storyData = {
                        user_id: user.id,
                        title: this.currentStory.title,
                        content: this.currentStory.content,
                        age_group: this.getReadingLevelDisplay(this.storyParams.childAge),
                        genre: this.storyParams.theme,
                        characters: [this.storyParams.childName || 'the hero'],
                        reading_level: this.storyParams.childAge,
                        story_length: this.storyParams.storyLength,
                        gender: this.storyParams.gender || null,
                        custom_prompt: this.storyParams.customPrompt || null,
                        include_name_in_story: this.storyParams.includeNameInStory !== false, // Default to true
                        settings: {
                            storyLength: this.storyParams.storyLength,
                            customPrompt: this.storyParams.customPrompt,
                            gender: this.storyParams.gender,
                            includeNameInStory: this.storyParams.includeNameInStory
                        }
                    };
                    
                    const result = await window.dbManager.createStory(storyData);
                    if (result.success) {
                        // Store the story ID for rating later
                        this.currentStoryId = result.data.id;
                        console.log('Story saved to history:', result.data.id);
                    }
                } catch (error) {
                    console.error('Error saving story to database:', error);
                }
            }

            setupEventListeners() {
                // Save story
                document.getElementById('saveStoryBtn').addEventListener('click', () => {
                    this.saveToFavorites();
                });

                // Share story
                document.getElementById('shareStoryBtn').addEventListener('click', () => {
                    this.shareStory();
                });

                // Read aloud
                document.getElementById('readAloudBtn').addEventListener('click', () => {
                    this.readAloud();
                });

                // Update read aloud button text based on subscription
                this.updateReadAloudButton();

                // Print story
                document.getElementById('printStoryBtn').addEventListener('click', () => {
                    this.printStory();
                });

                // Retry button
                document.getElementById('retryBtn').addEventListener('click', () => {
                    this.generateStory();
                });

                // Star rating listeners
                document.querySelectorAll('#storyStarRating .star').forEach(star => {
                    star.addEventListener('click', (e) => this.selectStoryRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseenter', (e) => this.hoverStoryRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseleave', () => this.unhoverStoryRating());
                });
            }

            saveToFavorites() {
                // Check if user is logged in
                if (!window.authManager || !window.authManager.isUserAuthenticated()) {
                    // Show login prompt
                    alert('Please create a free account to save stories to your favorites and access your story history.\n\nClick "Start Free Trial" to get started!');
                    return;
                }
                
                // Add visual feedback
                const btn = document.getElementById('saveStoryBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>üíñ</span><span>Saved!</span>';
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
                
                // Save to localStorage for now (can be enhanced with database)
                const favorites = JSON.parse(localStorage.getItem('favoriteStories') || '[]');
                favorites.push({
                    ...this.currentStory,
                    savedAt: new Date().toISOString()
                });
                localStorage.setItem('favoriteStories', JSON.stringify(favorites));
            }

            async shareStory() {
                // Use the new social sharing service with #StoryStarMoments
                if (window.socialSharingService) {
                    await window.socialSharingService.shareStory(this.currentStory);
                } else {
                    // Fallback to old modal
                    this.showShareModal();
                }
            }

            showShareModal() {
                if (!this.currentStory) return;

                // Create share modal if it doesn't exist
                let modal = document.getElementById('shareModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'shareModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4';
                    modal.innerHTML = `
                        <div class="bg-white rounded-3xl p-6 max-w-md w-full">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Share This Story</h2>
                                <button id="closeShareModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            
                            <div class="space-y-3">
                                <!-- Share buttons -->
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="shareFacebook" class="flex items-center justify-center gap-2 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                        Facebook
                                    </button>
                                    <button id="shareTwitter" class="flex items-center justify-center gap-2 p-3 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                                        Twitter
                                    </button>
                                    <button id="shareWhatsApp" class="flex items-center justify-center gap-2 p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.149-.67.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 16.772c-.25.7-.997 1.299-1.615 1.47-.415.116-1.016.206-2.95-.63-2.483-.98-4.08-3.549-4.204-3.711-.124-.161-1.015-1.35-1.015-2.576 0-1.226.643-1.829.871-2.078.228-.248.497-.31.663-.31l.474.003c.152.002.355-.057.556.425.206.493.7 1.703.763 1.826.062.124.104.269.021.434-.083.166-.124.269-.248.414-.124.145-.262.324-.373.435-.124.124-.253.26-.108.509.145.248.643 1.061 1.38 1.719.949.845 1.75 1.107 1.998 1.232.248.124.393.103.538-.062.145-.166.621-.724.786-.973.166-.248.331-.207.556-.124.228.083 1.44.68 1.687.805.248.124.414.186.476.29.062.103.062.601-.187 1.302z"/></svg>
                                        WhatsApp
                                    </button>
                                    <button id="shareEmail" class="flex items-center justify-center gap-2 p-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                        Email
                                    </button>
                                </div>
                                
                                <!-- Copy link -->
                                <div class="border-t pt-3">
                                    <p class="text-sm text-gray-600 mb-2">Or copy link:</p>
                                    <div class="flex gap-2">
                                        <input id="shareLink" type="text" readonly class="flex-1 px-3 py-2 border rounded-lg text-sm bg-gray-50" value="${window.location.href}">
                                        <button id="copyShareLink" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Native share (mobile) -->
                                ${navigator.share ? `
                                    <button id="nativeShare" class="w-full p-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition">
                                        Share via Apps
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // Set up event listeners
                    document.getElementById('closeShareModal').addEventListener('click', () => {
                        modal.classList.add('hidden');
                    });

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });

                    // Share button handlers
                    this.setupShareHandlers();
                }

                // Show modal
                modal.classList.remove('hidden');
            }

            setupShareHandlers() {
                const story = this.currentStory;
                const storyUrl = window.location.href;
                const shareText = `Check out this magical story: "${story.title}" - Created with Kids Story Time`;

                // Facebook
                document.getElementById('shareFacebook')?.addEventListener('click', () => {
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(storyUrl)}`, '_blank');
                });

                // Twitter
                document.getElementById('shareTwitter')?.addEventListener('click', () => {
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(storyUrl)}`, '_blank');
                });

                // WhatsApp
                document.getElementById('shareWhatsApp')?.addEventListener('click', () => {
                    window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + storyUrl)}`, '_blank');
                });

                // Email
                document.getElementById('shareEmail')?.addEventListener('click', () => {
                    const subject = `Magical Story: ${story.title}`;
                    const body = `I thought you might enjoy this story!\n\n${story.title}\n\n${story.content.substring(0, 500)}...\n\nRead the full story here: ${storyUrl}`;
                    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                });

                // Copy link
                document.getElementById('copyShareLink')?.addEventListener('click', () => {
                    const input = document.getElementById('shareLink');
                    input.select();
                    document.execCommand('copy');
                    
                    const btn = document.getElementById('copyShareLink');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                });

                // Native share
                document.getElementById('nativeShare')?.addEventListener('click', () => {
                    if (navigator.share) {
                        navigator.share({
                            title: story.title,
                            text: shareText,
                            url: storyUrl
                        }).catch(err => console.log('Share canceled'));
                    }
                });
            }

            async readAloud() {
                if (!this.currentStory) return;
                
                const btn = document.getElementById('readAloudBtn');
                
                // Award stars for using Read Aloud (5 stars, once per day)
                if (window.starPointsService) {
                    await window.starPointsService.awardReadAloudStars();
                }
                
                // Check if user has premium AI read-aloud access
                const hasAIReadAloud = await this.checkAIReadAloudAccess();
                
                if (hasAIReadAloud) {
                    await this.useAIReadAloud(btn);
                } else {
                    this.useBasicReadAloud(btn);
                }
            }

            async checkAIReadAloudAccess() {
                try {
                    if (window.authManager && window.authManager.isUserAuthenticated()) {
                        const subscriptionType = await window.authManager.getSubscriptionStatus();
                        const limits = window.authManager.getUsageLimits(subscriptionType);
                        return limits.aiReadAloud > 0;
                    }
                } catch (error) {
                    console.error('Error checking AI read-aloud access:', error);
                }
                return false;
            }

            async updateReadAloudButton() {
                const btn = document.getElementById('readAloudBtn');
                const hasAIAccess = await this.checkAIReadAloudAccess();
                
                if (hasAIAccess) {
                    btn.innerHTML = '<span>üéß</span><span>AI Read Aloud</span>';
                    btn.title = 'Premium AI voice narration with natural-sounding speech';
                } else {
                    btn.innerHTML = '<span>üîä</span><span>Basic Read Aloud</span>';
                    btn.title = 'Basic text-to-speech using browser voice';
                }
            }

            async useAIReadAloud(btn) {
                try {
                    btn.innerHTML = '<span>üéß</span><span>Generating AI Voice...</span>';
                    btn.disabled = true;

                    const storyText = `${this.currentStory.title}. ${this.currentStory.content}`;
                    
                    // Use premium AI voice service
                    const audioUrl = await this.generateAIVoice(storyText);
                    
                    if (audioUrl) {
                        // Play the AI-generated audio
                        this.playAIAudio(audioUrl, btn);
                    } else {
                        // Fallback to basic TTS if AI generation fails
                        console.log('AI voice generation failed, falling back to basic TTS');
                        this.useBasicReadAloud(btn);
                    }
                } catch (error) {
                    console.error('AI read-aloud error:', error);
                    // Fallback to basic TTS
                    this.useBasicReadAloud(btn);
                }
            }

            async generateAIVoice(text) {
                try {
                    if (!window.aiVoiceService || !window.aiVoiceService.isAvailable()) {
                        console.log('AI Voice Service not available, falling back to basic TTS');
                        return null;
                    }
                    
                    // Use child-friendly female voice by default
                    const voiceId = 'child-friendly-female';
                    
                    console.log('Generating AI voice with premium service...');
                    const audioUrl = await window.aiVoiceService.generateVoiceAudio(text, voiceId, {
                        speed: 0.9, // Slightly slower for children
                        emotion: 'friendly',
                        style: 'storytelling'
                    });
                    
                    return audioUrl;
                } catch (error) {
                    console.error('AI voice generation error:', error);
                    return null;
                }
            }

            playAIAudio(audioUrl, btn) {
                const audio = new Audio(audioUrl);
                
                btn.innerHTML = '<span>‚è∏Ô∏è</span><span>Stop AI Reading</span>';
                btn.disabled = false;
                
                audio.play();
                
                audio.onended = () => {
                    btn.innerHTML = '<span>üéß</span><span>AI Read Aloud</span>';
                };
                
                audio.onerror = () => {
                    console.error('Audio playback error');
                    this.useBasicReadAloud(btn);
                };
            }

            useBasicReadAloud(btn) {
                if ('speechSynthesis' in window && this.currentStory) {
                    const utterance = new SpeechSynthesisUtterance();
                    utterance.text = `${this.currentStory.title}. ${this.currentStory.content}`;
                    utterance.rate = 0.8; // Slower for children
                    utterance.pitch = 1.1; // Slightly higher pitch
                    
                    // Stop any current speech
                    speechSynthesis.cancel();
                    
                    // Start speaking
                    speechSynthesis.speak(utterance);
                    
                    // Update button state
                    btn.innerHTML = '<span>üîä</span><span>Stop Basic Reading</span>';
                    btn.disabled = false;
                    
                    utterance.onend = () => {
                        btn.innerHTML = '<span>üîä</span><span>Basic Read Aloud</span>';
                    };
                } else {
                    alert('Sorry, text-to-speech is not supported in your browser.');
                }
            }

            printStory() {
                // Show export options modal
                this.showExportModal();
            }

            showExportModal() {
                if (!this.currentStory) return;

                // Create export modal if it doesn't exist
                let modal = document.getElementById('exportModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'exportModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4';
                    modal.innerHTML = `
                        <div class="bg-white rounded-3xl p-6 max-w-md w-full">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Export Story</h2>
                                <button id="closeExportModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            
                            <div class="space-y-3">
                                <button id="exportPDF" class="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition">
                                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-semibold">PDF Document</div>
                                        <div class="text-sm text-gray-500">Print or save as PDF with images</div>
                                    </div>
                                </button>
                                
                                <button id="exportWord" class="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-semibold">Word Document</div>
                                        <div class="text-sm text-gray-500">Edit in Microsoft Word</div>
                                    </div>
                                </button>
                                
                                <button id="exportText" class="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition">
                                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-semibold">Plain Text</div>
                                        <div class="text-sm text-gray-500">Simple text file</div>
                                    </div>
                                </button>
                                
                                <button id="exportAudio" class="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition">
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-semibold">Audio File</div>
                                        <div class="text-sm text-gray-500">Listen offline (Premium)</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // Set up event listeners
                    document.getElementById('closeExportModal').addEventListener('click', () => {
                        modal.classList.add('hidden');
                    });

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });

                    // Export handlers
                    this.setupExportHandlers();
                }

                // Show modal
                modal.classList.remove('hidden');
            }

            setupExportHandlers() {
                if (!window.storyExportService) {
                    console.error('Export service not available');
                    return;
                }

                // PDF Export
                document.getElementById('exportPDF')?.addEventListener('click', async () => {
                    const images = window.imageGenerationService?.getCachedImages() || [];
                    await window.storyExportService.exportAsPDF(this.currentStory, images);
                    document.getElementById('exportModal').classList.add('hidden');
                });

                // Word Export
                document.getElementById('exportWord')?.addEventListener('click', () => {
                    window.storyExportService.exportAsWord(this.currentStory);
                    document.getElementById('exportModal').classList.add('hidden');
                });

                // Text Export
                document.getElementById('exportText')?.addEventListener('click', () => {
                    window.storyExportService.exportAsText(this.currentStory);
                    document.getElementById('exportModal').classList.add('hidden');
                });

                // Audio Export
                document.getElementById('exportAudio')?.addEventListener('click', async () => {
                    await window.storyExportService.exportAsAudio(this.currentStory);
                    document.getElementById('exportModal').classList.add('hidden');
                });
            }

            showLoadingState() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('storyDisplay').classList.add('hidden');
                document.getElementById('errorState').classList.add('hidden');
            }

            showStoryState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyDisplay').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
            }

            showErrorState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('storyDisplay').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }

            // Rating functionality
            async showRatingSectionIfEligible() {
                // For testing purposes, always show the rating section
                console.log('Demo mode: Showing story rating section for testing');
                document.getElementById('storyRatingSection').classList.remove('hidden');
                
                // Original logic for production use
                if (window.authManager && window.authManager.isUserAuthenticated() && this.currentStoryId) {
                    const user = window.authManager.getCurrentUser();
                    const hasPremium = await this.hasPremiumAccess(user);
                    if (hasPremium) {
                        document.getElementById('storyRatingSection').classList.remove('hidden');
                    } else {
                        // For free users, only allow rating (not history/library access)
                        const limits = window.authManager.getUsageLimits('free');
                        if (limits.storyRating) {
                            document.getElementById('storyRatingSection').classList.remove('hidden');
                        }
                    }
                } else {
                    // Demo mode - allow rating even without authentication for testing
                    document.getElementById('storyRatingSection').classList.remove('hidden');
                }
            }

            async hasPremiumAccess(user) {
                if (window.authManager) {
                    return await window.authManager.hasPremiumAccess();
                }
                return false;
            }

            selectStoryRating(rating) {
                this.selectedStoryRating = rating;
                this.updateStoryRatingDisplay();
                // Auto-save the rating
                this.submitStoryRating();
            }

            hoverStoryRating(rating) {
                const stars = document.querySelectorAll('#storyStarRating .star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }

            unhoverStoryRating() {
                document.querySelectorAll('#storyStarRating .star').forEach(star => {
                    star.classList.remove('hover');
                });
            }

            updateStoryRatingDisplay() {
                const stars = document.querySelectorAll('#storyStarRating .star');
                const ratingText = document.getElementById('storyRatingText');
                
                stars.forEach((star, index) => {
                    if (index < this.selectedStoryRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });

                const ratingTexts = {
                    1: 'Poor - Didn\'t enjoy it',
                    2: 'Fair - It was okay',
                    3: 'Good - We liked it',
                    4: 'Great - We loved it!',
                    5: 'Excellent - Amazing story!'
                };

                ratingText.textContent = this.selectedStoryRating > 0 ? ratingTexts[this.selectedStoryRating] : 'Click a star to rate this story';
            }

            async submitStoryRating() {
                if (this.selectedStoryRating === 0) return;

                try {
                    // Demo mode handling
                    if (!this.currentStoryId || !window.authManager || !window.authManager.isUserAuthenticated()) {
                        // Demo rating
                        this.showRatingSuccessMessage(true);
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.rateStory(this.currentStoryId, this.selectedStoryRating, user.id);
                    
                    if (result.success) {
                        this.showRatingSuccessMessage(false);
                        console.log('Story rated successfully:', this.selectedStoryRating);
                    }
                } catch (error) {
                    console.error('Error rating story:', error);
                    alert('Error rating story. Please try again.');
                }
            }

            showRatingSuccessMessage(isDemo = false) {
                // Hide rating section and show success message
                document.getElementById('storyRatingSection').classList.add('hidden');
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.className = 'mt-8 pt-6 border-t border-gray-200 text-center';
                const demoText = isDemo ? ' (Demo rating - in the full version, this would be saved to your account!)' : '';
                successMessage.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
                        <div class="text-green-600 text-4xl mb-2">‚ú®</div>
                        <h3 class="text-lg font-bold text-green-800 mb-2">Thank you for rating!</h3>
                        <p class="text-green-600">Your ${this.selectedStoryRating}-star rating helps us create better stories for you!${demoText}</p>
                    </div>
                `;
                
                // Insert success message where rating section was
                const storyContent = document.getElementById('storyContent');
                storyContent.parentNode.insertBefore(successMessage, document.getElementById('storyRatingSection'));
            }
        }

        // Feedback System Manager
        class FeedbackManager {
            constructor() {
                this.selectedExperience = '';
                this.selectedUsability = '';
                this.storyQualityRating = 0;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Show feedback modal
                document.getElementById('showFeedbackBtn').addEventListener('click', () => {
                    this.showFeedbackModal();
                });

                // Close feedback modal
                document.getElementById('closeFeedbackModal').addEventListener('click', () => {
                    this.closeFeedbackModal();
                });

                document.getElementById('cancelFeedback').addEventListener('click', () => {
                    this.closeFeedbackModal();
                });

                // Experience rating buttons
                document.querySelectorAll('.experience-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectExperience(e.target.dataset.value, e.target);
                    });
                });

                // Usability rating buttons
                document.querySelectorAll('.usability-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectUsability(e.target.dataset.value, e.target);
                    });
                });

                // Story quality star rating
                document.querySelectorAll('.feedback-star').forEach(star => {
                    star.addEventListener('click', (e) => {
                        this.selectStoryQuality(parseInt(e.target.dataset.rating));
                    });
                    star.addEventListener('mouseenter', (e) => {
                        this.hoverStoryQuality(parseInt(e.target.dataset.rating));
                    });
                    star.addEventListener('mouseleave', () => {
                        this.unhoverStoryQuality();
                    });
                });

                // Form submission
                document.getElementById('feedbackForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitFeedback();
                });

                // Close thank you message
                document.getElementById('closeFeedbackThanks').addEventListener('click', () => {
                    this.closeFeedbackModal();
                });

                // Close modal when clicking outside
                document.getElementById('feedbackModal').addEventListener('click', (e) => {
                    if (e.target.id === 'feedbackModal') {
                        this.closeFeedbackModal();
                    }
                });
            }

            showFeedbackModal() {
                document.getElementById('feedbackModal').classList.remove('hidden');
                this.trackEvent('feedback_modal_opened');
            }

            closeFeedbackModal() {
                document.getElementById('feedbackModal').classList.add('hidden');
                // Reset form
                this.resetFeedbackForm();
                // Hide thank you message and show form
                document.getElementById('feedbackThanks').classList.add('hidden');
                document.getElementById('feedbackForm').classList.remove('hidden');
            }

            selectExperience(value, button) {
                // Remove selection from all experience buttons
                document.querySelectorAll('.experience-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-300');
                });
                
                // Add selection to clicked button
                button.classList.add('bg-primary', 'text-white', 'border-primary');
                button.classList.remove('border-gray-300');
                
                this.selectedExperience = value;
            }

            selectUsability(value, button) {
                // Remove selection from all usability buttons
                document.querySelectorAll('.usability-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-300');
                });
                
                // Add selection to clicked button
                button.classList.add('bg-primary', 'text-white', 'border-primary');
                button.classList.remove('border-gray-300');
                
                this.selectedUsability = value;
            }

            selectStoryQuality(rating) {
                this.storyQualityRating = rating;
                this.updateStoryQualityDisplay();
            }

            hoverStoryQuality(rating) {
                const stars = document.querySelectorAll('.feedback-star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.style.color = '#FFD700';
                        star.style.textShadow = '0 0 5px rgba(255, 215, 0, 0.3)';
                        star.style.transform = 'scale(1.1)';
                    } else {
                        star.style.color = 'transparent';
                        star.style.textShadow = '0 0 0 #ddd';
                        star.style.transform = 'scale(1)';
                    }
                });
            }

            unhoverStoryQuality() {
                this.updateStoryQualityDisplay();
            }

            updateStoryQualityDisplay() {
                const stars = document.querySelectorAll('.feedback-star');
                stars.forEach((star, index) => {
                    if (index < this.storyQualityRating) {
                        star.style.color = '#FFD700';
                        star.style.textShadow = '0 0 10px rgba(255, 215, 0, 0.5)';
                        star.style.transform = 'scale(1)';
                    } else {
                        star.style.color = 'transparent';
                        star.style.textShadow = '0 0 0 #ddd';
                        star.style.transform = 'scale(1)';
                    }
                });
            }

            async submitFeedback() {
                // Collect form data
                const features = Array.from(document.querySelectorAll('.feature-checkbox:checked')).map(cb => cb.value);
                const writtenFeedback = document.getElementById('writtenFeedback').value;
                const contactPermission = document.getElementById('contactPermission').checked;

                const feedbackData = {
                    timestamp: new Date().toISOString(),
                    overall_experience: this.selectedExperience,
                    story_quality_rating: this.storyQualityRating,
                    app_usability: this.selectedUsability,
                    liked_features: features,
                    written_feedback: writtenFeedback,
                    contact_permission: contactPermission,
                    user_agent: navigator.userAgent,
                    page_url: window.location.href
                };

                try {
                    // Track analytics event
                    this.trackEvent('feedback_submitted', feedbackData);

                    // For demo mode, just show success
                    if (!window.authManager || !window.authManager.isUserAuthenticated()) {
                        console.log('Demo feedback submission:', feedbackData);
                        this.showThankYou(true);
                        return;
                    }

                    // For authenticated users, save to database
                    const user = window.authManager.getCurrentUser();
                    if (window.dbManager && window.dbManager.saveFeedback) {
                        const result = await window.dbManager.saveFeedback({
                            ...feedbackData,
                            user_id: user.id
                        });
                        
                        if (result.success) {
                            this.showThankYou(false);
                        } else {
                            console.error('Error saving feedback:', result.error);
                            this.showThankYou(true); // Show success anyway for UX
                        }
                    } else {
                        // Fallback - just log and show success
                        console.log('Feedback saved locally:', feedbackData);
                        this.showThankYou(true);
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    this.showThankYou(true); // Show success anyway for UX
                }
            }

            showThankYou(isDemo = false) {
                document.getElementById('feedbackForm').classList.add('hidden');
                document.getElementById('feedbackThanks').classList.remove('hidden');
                
                if (isDemo) {
                    // Update thank you message for demo mode
                    const thanksText = document.querySelector('#feedbackThanks p');
                    thanksText.textContent = 'Your feedback helps us make KidsStoryTime.org even better! (Demo mode - in the full version, this would be saved to our feedback system)';
                }
            }

            resetFeedbackForm() {
                // Reset all selections
                this.selectedExperience = '';
                this.selectedUsability = '';
                this.storyQualityRating = 0;

                // Reset UI
                document.querySelectorAll('.experience-btn, .usability-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('border-gray-300');
                });

                document.querySelectorAll('.feature-checkbox').forEach(cb => {
                    cb.checked = false;
                });

                document.getElementById('writtenFeedback').value = '';
                document.getElementById('contactPermission').checked = false;

                this.updateStoryQualityDisplay();
            }

            // Analytics tracking
            trackEvent(eventName, data = {}) {
                try {
                    // Simple analytics tracking - could be enhanced with Google Analytics, etc.
                    const event = {
                        event: eventName,
                        timestamp: new Date().toISOString(),
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        ...data
                    };

                    // Log to console for now (could send to analytics service)
                    console.log('Analytics Event:', event);

                    // Store in localStorage for demo purposes
                    const existingEvents = JSON.parse(localStorage.getItem('analytics_events') || '[]');
                    existingEvents.push(event);
                    
                    // Keep only last 100 events
                    if (existingEvents.length > 100) {
                        existingEvents.splice(0, existingEvents.length - 100);
                    }
                    
                    localStorage.setItem('analytics_events', JSON.stringify(existingEvents));
                } catch (error) {
                    console.error('Error tracking event:', error);
                }
            }
        }

        // Voice Narration Controller
        class VoiceNarrationController {
            constructor(storyPageManager) {
                this.storyPageManager = storyPageManager;
                this.isNarrating = false;
                this.isPaused = false;
                this.currentWordIndex = 0;
                this.setupVoiceControls();
            }

            setupVoiceControls() {
                // Play/Pause button
                const playBtn = document.getElementById('playNarration');
                const stopBtn = document.getElementById('stopNarration');
                const voiceSelect = document.getElementById('voiceSelect');
                
                // Store current speed
                this.currentSpeed = 0.9;

                // Load available voices
                this.loadAvailableVoices();
                
                // Listen for voice changes (Chrome loads voices async)
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('Voices changed event fired');
                        this.loadAvailableVoices();
                    });
                }

                // Play/Pause narration
                playBtn.addEventListener('click', () => {
                    if (this.isNarrating && !this.isPaused) {
                        this.pauseNarration();
                    } else if (this.isPaused) {
                        this.resumeNarration();
                    } else {
                        this.startNarration();
                    }
                });

                // Stop narration
                stopBtn.addEventListener('click', () => {
                    this.stopNarration();
                });

                // Voice selection
                voiceSelect.addEventListener('change', (e) => {
                    if (window.aiVoiceService) {
                        window.aiVoiceService.setVoice(e.target.value);
                    }
                });

                // Speed preset buttons
                const speedButtons = document.querySelectorAll('.speed-preset');
                speedButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const speed = parseFloat(e.target.dataset.speed);
                        this.setSpeed(speed);
                    });
                });

                // Also handle the Read Aloud button in story actions
                const readAloudBtn = document.getElementById('readAloudBtn');
                if (readAloudBtn) {
                    readAloudBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!this.isNarrating) {
                            this.startNarration();
                        } else {
                            this.stopNarration();
                        }
                    });
                }
            }

            async loadAvailableVoices() {
                const voiceSelect = document.getElementById('voiceSelect');
                
                // Try loading voices multiple times as they may load async
                const tryLoadVoices = () => {
                    console.log('Trying to load voices...');
                    
                    if (window.aiVoiceService) {
                        console.log('AIVoiceService exists, checking availability...');
                        console.log('Is available:', window.aiVoiceService.isAvailable());
                        
                        // Force a voice check
                        if ('speechSynthesis' in window) {
                            // Force Chrome to load voices with a silent utterance
                            if (window.speechSynthesis.getVoices().length === 0) {
                                const silentUtterance = new SpeechSynthesisUtterance('');
                                silentUtterance.volume = 0;
                                window.speechSynthesis.speak(silentUtterance);
                                window.speechSynthesis.cancel();
                            }
                            
                            const browserVoices = window.speechSynthesis.getVoices();
                            console.log('Browser voices found:', browserVoices.length);
                            
                            // If browser has voices but our service doesn't, reload them
                            if (browserVoices.length > 0) {
                                window.aiVoiceService.loadVoices();
                            }
                        }
                        
                        const voices = window.aiVoiceService.getAvailableVoices();
                        console.log('Available voices:', voices.length);
                        
                        if (voices.length > 0) {
                            voiceSelect.innerHTML = '';
                            voices.forEach((voice, index) => {
                                const option = document.createElement('option');
                                option.value = voice.id;
                                option.textContent = voice.name;
                                if (index === 0) option.selected = true;
                                voiceSelect.appendChild(option);
                            });
                            return true; // Success
                        } else {
                            voiceSelect.innerHTML = '<option>Default Voice</option>';
                            // Still return true as we can use default
                            return true;
                        }
                    } else {
                        console.log('AIVoiceService not found');
                        voiceSelect.innerHTML = '<option>Voice service loading...</option>';
                        return false;
                    }
                };
                
                // Try immediately
                if (!tryLoadVoices()) {
                    // Try again after delays
                    setTimeout(tryLoadVoices, 500);
                    setTimeout(tryLoadVoices, 1500);
                    setTimeout(tryLoadVoices, 3000);
                }
            }

            setSpeed(speed) {
                this.currentSpeed = speed;
                
                // Update UI
                const speedButtons = document.querySelectorAll('.speed-preset');
                speedButtons.forEach(btn => {
                    if (parseFloat(btn.dataset.speed) === speed) {
                        btn.classList.add('bg-purple-100', 'border-purple-400');
                    } else {
                        btn.classList.remove('bg-purple-100', 'border-purple-400');
                    }
                });
                
                // Update voice service
                if (window.aiVoiceService) {
                    window.aiVoiceService.setRate(speed);
                }
                
                // If currently narrating, restart with new speed
                if (this.isNarrating && !this.isPaused) {
                    console.log('Restarting with new speed:', speed);
                    this.stopNarration();
                    setTimeout(() => this.startNarration(), 200);
                }
            }

            async startNarration() {
                if (!this.storyPageManager.currentStory) {
                    console.error('No story available to narrate');
                    return;
                }

                // More lenient check - just need speechSynthesis
                if (!('speechSynthesis' in window)) {
                    alert('Voice narration is not supported in your browser. Please try Chrome, Safari, or Edge.');
                    return;
                }
                
                // If service isn't ready, try to initialize it
                if (!window.aiVoiceService) {
                    console.log('Initializing voice service...');
                    window.aiVoiceService = new AIVoiceService();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const playBtn = document.getElementById('playNarration');
                const stopBtn = document.getElementById('stopNarration');
                const playIcon = document.getElementById('playIcon');
                const pauseIcon = document.getElementById('pauseIcon');
                const playText = document.getElementById('playText');
                const progressDiv = document.getElementById('narrationProgress');

                try {
                    // Prepare the text
                    const storyText = `${this.storyPageManager.currentStory.title}. ${this.storyPageManager.currentStory.content}`;
                    
                    // Update UI
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playText.textContent = 'Pause';
                    stopBtn.classList.remove('hidden');
                    progressDiv.classList.remove('hidden');
                    
                    this.isNarrating = true;
                    this.isPaused = false;

                    // Get selected voice and use current speed
                    const voiceSelect = document.getElementById('voiceSelect');
                    const selectedVoice = voiceSelect.value;
                    const speed = this.currentSpeed;

                    // Start narration with word highlighting
                    await window.aiVoiceService.speakText(storyText, {
                        voiceId: selectedVoice,
                        rate: speed,
                        onStart: () => {
                            console.log('Narration started');
                            this.updateProgress(0);
                        },
                        onEnd: () => {
                            console.log('Narration completed');
                            this.stopNarration();
                        },
                        onError: (error) => {
                            // Only show alert for real errors, not interruptions
                            if (error.error !== 'interrupted') {
                                console.error('Narration error:', error);
                                alert('An error occurred during narration. Please try again.');
                                this.stopNarration();
                            }
                        },
                        onWord: (charIndex, charLength) => {
                            // Update progress based on character position
                            const progress = (charIndex / storyText.length) * 100;
                            this.updateProgress(progress);
                            
                            // Optional: Highlight current word in the story content
                            this.highlightCurrentWord(charIndex, charLength);
                        },
                        onPause: () => {
                            console.log('Narration paused');
                        },
                        onResume: () => {
                            console.log('Narration resumed');
                        }
                    });

                } catch (error) {
                    console.error('Error starting narration:', error);
                    alert('Failed to start narration. Please try again.');
                    this.stopNarration();
                }
            }

            pauseNarration() {
                if (window.aiVoiceService) {
                    window.aiVoiceService.pause();
                    this.isPaused = true;
                    
                    // Update UI
                    const playIcon = document.getElementById('playIcon');
                    const pauseIcon = document.getElementById('pauseIcon');
                    const playText = document.getElementById('playText');
                    
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    playText.textContent = 'Resume';
                }
            }

            resumeNarration() {
                if (window.aiVoiceService) {
                    window.aiVoiceService.resume();
                    this.isPaused = false;
                    
                    // Update UI
                    const playIcon = document.getElementById('playIcon');
                    const pauseIcon = document.getElementById('pauseIcon');
                    const playText = document.getElementById('playText');
                    
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playText.textContent = 'Pause';
                }
            }

            stopNarration() {
                if (window.aiVoiceService) {
                    window.aiVoiceService.stop();
                }
                
                this.isNarrating = false;
                this.isPaused = false;
                
                // Reset UI
                const playBtn = document.getElementById('playNarration');
                const stopBtn = document.getElementById('stopNarration');
                const playIcon = document.getElementById('playIcon');
                const pauseIcon = document.getElementById('pauseIcon');
                const playText = document.getElementById('playText');
                const progressDiv = document.getElementById('narrationProgress');
                const progressBar = document.getElementById('progressBar');
                
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playText.textContent = 'Read Aloud';
                stopBtn.classList.add('hidden');
                progressDiv.classList.add('hidden');
                progressBar.style.width = '0%';
                
                // Clear any word highlighting
                this.clearWordHighlighting();
            }

            updateProgress(percentage) {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = percentage + '%';
                }
            }

            highlightCurrentWord(charIndex, charLength) {
                // Optional: Add visual highlighting to the current word being spoken
                // This is a simplified version - in production, you'd want more sophisticated text tracking
                const storyContent = document.getElementById('storyContent');
                if (!storyContent) return;
                
                // Remove previous highlighting
                this.clearWordHighlighting();
                
                // This is a placeholder - actual implementation would require more complex text parsing
                // to accurately highlight words in the formatted HTML content
            }

            clearWordHighlighting() {
                // Clear any existing word highlighting
                const highlighted = document.querySelectorAll('.word-highlight');
                highlighted.forEach(el => {
                    el.classList.remove('word-highlight');
                });
            }
        }

        // Initialize story page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const storyPageManager = new StoryPageManager();
            window.storyPageManager = storyPageManager; // Make available globally for onclick handlers
            const feedbackManager = new FeedbackManager();
            const voiceController = new VoiceNarrationController(storyPageManager);
        });
    </script>
</body>
</html>