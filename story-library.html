<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Story Library - Kids Story Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B9D',
                        secondary: '#4ECDC4',
                        accent: '#FFE66D'
                    }
                }
            }
        }
    </script>
    <style>
        .story-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .story-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 20px;
            color: transparent;
            text-shadow: 0 0 0 #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .star.active {
            color: #FFD700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        .star:hover,
        .star.hover {
            color: #FFD700;
            text-shadow: 0 0 4px rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
        }

        .premium-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-200">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üìö</span>
                    </div>
                    <span class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        Kids Story Time
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="premium-badge">‚ú® Premium</span>
                    <a href="index.html" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                        Create New Story
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
                My Story Library
            </h1>
            <p class="text-xl text-gray-600 mb-6">
                All your magical stories in one place
            </p>
            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <button id="filterAll" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200 active">
                    All Stories
                </button>
                <button id="filterFavorites" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200">
                    ‚ù§Ô∏è Favorites
                </button>
                <button id="filterRated" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200">
                    ‚≠ê Rated
                </button>
                <button id="filterRecent" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200">
                    üïí Recent
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mb-6 flex items-center justify-center animate-pulse">
                <span class="text-white text-2xl">üìö</span>
            </div>
            <p class="text-xl text-gray-600">Loading your stories...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-20">
            <div class="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-6 flex items-center justify-center">
                <span class="text-gray-500 text-4xl">üìñ</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-700 mb-4">No stories yet!</h3>
            <p class="text-gray-600 mb-6">Start creating magical stories for your child.</p>
            <a href="index.html" class="inline-block bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                Create Your First Story ‚ú®
            </a>
        </div>

        <!-- Stories Grid -->
        <div id="storiesGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Story cards will be inserted here -->
        </div>

        <!-- Load More Button -->
        <div id="loadMoreSection" class="hidden text-center mt-12">
            <button id="loadMoreBtn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                Load More Stories
            </button>
        </div>
    </main>

    <!-- Story Rating Modal -->
    <div id="ratingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold text-center mb-6">Rate This Story</h3>
            <div class="text-center mb-6">
                <p class="text-gray-600 mb-4">How much did you enjoy this story?</p>
                <div class="star-rating justify-center mb-4" id="modalStarRating">
                    <span class="star" data-rating="1">‚≠ê</span>
                    <span class="star" data-rating="2">‚≠ê</span>
                    <span class="star" data-rating="3">‚≠ê</span>
                    <span class="star" data-rating="4">‚≠ê</span>
                    <span class="star" data-rating="5">‚≠ê</span>
                </div>
                <p id="ratingText" class="text-sm text-gray-500">Click a star to rate</p>
            </div>
            <div class="flex gap-4">
                <button id="cancelRating" class="flex-1 px-6 py-3 border border-gray-300 rounded-full hover:bg-gray-50 transition-all duration-200">
                    Cancel
                </button>
                <button id="submitRating" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 disabled:opacity-50" disabled>
                    Rate Story
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/database-manager.js"></script>
    <script src="js/subscription-manager.js"></script>

    <script>
        class StoryLibraryManager {
            constructor() {
                this.stories = [];
                this.filteredStories = [];
                this.currentFilter = 'all';
                this.offset = 0;
                this.limit = 12;
                this.currentRatingStoryId = null;
                this.selectedRating = 0;
                this.init();
            }

            async init() {
                // Check if user is logged in
                if (!window.authManager || !window.authManager.isUserAuthenticated()) {
                    // For testing purposes, allow anonymous access to premium features
                    console.log('Demo mode: Allowing access to story library for testing');
                    this.setupEventListeners();
                    await this.loadDemoStories();
                    return;
                }

                // Check if user has premium access (story history)
                const user = window.authManager.getCurrentUser();
                const hasPremium = await this.hasPremiumAccess(user);
                const limits = window.authManager.getUsageLimits(hasPremium ? 'premium' : 'free');
                
                if (!limits.storyHistory) {
                    // For testing, show upgrade modal but don't redirect immediately
                    console.log('Demo mode: Showing upgrade modal for story library');
                    if (window.subscriptionManager) {
                        window.subscriptionManager.showUpgradeModal('Story History');
                        // Allow 3 seconds to see the modal, then continue with demo
                        setTimeout(() => {
                            console.log('Demo mode: Continuing with story library demo');
                            this.setupEventListeners();
                            this.loadDemoStories();
                        }, 3000);
                    } else {
                        // Fallback demo
                        this.setupEventListeners();
                        this.loadDemoStories();
                    }
                    return;
                }

                this.setupEventListeners();
                await this.loadStories();
            }

            async hasPremiumAccess(user) {
                if (window.authManager) {
                    return await window.authManager.hasPremiumAccess();
                }
                return false;
            }

            setupEventListeners() {
                // Filter buttons
                document.getElementById('filterAll').addEventListener('click', () => this.setFilter('all'));
                document.getElementById('filterFavorites').addEventListener('click', () => this.setFilter('favorites'));
                document.getElementById('filterRated').addEventListener('click', () => this.setFilter('rated'));
                document.getElementById('filterRecent').addEventListener('click', () => this.setFilter('recent'));

                // Load more button
                document.getElementById('loadMoreBtn').addEventListener('click', () => this.loadMoreStories());

                // Rating modal
                document.getElementById('cancelRating').addEventListener('click', () => this.hideRatingModal());
                document.getElementById('submitRating').addEventListener('click', () => this.submitStoryRating());

                // Star rating in modal
                document.querySelectorAll('#modalStarRating .star').forEach(star => {
                    star.addEventListener('click', (e) => this.selectRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseenter', (e) => this.hoverRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseleave', () => this.unhoverRating());
                });
            }

            async loadStories() {
                try {
                    this.showLoadingState();
                    
                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.getUserStoryHistory(user.id, this.limit, this.offset);
                    
                    if (result.success) {
                        this.stories = result.data;
                        this.filterStories();
                        this.renderStories();
                        this.showStoriesGrid();
                    } else {
                        this.showEmptyState();
                    }
                } catch (error) {
                    console.error('Error loading stories:', error);
                    this.showEmptyState();
                }
            }

            async loadDemoStories() {
                this.showLoadingState();
                
                // Demo stories for testing
                this.stories = [
                    {
                        id: 'demo1',
                        title: 'The Magic Garden Adventure',
                        content: 'Once upon a time, in a magical garden where flowers could talk and butterflies sang beautiful songs, lived a little girl named Emma. One sunny morning, Emma discovered a hidden path behind the rose bushes that led to an enchanted world...',
                        genre: 'fantasy',
                        age_group: '4-6 years',
                        story_length: 'Short (5 min)',
                        created_at: new Date().toISOString(),
                        rating: 5,
                        is_favorite: true
                    },
                    {
                        id: 'demo2',
                        title: 'Captain Whiskers Space Mission',
                        content: 'Captain Whiskers, the bravest cat astronaut in the galaxy, was preparing for his most important mission yet. The moon had run out of cheese, and all the mice were very worried! With his trusty spaceship shaped like a giant ball of yarn...',
                        genre: 'space',
                        age_group: '5-7 years',
                        story_length: 'Medium (10 min)',
                        created_at: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                        rating: 4,
                        is_favorite: false
                    },
                    {
                        id: 'demo3',
                        title: 'The Friendly Dragon of Rainbow Valley',
                        content: 'In Rainbow Valley, where the most beautiful rainbows in the world were born, lived a gentle dragon named Sparkle. Unlike other dragons, Sparkle didnt breathe fire - she breathed rainbow bubbles that made everyone happy...',
                        genre: 'adventure',
                        age_group: '3-5 years',
                        story_length: 'Short (5 min)',
                        created_at: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
                        rating: null,
                        is_favorite: true
                    },
                    {
                        id: 'demo4',
                        title: 'The Little Lighthouse That Could',
                        content: 'On a rocky island far out at sea stood a little lighthouse named Beacon. Every night, Beacon would shine his bright light to guide ships safely to shore. But one stormy night, Beacons light began to flicker and dim...',
                        genre: 'ocean',
                        age_group: '4-7 years',
                        story_length: 'Medium (10 min)',
                        created_at: new Date(Date.now() - 259200000).toISOString(), // 3 days ago
                        rating: 3,
                        is_favorite: false
                    }
                ];
                
                this.filterStories();
                this.renderStories();
                this.showStoriesGrid();
            }

            setFilter(filter) {
                this.currentFilter = filter;
                
                // Update button states
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-primary', 'text-white');
                    btn.classList.add('text-primary');
                });
                
                const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'bg-primary', 'text-white');
                    activeBtn.classList.remove('text-primary');
                }
                
                this.filterStories();
                this.renderStories();
            }

            filterStories() {
                switch (this.currentFilter) {
                    case 'favorites':
                        this.filteredStories = this.stories.filter(story => story.is_favorite);
                        break;
                    case 'rated':
                        this.filteredStories = this.stories.filter(story => story.rating !== null);
                        break;
                    case 'recent':
                        this.filteredStories = this.stories.slice(0, 6); // Last 6 stories
                        break;
                    default:
                        this.filteredStories = [...this.stories];
                }
            }

            renderStories() {
                const grid = document.getElementById('storiesGrid');
                
                if (this.filteredStories.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                grid.innerHTML = this.filteredStories.map(story => this.createStoryCard(story)).join('');
                this.showStoriesGrid();
                
                // Add event listeners to story cards
                this.setupStoryCardListeners();
            }

            createStoryCard(story) {
                const createdDate = new Date(story.created_at).toLocaleDateString();
                const rating = story.rating;
                const ratingStars = rating ? '‚≠ê'.repeat(rating) : 'Not rated';
                
                return `
                    <div class="story-card bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-lg" data-story-id="${story.id}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${this.getThemeEmoji(story.genre)}</span>
                                <span class="px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-600">
                                    ${story.genre}
                                </span>
                            </div>
                            <button class="favorite-btn text-2xl ${story.is_favorite ? 'text-red-500' : 'text-gray-300'}" data-story-id="${story.id}">
                                ${story.is_favorite ? '‚ù§Ô∏è' : 'ü§ç'}
                            </button>
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-800 mb-3 line-clamp-2">
                            ${story.title}
                        </h3>
                        
                        <p class="text-gray-600 mb-4 line-clamp-3 leading-relaxed">
                            ${story.content.substring(0, 150)}...
                        </p>
                        
                        <div class="space-y-2 mb-4 text-sm text-gray-500">
                            <div class="flex justify-between">
                                <span>üìÖ ${createdDate}</span>
                                <span>üìö ${story.age_group}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‚è±Ô∏è ${story.story_length}</span>
                                <span class="${rating ? 'text-yellow-600' : ''}">${ratingStars}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="read-story-btn flex-1 bg-gradient-to-r from-primary to-secondary text-white py-2 px-4 rounded-full hover:shadow-lg transition-all duration-200 text-sm font-medium" data-story-id="${story.id}">
                                üìñ Read Story
                            </button>
                            ${!rating ? `<button class="rate-story-btn bg-yellow-500 text-white py-2 px-4 rounded-full hover:shadow-lg transition-all duration-200 text-sm font-medium" data-story-id="${story.id}">‚≠ê Rate</button>` : ''}
                        </div>
                    </div>
                `;
            }

            getThemeEmoji(theme) {
                const emojis = {
                    adventure: 'üè∞',
                    animals: 'ü¶Å',
                    space: 'üöÄ',
                    fantasy: 'üßö',
                    ocean: 'üåä',
                    friendship: 'ü§ù',
                    nature: 'üå≥',
                    superhero: 'ü¶∏',
                    funny: 'üòÑ',
                    unicorns: 'ü¶Ñ',
                    dinosaurs: 'ü¶ï',
                    princesses: 'üë∏',
                    cars: 'üöó',
                    sports: '‚öΩ',
                    music: 'üéµ',
                    art: 'üé®'
                };
                return emojis[theme] || 'üìö';
            }

            setupStoryCardListeners() {
                // Read story buttons
                document.querySelectorAll('.read-story-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.readStory(storyId);
                    });
                });

                // Rate story buttons
                document.querySelectorAll('.rate-story-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.showRatingModal(storyId);
                    });
                });

                // Favorite buttons
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.toggleFavorite(storyId);
                    });
                });
            }

            readStory(storyId) {
                const story = this.stories.find(s => s.id === storyId);
                if (story) {
                    if (storyId.startsWith('demo')) {
                        // For demo stories, show an alert instead of redirecting
                        alert(`üìñ Demo Story: "${story.title}"\n\n${story.content}\n\nThis is a demo of the story library premium feature. In the full version, you would be able to read and manage all your saved stories.`);
                    } else {
                        // Redirect to story page with story data
                        localStorage.setItem('readExistingStory', JSON.stringify(story));
                        window.location.href = 'story.html?existing=true';
                    }
                }
            }

            showRatingModal(storyId) {
                this.currentRatingStoryId = storyId;
                this.selectedRating = 0;
                this.updateRatingDisplay();
                document.getElementById('ratingModal').classList.remove('hidden');
            }

            hideRatingModal() {
                document.getElementById('ratingModal').classList.add('hidden');
                this.currentRatingStoryId = null;
                this.selectedRating = 0;
            }

            selectRating(rating) {
                this.selectedRating = rating;
                this.updateRatingDisplay();
                document.getElementById('submitRating').disabled = false;
            }

            hoverRating(rating) {
                const stars = document.querySelectorAll('#modalStarRating .star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }

            unhoverRating() {
                document.querySelectorAll('#modalStarRating .star').forEach(star => {
                    star.classList.remove('hover');
                });
            }

            updateRatingDisplay() {
                const stars = document.querySelectorAll('#modalStarRating .star');
                const ratingText = document.getElementById('ratingText');
                
                stars.forEach((star, index) => {
                    if (index < this.selectedRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });

                const ratingTexts = {
                    1: 'Poor - Didn\'t enjoy it',
                    2: 'Fair - It was okay',
                    3: 'Good - We liked it',
                    4: 'Great - We loved it!',
                    5: 'Excellent - Amazing story!'
                };

                ratingText.textContent = this.selectedRating > 0 ? ratingTexts[this.selectedRating] : 'Click a star to rate';
            }

            async submitStoryRating() {
                if (!this.currentRatingStoryId || this.selectedRating === 0) return;

                try {
                    if (this.currentRatingStoryId.startsWith('demo')) {
                        // For demo stories, just update locally
                        const story = this.stories.find(s => s.id === this.currentRatingStoryId);
                        if (story) {
                            story.rating = this.selectedRating;
                        }
                        
                        this.hideRatingModal();
                        this.renderStories(); // Re-render to show updated rating
                        
                        // Show success message
                        alert('Demo rating saved! In the full version, your ratings would be saved to your account.');
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.rateStory(this.currentRatingStoryId, this.selectedRating, user.id);
                    
                    if (result.success) {
                        // Update the story in our local array
                        const story = this.stories.find(s => s.id === this.currentRatingStoryId);
                        if (story) {
                            story.rating = this.selectedRating;
                        }
                        
                        this.hideRatingModal();
                        this.renderStories(); // Re-render to show updated rating
                        
                        // Show success message
                        alert('Thank you for rating this story!');
                    }
                } catch (error) {
                    console.error('Error rating story:', error);
                    alert('Error rating story. Please try again.');
                }
            }

            async toggleFavorite(storyId) {
                try {
                    if (storyId.startsWith('demo')) {
                        // For demo stories, just update locally
                        const story = this.stories.find(s => s.id === storyId);
                        if (story) {
                            story.is_favorite = !story.is_favorite;
                        }
                        
                        this.renderStories(); // Re-render to show updated favorite status
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.toggleStoryFavorite(storyId, user.id);
                    
                    if (result.success) {
                        // Update the story in our local array
                        const story = this.stories.find(s => s.id === storyId);
                        if (story) {
                            story.is_favorite = result.is_favorite;
                        }
                        
                        this.renderStories(); // Re-render to show updated favorite status
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                }
            }

            showLoadingState() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('storiesGrid').classList.add('hidden');
            }

            showEmptyState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('storiesGrid').classList.add('hidden');
            }

            showStoriesGrid() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('storiesGrid').classList.remove('hidden');
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new StoryLibraryManager();
        });
    </script>
</body>
</html>