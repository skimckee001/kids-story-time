<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Story Library - Kids Story Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B9D',
                        secondary: '#4ECDC4',
                        accent: '#FFE66D'
                    }
                }
            }
        }
    </script>
    <style>
        .story-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .story-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 20px;
            color: transparent;
            text-shadow: 0 0 0 #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .star.active {
            color: #FFD700;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        .star:hover,
        .star.hover {
            color: #FFD700;
            text-shadow: 0 0 4px rgba(255, 215, 0, 0.3);
            transform: scale(1.1);
        }

        /* Search and Filter Styles */
        #searchInput:focus {
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #FF6B9D 0%, #4ECDC4 100%);
            color: white;
            border-color: transparent;
        }

        #advancedFilters {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-card.filtered-out {
            display: none;
        }

        .highlight {
            background-color: #FFE66D;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .premium-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .upgrade-btn:hover .upgrade-tooltip {
            opacity: 1;
        }

        .upgrade-btn {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .upgrade-btn:hover {
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.3);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-pink-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-200">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-lg">üìö</span>
                    </div>
                    <span class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        KidsStoryTime<span style="font-size: 0.6em; font-weight: normal;">.org</span>
                    </span>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Star display will be inserted here by star-points-service.js -->
                    <div id="headerStarContainer" class="hidden">
                        <!-- Star display gets inserted here -->
                    </div>
                    <a href="index.html" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                        Create New Story
                    </a>
                    <button id="upgradeBtn" class="upgrade-btn bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-2 rounded-full hover:shadow-lg transition-all duration-200 font-medium border-2 border-green-400 hover:border-green-300 relative" title="Start your free trial">
                        üéâ Start Free Trial
                        <div id="upgradeTooltip" class="upgrade-tooltip absolute top-full left-1/2 transform -translate-x-1/2 mt-2 bg-gray-800 text-white text-sm rounded-lg px-3 py-2 opacity-0 pointer-events-none transition-opacity duration-200 whitespace-nowrap z-50">
                            Free for first month! All features unlocked
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Free Beta Banner -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-4">
        <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white text-center py-3 px-6 rounded-xl shadow-lg">
            <div class="font-bold text-lg">üéâ FREE BETA - All Premium Features Active!</div>
            <div class="text-sm mt-1 opacity-90">Unlimited story access, full library features, and exports - completely free during launch</div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
                My Story Library
            </h1>
            <p class="text-xl text-gray-600 mb-6">
                All your magical stories in one place
            </p>

            <!-- Search Bar -->
            <div class="max-w-2xl mx-auto mb-6">
                <div class="relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search stories by title, character name, or theme..." 
                        class="w-full px-6 py-3 pl-12 pr-4 text-lg border-2 border-gray-300 rounded-full focus:border-primary focus:outline-none transition-all duration-200"
                    >
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <button id="clearSearch" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Filter Options -->
            <div class="mb-6">
                <!-- Quick Filters -->
                <div class="flex flex-wrap justify-center gap-4 mb-4">
                    <button id="filterAll" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200 active">
                        All Stories
                    </button>
                    <button id="filterFavorites" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200">
                        ‚ù§Ô∏è Favorites
                    </button>
                    <button id="filterRated" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200">
                        ‚≠ê Rated
                    </button>
                    <button id="filterRecent" class="filter-btn px-6 py-2 rounded-full border-2 border-primary text-primary hover:bg-primary hover:text-white transition-all duration-200">
                        üïí Recent
                    </button>
                </div>

                <!-- Advanced Filters Toggle -->
                <button id="toggleAdvancedFilters" class="text-primary hover:text-secondary transition-colors duration-200">
                    <span class="inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                        </svg>
                        Advanced Filters
                        <svg id="filterToggleIcon" class="w-4 h-4 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </span>
                </button>

                <!-- Advanced Filters Panel -->
                <div id="advancedFilters" class="hidden mt-4 p-6 bg-gray-50 rounded-2xl">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Theme Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                            <select id="themeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                                <option value="">All Themes</option>
                                <option value="adventure">üèîÔ∏è Adventure</option>
                                <option value="friendship">ü§ù Friendship</option>
                                <option value="fantasy">ü¶Ñ Fantasy</option>
                                <option value="animals">üêæ Animals</option>
                                <option value="science">üî¨ Science</option>
                                <option value="space">üöÄ Space</option>
                                <option value="ocean">üåä Ocean</option>
                                <option value="dinosaurs">ü¶ï Dinosaurs</option>
                                <option value="funny">üòÑ Funny</option>
                                <option value="bedtime">üåô Bedtime</option>
                                <option value="educational">üìö Educational</option>
                                <option value="superhero">ü¶∏ Superhero</option>
                            </select>
                        </div>

                        <!-- Reading Level Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reading Level</label>
                            <select id="readingLevelFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                                <option value="">All Levels</option>
                                <option value="pre-reader">Pre-Reader (3-5)</option>
                                <option value="early-phonics">Early Phonics (4-6)</option>
                                <option value="beginning-reader">Beginning Reader (5-7)</option>
                                <option value="developing-reader">Developing Reader (6-9)</option>
                                <option value="fluent-reader">Fluent Reader (8-12)</option>
                                <option value="insightful-reader">Insightful Reader (10+)</option>
                            </select>
                        </div>

                        <!-- Sort By -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                            <select id="sortBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="rating-high">Highest Rated</option>
                                <option value="rating-low">Lowest Rated</option>
                            </select>
                        </div>
                    </div>

                    <!-- Date Range Filter -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                            <input type="date" id="dateFrom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                            <input type="date" id="dateTo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:outline-none">
                        </div>
                    </div>

                    <!-- Filter Actions -->
                    <div class="mt-4 flex justify-end gap-3">
                        <button id="clearFilters" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors duration-200">
                            Clear All
                        </button>
                        <button id="applyFilters" class="px-6 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-full hover:shadow-lg transition-all duration-200">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Counter -->
            <div id="resultsCounter" class="text-gray-600 text-sm">
                <!-- Will be updated by JavaScript -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-full mx-auto mb-6 flex items-center justify-center animate-pulse">
                <span class="text-white text-2xl">üìö</span>
            </div>
            <p class="text-xl text-gray-600">Loading your stories...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-20">
            <div class="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-6 flex items-center justify-center">
                <span class="text-gray-500 text-4xl">üìñ</span>
            </div>
            <h3 class="text-2xl font-bold text-gray-700 mb-4">No stories yet!</h3>
            <p class="text-gray-600 mb-6">Start creating magical stories for your child.</p>
            <a href="index.html" class="inline-block bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                Create Your First Story ‚ú®
            </a>
        </div>

        <!-- Stories Grid -->
        <div id="storiesGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Story cards will be inserted here -->
        </div>

        <!-- Load More Button -->
        <div id="loadMoreSection" class="hidden text-center mt-12">
            <button id="loadMoreBtn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full hover:shadow-lg transition-all duration-200 font-medium">
                Load More Stories
            </button>
        </div>
    </main>

    <!-- Story Rating Modal -->
    <div id="ratingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full">
            <h3 class="text-2xl font-bold text-center mb-6">Rate This Story</h3>
            <div class="text-center mb-6">
                <p class="text-gray-600 mb-4">How much did you enjoy this story?</p>
                <div class="star-rating justify-center mb-4" id="modalStarRating">
                    <span class="star" data-rating="1">‚≠ê</span>
                    <span class="star" data-rating="2">‚≠ê</span>
                    <span class="star" data-rating="3">‚≠ê</span>
                    <span class="star" data-rating="4">‚≠ê</span>
                    <span class="star" data-rating="5">‚≠ê</span>
                </div>
                <p id="ratingText" class="text-sm text-gray-500">Click a star to rate</p>
            </div>
            <div class="flex gap-4">
                <button id="cancelRating" class="flex-1 px-6 py-3 border border-gray-300 rounded-full hover:bg-gray-50 transition-all duration-200">
                    Cancel
                </button>
                <button id="submitRating" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-full hover:shadow-lg transition-all duration-200 disabled:opacity-50" disabled>
                    Rate Story
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/database-manager.js"></script>
    <script src="js/subscription-manager.js"></script>

    <script>
        class StoryLibraryManager {
            constructor() {
                this.stories = [];
                this.filteredStories = [];
                this.currentFilter = 'all';
                this.searchQuery = '';
                this.offset = 0;
                this.limit = 12;
                this.currentRatingStoryId = null;
                this.selectedRating = 0;
                this.init();
            }

            async init() {
                // Check if user is logged in
                if (!window.authManager || !window.authManager.isUserAuthenticated()) {
                    // For testing purposes, allow anonymous access to premium features
                    console.log('Demo mode: Allowing access to story library for testing');
                    this.setupEventListeners();
                    await this.loadDemoStories();
                    return;
                }

                // Check if user has premium access (story history)
                const user = window.authManager.getCurrentUser();
                const hasPremium = await this.hasPremiumAccess(user);
                const limits = window.authManager.getUsageLimits(hasPremium ? 'premium' : 'free');
                
                if (!limits.storyHistory) {
                    // For testing, show upgrade modal but don't redirect immediately
                    console.log('Demo mode: Showing upgrade modal for story library');
                    if (window.subscriptionManager) {
                        window.subscriptionManager.showUpgradeModal('Story History');
                        // Allow 3 seconds to see the modal, then continue with demo
                        setTimeout(() => {
                            console.log('Demo mode: Continuing with story library demo');
                            this.setupEventListeners();
                            this.loadDemoStories();
                        }, 3000);
                    } else {
                        // Fallback demo
                        this.setupEventListeners();
                        this.loadDemoStories();
                    }
                    return;
                }

                this.setupEventListeners();
                await this.loadStories();
            }

            async hasPremiumAccess(user) {
                if (window.authManager) {
                    return await window.authManager.hasPremiumAccess();
                }
                return false;
            }

            setupEventListeners() {
                // Filter buttons
                document.getElementById('filterAll').addEventListener('click', () => this.setFilter('all'));
                document.getElementById('filterFavorites').addEventListener('click', () => this.setFilter('favorites'));
                document.getElementById('filterRated').addEventListener('click', () => this.setFilter('rated'));
                document.getElementById('filterRecent').addEventListener('click', () => this.setFilter('recent'));

                // Search functionality
                const searchInput = document.getElementById('searchInput');
                const clearSearchBtn = document.getElementById('clearSearch');
                
                searchInput.addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    clearSearchBtn.classList.toggle('hidden', !this.searchQuery);
                    this.applyAllFilters();
                });

                clearSearchBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    this.searchQuery = '';
                    clearSearchBtn.classList.add('hidden');
                    this.applyAllFilters();
                });

                // Advanced Filters
                const toggleBtn = document.getElementById('toggleAdvancedFilters');
                const advancedPanel = document.getElementById('advancedFilters');
                const toggleIcon = document.getElementById('filterToggleIcon');
                
                toggleBtn.addEventListener('click', () => {
                    advancedPanel.classList.toggle('hidden');
                    toggleIcon.classList.toggle('rotate-180');
                });

                // Filter controls
                document.getElementById('themeFilter').addEventListener('change', () => this.applyAllFilters());
                document.getElementById('readingLevelFilter').addEventListener('change', () => this.applyAllFilters());
                document.getElementById('sortBy').addEventListener('change', () => this.applyAllFilters());
                document.getElementById('dateFrom').addEventListener('change', () => this.applyAllFilters());
                document.getElementById('dateTo').addEventListener('change', () => this.applyAllFilters());
                
                document.getElementById('applyFilters').addEventListener('click', () => this.applyAllFilters());
                document.getElementById('clearFilters').addEventListener('click', () => {
                    document.getElementById('themeFilter').value = '';
                    document.getElementById('readingLevelFilter').value = '';
                    document.getElementById('sortBy').value = 'newest';
                    document.getElementById('dateFrom').value = '';
                    document.getElementById('dateTo').value = '';
                    this.applyAllFilters();
                });

                // Load more button
                document.getElementById('loadMoreBtn').addEventListener('click', () => this.loadMoreStories());

                // Rating modal
                document.getElementById('cancelRating').addEventListener('click', () => this.hideRatingModal());
                document.getElementById('submitRating').addEventListener('click', () => this.submitStoryRating());

                // Star rating in modal
                document.querySelectorAll('#modalStarRating .star').forEach(star => {
                    star.addEventListener('click', (e) => this.selectRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseenter', (e) => this.hoverRating(parseInt(e.target.dataset.rating)));
                    star.addEventListener('mouseleave', () => this.unhoverRating());
                });
            }

            async loadStories() {
                try {
                    this.showLoadingState();
                    
                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.getUserStoryHistory(user.id, this.limit, this.offset);
                    
                    if (result.success) {
                        this.stories = result.data;
                        this.filterStories();
                        this.renderStories();
                        this.showStoriesGrid();
                    } else {
                        this.showEmptyState();
                    }
                } catch (error) {
                    console.error('Error loading stories:', error);
                    this.showEmptyState();
                }
            }

            async loadDemoStories() {
                this.showLoadingState();
                
                // Demo stories for testing
                this.stories = [
                    {
                        id: 'demo1',
                        title: 'The Magic Garden Adventure',
                        content: 'Once upon a time, in a magical garden where flowers could talk and butterflies sang beautiful songs, lived a little girl named Emma. One sunny morning, Emma discovered a hidden path behind the rose bushes that led to an enchanted world...',
                        genre: 'fantasy',
                        age_group: '4-6 years',
                        story_length: 'Short (5 min)',
                        created_at: new Date().toISOString(),
                        rating: 5,
                        is_favorite: true
                    },
                    {
                        id: 'demo2',
                        title: 'Captain Whiskers Space Mission',
                        content: 'Captain Whiskers, the bravest cat astronaut in the galaxy, was preparing for his most important mission yet. The moon had run out of cheese, and all the mice were very worried! With his trusty spaceship shaped like a giant ball of yarn...',
                        genre: 'space',
                        age_group: '5-7 years',
                        story_length: 'Medium (10 min)',
                        created_at: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                        rating: 4,
                        is_favorite: false
                    },
                    {
                        id: 'demo3',
                        title: 'The Friendly Dragon of Rainbow Valley',
                        content: 'In Rainbow Valley, where the most beautiful rainbows in the world were born, lived a gentle dragon named Sparkle. Unlike other dragons, Sparkle didnt breathe fire - she breathed rainbow bubbles that made everyone happy...',
                        genre: 'adventure',
                        age_group: '3-5 years',
                        story_length: 'Short (5 min)',
                        created_at: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
                        rating: null,
                        is_favorite: true
                    },
                    {
                        id: 'demo4',
                        title: 'The Little Lighthouse That Could',
                        content: 'On a rocky island far out at sea stood a little lighthouse named Beacon. Every night, Beacon would shine his bright light to guide ships safely to shore. But one stormy night, Beacons light began to flicker and dim...',
                        genre: 'ocean',
                        age_group: '4-7 years',
                        story_length: 'Medium (10 min)',
                        created_at: new Date(Date.now() - 259200000).toISOString(), // 3 days ago
                        rating: 3,
                        is_favorite: false
                    }
                ];
                
                this.filterStories();
                this.renderStories();
                this.showStoriesGrid();
            }

            setFilter(filter) {
                this.currentFilter = filter;
                
                // Update button states
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-primary', 'text-white');
                    btn.classList.add('text-primary');
                });
                
                const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'bg-primary', 'text-white');
                    activeBtn.classList.remove('text-primary');
                }
                
                this.filterStories();
                this.renderStories();
            }

            filterStories() {
                // Start with all stories
                let filtered = [...this.stories];

                // Apply quick filter
                switch (this.currentFilter) {
                    case 'favorites':
                        filtered = filtered.filter(story => story.is_favorite);
                        break;
                    case 'rated':
                        filtered = filtered.filter(story => story.rating !== null);
                        break;
                    case 'recent':
                        const oneWeekAgo = new Date();
                        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                        filtered = filtered.filter(story => new Date(story.created_at) >= oneWeekAgo);
                        break;
                }

                // Apply search query
                if (this.searchQuery) {
                    filtered = filtered.filter(story => {
                        const searchIn = [
                            story.title || '',
                            story.content || '',
                            story.genre || '',
                            story.theme || '',
                            story.childName || ''
                        ].join(' ').toLowerCase();
                        return searchIn.includes(this.searchQuery);
                    });
                }

                // Apply theme filter
                const themeFilter = document.getElementById('themeFilter').value;
                if (themeFilter) {
                    filtered = filtered.filter(story => 
                        (story.genre && story.genre.toLowerCase() === themeFilter) ||
                        (story.theme && story.theme.toLowerCase().includes(themeFilter))
                    );
                }

                // Apply reading level filter
                const readingLevelFilter = document.getElementById('readingLevelFilter').value;
                if (readingLevelFilter) {
                    filtered = filtered.filter(story => 
                        story.age_group && story.age_group.toLowerCase().includes(readingLevelFilter)
                    );
                }

                // Apply date range filter
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                if (dateFrom) {
                    filtered = filtered.filter(story => 
                        new Date(story.created_at) >= new Date(dateFrom)
                    );
                }
                if (dateTo) {
                    const endDate = new Date(dateTo);
                    endDate.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(story => 
                        new Date(story.created_at) <= endDate
                    );
                }

                // Apply sorting
                const sortBy = document.getElementById('sortBy').value;
                filtered = this.sortStories(filtered, sortBy);

                this.filteredStories = filtered;
                this.updateResultsCounter();
            }

            sortStories(stories, sortBy) {
                const sorted = [...stories];
                switch (sortBy) {
                    case 'oldest':
                        return sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    case 'title-asc':
                        return sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    case 'title-desc':
                        return sorted.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
                    case 'rating-high':
                        return sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    case 'rating-low':
                        return sorted.sort((a, b) => (a.rating || 0) - (b.rating || 0));
                    case 'newest':
                    default:
                        return sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                }
            }

            applyAllFilters() {
                this.filterStories();
                this.renderStories();
            }

            updateResultsCounter() {
                const counter = document.getElementById('resultsCounter');
                const total = this.stories.length;
                const filtered = this.filteredStories.length;
                
                if (this.searchQuery || this.currentFilter !== 'all' || this.hasAdvancedFilters()) {
                    counter.textContent = `Showing ${filtered} of ${total} stories`;
                } else {
                    counter.textContent = `${total} ${total === 1 ? 'story' : 'stories'}`;
                }
            }

            hasAdvancedFilters() {
                return document.getElementById('themeFilter').value ||
                       document.getElementById('readingLevelFilter').value ||
                       document.getElementById('dateFrom').value ||
                       document.getElementById('dateTo').value ||
                       document.getElementById('sortBy').value !== 'newest';
            }

            renderStories() {
                const grid = document.getElementById('storiesGrid');
                
                if (this.filteredStories.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                grid.innerHTML = this.filteredStories.map(story => this.createStoryCard(story)).join('');
                this.showStoriesGrid();
                
                // Add event listeners to story cards
                this.setupStoryCardListeners();
            }

            createStoryCard(story) {
                const createdDate = new Date(story.created_at).toLocaleDateString();
                const rating = story.rating;
                const ratingStars = rating ? '‚≠ê'.repeat(rating) : 'Not rated';
                
                // Add image section if image_url exists
                const imageSection = story.image_url ? `
                    <div class="mb-4 rounded-xl overflow-hidden">
                        <img src="${story.image_url}" alt="${story.title}" 
                             class="w-full h-48 object-cover"
                             onerror="this.style.display='none'">
                    </div>
                ` : '';
                
                return `
                    <div class="story-card bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-lg" data-story-id="${story.id}">
                        ${imageSection}
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${this.getThemeEmoji(story.genre)}</span>
                                <span class="px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-600">
                                    ${story.genre}
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="delete-story-btn text-lg text-gray-400 hover:text-red-500 transition-colors duration-200" data-story-id="${story.id}" title="Delete story">
                                    üóëÔ∏è
                                </button>
                                <button class="favorite-btn text-2xl ${story.is_favorite ? 'text-red-500' : 'text-gray-300'}" data-story-id="${story.id}">
                                    ${story.is_favorite ? '‚ù§Ô∏è' : 'ü§ç'}
                                </button>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold text-gray-800 mb-3 line-clamp-2">
                            ${story.title}
                        </h3>
                        
                        <p class="text-gray-600 mb-4 line-clamp-3 leading-relaxed">
                            ${story.content.substring(0, 150)}...
                        </p>
                        
                        <div class="space-y-2 mb-4 text-sm text-gray-500">
                            <div class="flex justify-between">
                                <span>üìÖ ${createdDate}</span>
                                <span>üìö ${story.age_group}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>‚è±Ô∏è ${story.story_length}</span>
                                <span class="${rating ? 'text-yellow-600' : ''}">${ratingStars}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="read-story-btn flex-1 bg-gradient-to-r from-primary to-secondary text-white py-2 px-4 rounded-full hover:shadow-lg transition-all duration-200 text-sm font-medium" data-story-id="${story.id}">
                                üìñ Read Story
                            </button>
                            ${!rating ? `<button class="rate-story-btn bg-yellow-500 text-white py-2 px-4 rounded-full hover:shadow-lg transition-all duration-200 text-sm font-medium" data-story-id="${story.id}">‚≠ê Rate</button>` : ''}
                        </div>
                    </div>
                `;
            }

            getThemeEmoji(theme) {
                const emojis = {
                    adventure: 'üè∞',
                    animals: 'ü¶Å',
                    space: 'üöÄ',
                    fantasy: 'üßö',
                    ocean: 'üåä',
                    friendship: 'ü§ù',
                    nature: 'üå≥',
                    superhero: 'ü¶∏',
                    funny: 'üòÑ',
                    unicorns: 'ü¶Ñ',
                    dinosaurs: 'ü¶ï',
                    princesses: 'üë∏',
                    cars: 'üöó',
                    sports: '‚öΩ',
                    music: 'üéµ',
                    art: 'üé®'
                };
                return emojis[theme] || 'üìö';
            }

            setupStoryCardListeners() {
                // Read story buttons
                document.querySelectorAll('.read-story-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.readStory(storyId);
                    });
                });

                // Rate story buttons
                document.querySelectorAll('.rate-story-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.showRatingModal(storyId);
                    });
                });

                // Favorite buttons
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.toggleFavorite(storyId);
                    });
                });

                // Delete buttons
                document.querySelectorAll('.delete-story-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const storyId = e.target.dataset.storyId;
                        this.showDeleteConfirmation(storyId);
                    });
                });
            }

            readStory(storyId) {
                const story = this.stories.find(s => s.id === storyId);
                if (story) {
                    if (storyId.startsWith('demo')) {
                        // For demo stories, show an alert instead of redirecting
                        alert(`üìñ Demo Story: "${story.title}"\n\n${story.content}\n\nThis is a demo of the story library premium feature. In the full version, you would be able to read and manage all your saved stories.`);
                    } else {
                        // Redirect to story page with story data
                        localStorage.setItem('readExistingStory', JSON.stringify(story));
                        window.location.href = 'story.html?existing=true';
                    }
                }
            }

            showRatingModal(storyId) {
                this.currentRatingStoryId = storyId;
                this.selectedRating = 0;
                this.updateRatingDisplay();
                document.getElementById('ratingModal').classList.remove('hidden');
            }

            hideRatingModal() {
                document.getElementById('ratingModal').classList.add('hidden');
                this.currentRatingStoryId = null;
                this.selectedRating = 0;
            }

            selectRating(rating) {
                this.selectedRating = rating;
                this.updateRatingDisplay();
                document.getElementById('submitRating').disabled = false;
            }

            hoverRating(rating) {
                const stars = document.querySelectorAll('#modalStarRating .star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.remove('hover');
                    }
                });
            }

            unhoverRating() {
                document.querySelectorAll('#modalStarRating .star').forEach(star => {
                    star.classList.remove('hover');
                });
            }

            updateRatingDisplay() {
                const stars = document.querySelectorAll('#modalStarRating .star');
                const ratingText = document.getElementById('ratingText');
                
                stars.forEach((star, index) => {
                    if (index < this.selectedRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });

                const ratingTexts = {
                    1: 'Poor - Didn\'t enjoy it',
                    2: 'Fair - It was okay',
                    3: 'Good - We liked it',
                    4: 'Great - We loved it!',
                    5: 'Excellent - Amazing story!'
                };

                ratingText.textContent = this.selectedRating > 0 ? ratingTexts[this.selectedRating] : 'Click a star to rate';
            }

            async submitStoryRating() {
                if (!this.currentRatingStoryId || this.selectedRating === 0) return;

                try {
                    if (this.currentRatingStoryId.startsWith('demo')) {
                        // For demo stories, just update locally
                        const story = this.stories.find(s => s.id === this.currentRatingStoryId);
                        if (story) {
                            story.rating = this.selectedRating;
                        }
                        
                        this.hideRatingModal();
                        this.renderStories(); // Re-render to show updated rating
                        
                        // Show success message
                        alert('Demo rating saved! In the full version, your ratings would be saved to your account.');
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.rateStory(this.currentRatingStoryId, this.selectedRating, user.id);
                    
                    if (result.success) {
                        // Update the story in our local array
                        const story = this.stories.find(s => s.id === this.currentRatingStoryId);
                        if (story) {
                            story.rating = this.selectedRating;
                        }
                        
                        this.hideRatingModal();
                        this.renderStories(); // Re-render to show updated rating
                        
                        // Show success message
                        alert('Thank you for rating this story!');
                    }
                } catch (error) {
                    console.error('Error rating story:', error);
                    alert('Error rating story. Please try again.');
                }
            }

            async toggleFavorite(storyId) {
                try {
                    if (storyId.startsWith('demo')) {
                        // For demo stories, just update locally
                        const story = this.stories.find(s => s.id === storyId);
                        if (story) {
                            story.is_favorite = !story.is_favorite;
                        }
                        
                        this.renderStories(); // Re-render to show updated favorite status
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.toggleStoryFavorite(storyId, user.id);
                    
                    if (result.success) {
                        // Update the story in our local array
                        const story = this.stories.find(s => s.id === storyId);
                        if (story) {
                            story.is_favorite = result.is_favorite;
                        }
                        
                        this.renderStories(); // Re-render to show updated favorite status
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                }
            }

            showLoadingState() {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('storiesGrid').classList.add('hidden');
            }

            showEmptyState() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('storiesGrid').classList.add('hidden');
            }

            showStoriesGrid() {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('storiesGrid').classList.remove('hidden');
            }

            showDeleteConfirmation(storyId) {
                const story = this.stories.find(s => s.id === storyId);
                if (!story) return;
                
                const confirmation = confirm(`Are you sure you want to delete "${story.title}"?\n\nThis action cannot be undone.`);
                
                if (confirmation) {
                    this.deleteStory(storyId);
                }
            }

            async deleteStory(storyId) {
                try {
                    if (storyId.startsWith('demo')) {
                        // For demo stories, just remove from local array
                        this.stories = this.stories.filter(s => s.id !== storyId);
                        this.filterStories();
                        this.renderStories();
                        
                        alert('Demo story deleted! In the full version, stories would be permanently removed from your account.');
                        return;
                    }

                    const user = window.authManager.getCurrentUser();
                    const result = await window.dbManager.deleteStory(storyId, user.id);
                    
                    if (result.success) {
                        // Remove the story from our local array
                        this.stories = this.stories.filter(s => s.id !== storyId);
                        this.filterStories();
                        this.renderStories();
                        
                        alert('Story deleted successfully!');
                    } else {
                        alert('Error deleting story. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting story:', error);
                    alert('Error deleting story. Please try again.');
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new StoryLibraryManager();
        });
    </script>
</body>
</html>